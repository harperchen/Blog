<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"harperchen.github.io","root":"/blog/","images":"/blog/images","scheme":"Gemini","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/blog/js/config.js"></script>

    <meta name="description" content="AbstractHybrid fuzzing, combining symbolic execution and fuzzing, is a promising approach for vulnerability discovery because each approach can complement the other. However, we observe that applying">
<meta property="og:type" content="article">
<meta property="og:title" content="[NDSS&#39;20] HFL: Hybrid Fuzzing on the Linux Kernel">
<meta property="og:url" content="https://harperchen.github.io/blog/2021/01/24/NDSS-20-HFL-Hybrid-Fuzzing-on-the-Linux-Kernel/index.html">
<meta property="og:site_name" content="Wei&#39;s Blog">
<meta property="og:description" content="AbstractHybrid fuzzing, combining symbolic execution and fuzzing, is a promising approach for vulnerability discovery because each approach can complement the other. However, we observe that applying">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2021/01/26/YUqptSdmC4TjFoE.png">
<meta property="og:image" content="https://i.loli.net/2021/01/26/7SPG5oewQX8pdsy.png">
<meta property="og:image" content="https://i.loli.net/2021/01/26/MtTgOQsUpL3wePW.png">
<meta property="og:image" content="https://i.loli.net/2021/01/27/4Hv2RrtBOhgj6MV.png">
<meta property="og:image" content="https://i.loli.net/2021/01/28/4N6LKfC7aOSPBk8.png">
<meta property="og:image" content="https://i.loli.net/2021/01/28/7WHrBdL6ZClKb42.png">
<meta property="og:image" content="https://i.loli.net/2021/01/28/bMXNVgZmiJDuETB.png">
<meta property="article:published_time" content="2021-01-24T06:02:50.000Z">
<meta property="article:modified_time" content="2024-03-27T05:21:36.070Z">
<meta property="article:author" content="Wei CHEN">
<meta property="article:tag" content="Fuzz Testing">
<meta property="article:tag" content="Kernel">
<meta property="article:tag" content="Hybrid Fuzzing">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/01/26/YUqptSdmC4TjFoE.png">


<link rel="canonical" href="https://harperchen.github.io/blog/2021/01/24/NDSS-20-HFL-Hybrid-Fuzzing-on-the-Linux-Kernel/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://harperchen.github.io/blog/2021/01/24/NDSS-20-HFL-Hybrid-Fuzzing-on-the-Linux-Kernel/","path":"2021/01/24/NDSS-20-HFL-Hybrid-Fuzzing-on-the-Linux-Kernel/","title":"[NDSS'20] HFL: Hybrid Fuzzing on the Linux Kernel"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>[NDSS'20] HFL: Hybrid Fuzzing on the Linux Kernel | Wei's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Wei's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Abstract"><span class="nav-number">1.</span> <span class="nav-text">Abstract</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Outline"><span class="nav-number">2.</span> <span class="nav-text">Outline</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Difficulties-of-performing-hybrid-fuzzing-on-kernel"><span class="nav-number">2.1.</span> <span class="nav-text">Difficulties of performing hybrid fuzzing on kernel</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Drawbacks-of-previous-work"><span class="nav-number">2.2.</span> <span class="nav-text">Drawbacks of previous work</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Why-this-paper-is-accepted"><span class="nav-number">2.3.</span> <span class="nav-text">Why this paper is accepted</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#How-it-works"><span class="nav-number">2.4.</span> <span class="nav-text">How it works</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Technique-details"><span class="nav-number">2.5.</span> <span class="nav-text">Technique details</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Evaluation"><span class="nav-number">2.6.</span> <span class="nav-text">Evaluation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Examples"><span class="nav-number">2.7.</span> <span class="nav-text">Examples</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Related-Work"><span class="nav-number">3.</span> <span class="nav-text">Related Work</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Reflection"><span class="nav-number">3.1.</span> <span class="nav-text">Reflection</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Wei CHEN"
      src="/blog/images/8.jpg">
  <p class="site-author-name" itemprop="name">Wei CHEN</p>
  <div class="site-description" itemprop="description">Be Brave; Be Confident; <br> Be Happy; Be Optimistic; </div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">59</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/blog/tags/">
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/harperchen" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;harperchen" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:harperchen1110@gmail.com" title="E-Mail → mailto:harperchen1110@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harperchen.github.io/blog/2021/01/24/NDSS-20-HFL-Hybrid-Fuzzing-on-the-Linux-Kernel/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/8.jpg">
      <meta itemprop="name" content="Wei CHEN">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wei's Blog">
      <meta itemprop="description" content="Be Brave; Be Confident; <br> Be Happy; Be Optimistic; ">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="[NDSS'20] HFL: Hybrid Fuzzing on the Linux Kernel | Wei's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [NDSS'20] HFL: Hybrid Fuzzing on the Linux Kernel
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-01-24 14:02:50" itemprop="dateCreated datePublished" datetime="2021-01-24T14:02:50+08:00">2021-01-24</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-27 13:21:36" itemprop="dateModified" datetime="2024-03-27T13:21:36+08:00">2024-03-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Papers/" itemprop="url" rel="index"><span itemprop="name">Papers</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h3 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h3><p>Hybrid fuzzing, combining symbolic execution and fuzzing, is a promising approach for vulnerability discovery because each approach can complement the other. However, we observe that applying hybrid fuzzing to kernel testing is challenging because the following unique characteristics of the kernel make a naive adoption of hybrid fuzzing inefficient: 1) having indirect control transfers determined by system call arguments, 2) controlling and matching internal system state via system calls, and 3) inferring nested argument type for invoking system calls. Failure to handling such challenges will render both fuzzing and symbolic execution inefficient, and thereby, will result in an inefficient hybrid fuzzing. Although these challenges are essential to both fuzzing and symbolic execution, to the best of our knowledge, existing kernel testing approaches either naively use each technique separately without handling such challenges or imprecisely handle a part of challenges only by static analysis.</p>
<span id="more"></span>

<p>To this end, this paper proposes HFL, which not only combines fuzzing with symbolic execution for hybrid fuzzing but also addresses kernel-specific fuzzing challenges via three distinct features: 1) converting indirect control transfers to direct transfers, 2) inferring system call sequence to build a consistent system state, and 3) identifying nested arguments types of system calls. As a result, HFL found 24 previously unknown vulnera- bilities in recent Linux kernels. Additionally, HFL achieves 15% and 26% higher code coverage than Moonshine and Syzkaller, respectively, and over kAFL&#x2F;S2E&#x2F;TriforceAFL, achieving even four times better coverage, using the same amount of resources (CPU, time, etc.). Regarding vulnerability discovery performance, HFL found 13 known vulnerabilities more than three times faster than Syzkaller.</p>
<h3 id="Outline"><a href="#Outline" class="headerlink" title="Outline"></a>Outline</h3><h4 id="Difficulties-of-performing-hybrid-fuzzing-on-kernel"><a href="#Difficulties-of-performing-hybrid-fuzzing-on-kernel" class="headerlink" title="Difficulties of performing hybrid fuzzing on kernel"></a>Difficulties of performing hybrid fuzzing on kernel</h4><p><strong>P1: Having indirect control transfers determined by system call arguments</strong>. Kernel prefers to use function pointer table to support polymorphism.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">size_t</span> (*ucma_table[])(<span class="keyword">struct</span> ucma_file *file,</span><br><span class="line">                       <span class="type">char</span> __user *inbuf, <span class="type">int</span> in_len, <span class="type">int</span> out_len) = &#123;</span><br><span class="line">    [RDMA_CREATE_ID] = ucma_create_id,</span><br><span class="line">    [RDMA_DESTROY_ID] = ucma_destroy_id,</span><br><span class="line">    [RDMA_BIND_IP] = ucma_bind_ip,</span><br><span class="line">    ...</span><br><span class="line">    [RDMA_JOIN_MCAST] = ucma_join_multicast</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">ssize_t</span> <span class="title">ucma_write</span><span class="params">(<span class="keyword">struct</span> file *filp, <span class="type">char</span> __user *buf,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="type">size_t</span> len, <span class="type">loff_t</span> *pos)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">rdma_ucm_cmd_hdr</span> hdr;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">copy_from_user</span>(&amp;hdr, buf, <span class="built_in">sizeof</span>(hdr)))</span><br><span class="line">     ...</span><br><span class="line">	<span class="comment">// indirect function invocation</span></span><br><span class="line">    ret = ucma_table[hdr.cmd](file, buf + <span class="built_in">sizeof</span>(hdr), hdr.in, hdr.out);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>P2: Controlling and matching internal system state via system calls</strong>. Correct system call execution order is necessary to touch the deep logic of syscall.</p>
<img src="https://i.loli.net/2021/01/26/YUqptSdmC4TjFoE.png" alt="image-20210126165218803" style="zoom:45%;" />

<p><strong>P3: Inferring nested argument type for invoking system calls</strong>. A field number in one structure points to another structure. </p>
<img src="https://i.loli.net/2021/01/26/7SPG5oewQX8pdsy.png" alt="image-20210126170342251" style="zoom:67%;" />

<h4 id="Drawbacks-of-previous-work"><a href="#Drawbacks-of-previous-work" class="headerlink" title="Drawbacks of previous work"></a>Drawbacks of previous work</h4><p>either naively use fuzzing&#x2F;symbolic execution separately by not handling such challenges</p>
<ul>
<li>Razzer: Fuzzing</li>
<li>Digtool</li>
<li>kAFL: Fuzzing</li>
<li>Periscope: Fuzzing</li>
<li>perf fuzzer</li>
<li>CAB-Fuzz: Hybrid Fuzzer without handling P1, P2, P3</li>
</ul>
<p>or  imprecisely handle a part of challenges only by static analysis </p>
<ul>
<li>Difuze (infer the structure of arguments of ioctl)<ul>
<li>Handle P3 but only perform static analysis </li>
<li>Cannot infer abstract pointer which is only avaiable at runtime</li>
</ul>
</li>
<li>IMF (analyze trace of macOS)<ul>
<li>Handle P2, without handling P1, P3</li>
</ul>
</li>
<li>Moonshine (analyze trace of linux)<ul>
<li>Handle P2, without handling P1, P3</li>
<li>Analyze explicit dependencies by performing static analysis on kernel</li>
<li><font color="#dd0000">HFL further perform symbolic checking to get precise constants between system state varibles</font></li>
</ul>
</li>
</ul>
<h4 id="Why-this-paper-is-accepted"><a href="#Why-this-paper-is-accepted" class="headerlink" title="Why this paper is accepted"></a>Why this paper is accepted</h4><p>Novelty: first kernel hybrid fuzzer</p>
<ul>
<li>First work to handle hybrid kernel fuzzing :open_mouth:</li>
</ul>
<p>Practical</p>
<ul>
<li>Apply Hybird fuzzing approach to test the linux kernel</li>
<li>Achieve significant coverage improvement</li>
<li>Uncover multiple previously unknown vulnerabilities</li>
</ul>
<h4 id="How-it-works"><a href="#How-it-works" class="headerlink" title="How it works"></a>How it works</h4><p>Kernel Fuzzing + Symbolic Execution</p>
<img src="https://i.loli.net/2021/01/26/MtTgOQsUpL3wePW.png" alt="image-20210126191910353" style="zoom: 50%;" />

<p><strong>IV-B:</strong> converting indirect control transfers to direct transfers at compile time <font color="#dd0000">for symbolic analyze</font></p>
<ul>
<li>resolve function pointer, unfold indirect transfer to direct one offline :+1:</li>
<li>only interest in those index variable originates from syscall parameters by data flow analysis</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// before translation</span></span><br><span class="line">ret = ucma_table[hdr.cmd](...);</span><br><span class="line"></span><br><span class="line"><span class="comment">// after translation</span></span><br><span class="line"><span class="keyword">if</span> (hdr.cmd == RDMA_CREATE_ID)</span><br><span class="line">    ret = <span class="built_in">ucma_create_id</span> (...);</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (hdr.cmd == RDMA_DESTROY_ID)</span><br><span class="line">    ret = <span class="built_in">ucma_destroy_id</span> (...);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p><strong>IV-C</strong>: inferring system call sequence to build a consistent system state</p>
<ul>
<li>Step 1: point-to analysis to capture candidate read&#x2F;write dependency pairs (<font color="#dd0000">offline</font>) (<font color="blue">the same as the static analysis step of Razzer</font>)</li>
<li>Step 2: runtime validation to identify true dependencies (<font color="dd0000">infer execution order</font>)<ul>
<li>check if they access the same address during symbolically execution</li>
<li>distinguish true dependency pairs &amp; write must before read</li>
</ul>
</li>
<li>Step 3: detect parameter dependencies (<font color="dd0000">infer parameter dependencies</font>)</li>
</ul>
<p><strong>IV-D</strong>: identifying nested arguments types of system calls at runtime</p>
<ul>
<li>monitor invocation of copy_from_user </li>
<li>using symbolic state to track offset and length of nested data structure</li>
<li>not the same as S&amp;P’20: EASIER :sweat_smile:</li>
</ul>
<h4 id="Technique-details"><a href="#Technique-details" class="headerlink" title="Technique details"></a>Technique details</h4><p><strong>IV-A:</strong> Fuzzing: Syzkaller</p>
<ul>
<li>:sparkles: Fully automated kernel-specific features instead of using manually written template of Syzkaller</li>
</ul>
<p><strong>IV-C &amp; IV-D:</strong> Symbolic Execution: S2E</p>
<ul>
<li><p>All syscall parameters is symbolized <code>s2e_make_symbolic</code></p>
</li>
<li><p>:sparkles: Identify always-false or always-true branch as hard branch by maintaining a frequency table</p>
</li>
<li><p>Pass user program that executes hard branch to symbolic analyzer</p>
</li>
<li><p>Symbolize all syscall parameters and perform concolic execution to reach another branch</p>
</li>
</ul>
<p><strong>IV-B:</strong> Unfold indirect control flow (Kernel translator)</p>
<ul>
<li>GIMPLE representation in gcc</li>
</ul>
<p><strong>IV-C:</strong> Infer syscall order and syscall paramter dependency</p>
<ul>
<li>Static analysis: SVF using <a target="_blank" rel="noopener" href="https://wiki.linuxfoundation.org/llvmlinux">LLVM Linux</a></li>
</ul>
<p>Code <a target="_blank" rel="noopener" href="https://bitbucket.org/anonyk/hfl-release/src/master/">https://bitbucket.org/anonyk/hfl-release/src/master/</a></p>
<img src="https://i.loli.net/2021/01/27/4Hv2RrtBOhgj6MV.png" alt="image-20210127144429015" style="zoom:67%;" />

<h4 id="Evaluation"><a href="#Evaluation" class="headerlink" title="Evaluation"></a>Evaluation</h4><img src="https://i.loli.net/2021/01/28/4N6LKfC7aOSPBk8.png" alt="image-20210128154525938" style="zoom: 67%;" />

<ul>
<li><p>24 previously unknown vulnerabilities in recent Linux kernels</p>
</li>
<li><p>HFL achieves 15% and 26% higher code coverage than Moonshine and Syzkaller</p>
<p><img src="https://i.loli.net/2021/01/28/7WHrBdL6ZClKb42.png" alt="image-20210128153114085"></p>
</li>
<li><p>HFL measures the upper bound number of coverage for kernel</p>
</li>
</ul>
<img src="https://i.loli.net/2021/01/28/bMXNVgZmiJDuETB.png" alt="image-20210128151958587" style="zoom:80%;" />

<ul>
<li>HFL found 13 known vulnerabilities more than three times faster than Syzkaller</li>
<li>Contribution of each feature in HFL by comparing with Syzkaller</li>
</ul>
<h4 id="Examples"><a href="#Examples" class="headerlink" title="Examples"></a>Examples</h4><p>Three example to overcome proposed difficulties</p>
<p><strong>Difficult 1:</strong> Indirect control flow in RDS network</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="keyword">define</span> RDS_INFO_FIRST 10000</span></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*rds_info_func)</span><span class="params">(<span class="keyword">struct</span> socket *sock, <span class="type">int</span> len,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="keyword">struct</span> rds_info_iterator *iter, <span class="keyword">struct</span> rds_info_lengths *lens)</span></span>;</span><br><span class="line"></span><br><span class="line">rds_info_func rds_info_funcs[RDS_INFO_LAST - RDS_INFO_FIRST +<span class="number">1</span>];</span><br><span class="line"><span class="comment">// An indirect control-flow in RDS network</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">rds_info_getsockopt</span><span class="params">(<span class="keyword">struct</span> socket *sock, <span class="type">int</span> optname,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">char</span> __user *optval, <span class="type">int</span> __user *optlen)</span> </span>&#123;</span><br><span class="line">    func = rds_info_funcs[optname - RDS_INFO_FIRST];</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">func</span>(sock, len, &amp;iter, &amp;lens);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Difficult 2</strong>: calling dependency across PPP ioctl</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">long</span> <span class="title">ppp_ioctl</span><span class="params">(<span class="keyword">struct</span> file *file, <span class="type">int</span> cmd, <span class="type">long</span> arg)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">        <span class="comment">// 1. write dependency</span></span><br><span class="line">        <span class="comment">// [syscall]: ioctl(fd, PPPIOCNEWUNIT, &#123;VAL&#125;&lt;-unit)</span></span><br><span class="line">        <span class="comment">// [NOTE]: VAL is written to untyped syscall argument</span></span><br><span class="line">        <span class="keyword">case</span> PPPNEWUNIT:</span><br><span class="line">            <span class="comment">// allocate an VAL to unit</span></span><br><span class="line">            err = <span class="built_in">ppp_create_interface</span>(net, file, &amp;unit); </span><br><span class="line">            <span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// write the VAL toward userspace </span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">put_user</span>(unit, arg))</span><br><span class="line">                <span class="keyword">break</span>; </span><br><span class="line">            ...</span><br><span class="line">        <span class="comment">// 2. read dependency</span></span><br><span class="line">        <span class="comment">// [syscall]: ioctl(fd, PPPIOCCONNECT, &#123;VAL&#125;-&gt;unit) </span></span><br><span class="line">        <span class="comment">// [NOTE]: VAL is read from untyped syscall argument</span></span><br><span class="line">        <span class="keyword">case</span> PPPCONNECT:</span><br><span class="line">            <span class="comment">// read VAL from userspace</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">get_user</span>(unit, arg))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            ppp = <span class="built_in">ppp_find_unit</span>(pn, unit); <span class="comment">// check the VAL for dependency</span></span><br><span class="line">            <span class="comment">// [FAIL]: return if (untyped) value dependency is violated</span></span><br><span class="line">            <span class="keyword">if</span> (!ppp)</span><br><span class="line">                <span class="keyword">goto</span> out;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/* main connection procedure */</span></span><br><span class="line">            ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Difficult 3</strong>: Nested argument in PPP driver</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">ppp_option_data</span> &#123;</span><br><span class="line">    __u8 __user *ptr; <span class="comment">// unknown typed inner buffer __u32 len;</span></span><br><span class="line">    <span class="type">int</span> transmit;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">ppp_set_compress</span><span class="params">(<span class="keyword">struct</span> ppp *ppp, <span class="type">unsigned</span> <span class="type">long</span> arg)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">ppp_option_data</span> data;</span><br><span class="line">    <span class="comment">// inferred buffer layout: &#123;..|..|..&#125;</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">copy_from_user</span>(&amp;data, (<span class="type">void</span> __user *)arg, <span class="built_in">sizeof</span>(data))) <span class="keyword">goto</span> out;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// inferred buffer layout: &#123;..|..|ptr&#125; --&gt; &#123;...&#125;</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">copy_from_user</span>(ccp_opt, (<span class="type">void</span> __user *)data.ptr, data.len)) <span class="keyword">goto</span> out;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Related-Work"><a href="#Related-Work" class="headerlink" title="Related Work"></a>Related Work</h3><table>
<thead>
<tr>
<th align="center">Kernel Testing</th>
<th align="center">Kernel</th>
<th align="center">Target</th>
<th align="center">Coverage guided</th>
<th align="center">Call Sequence Inference</th>
<th align="center">Nested Syscall  Argument</th>
<th align="center">Indirect Control Flow</th>
<th align="center">Handle Branch Condition</th>
<th align="center">Remark</th>
</tr>
</thead>
<tbody><tr>
<td align="center">perf_fuzzer</td>
<td align="center">Linux</td>
<td align="center"><font color="#dd0000">perf_event set</font></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">Digtool</td>
<td align="center">Win</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">kAFL</td>
<td align="center">Win &amp; Linux &amp; MacOS</td>
<td align="center"><font color="#dd0000"> file system &amp; single syscall</font></td>
<td align="center">:star:</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">Fuzzer</td>
</tr>
<tr>
<td align="center">Razzer</td>
<td align="center">Linux</td>
<td align="center"><font color="#dd0000">syscall traces</font></td>
<td align="center">:star:</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">Race Bug</td>
</tr>
<tr>
<td align="center">PeriScope</td>
<td align="center">Linux</td>
<td align="center"><font color="#dd0000">device drivers</font></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">FIRM-AFL</td>
<td align="center">Firmware</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">CAB-Fuzz</td>
<td align="center">Wind</td>
<td align="center"><font color="#dd0000">device drivers</font></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">:star:</td>
<td align="center">Hybrid</td>
</tr>
<tr>
<td align="center">IMF</td>
<td align="center">Linux</td>
<td align="center"><font color="#dd0000">syscall traces</font></td>
<td align="center"></td>
<td align="center">:star:</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">Fuzzer</td>
</tr>
<tr>
<td align="center">Syzkaller</td>
<td align="center">Linux</td>
<td align="center"><font color="#dd0000">syscall traces</font></td>
<td align="center">:star:</td>
<td align="center">:star:</td>
<td align="center">:star:</td>
<td align="center"></td>
<td align="center"></td>
<td align="center">Fuzzer</td>
</tr>
<tr>
<td align="center">Moonshine</td>
<td align="center">MacOS</td>
<td align="center"><font color="#dd0000">syscall traces</font></td>
<td align="center">:star:</td>
<td align="center">:star:</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">Fuzzer</td>
</tr>
<tr>
<td align="center">DIFUZE</td>
<td align="center">Linux (Android)</td>
<td align="center"><font color="#dd0000">device drivers</font></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">:star:</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">JANUS</td>
<td align="center">Linux</td>
<td align="center"><font color="#dd0000">file system</font></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">Fuzzer</td>
</tr>
<tr>
<td align="center">Krace</td>
<td align="center">Linux</td>
<td align="center"><font color="#dd0000">file system</font></td>
<td align="center">:star:</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center">Race Bug</td>
</tr>
<tr>
<td align="center">HFL</td>
<td align="center">Linux</td>
<td align="center"><font color="#dd0000">syscall traces</font></td>
<td align="center">:star:</td>
<td align="center">:star:</td>
<td align="center">:star:</td>
<td align="center">:star:</td>
<td align="center">:star:</td>
<td align="center">Hybrid</td>
</tr>
<tr>
<td align="center">Kminer</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center">Dr. checker</td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
<td align="center"></td>
</tr>
</tbody></table>
<h4 id="Reflection"><a href="#Reflection" class="headerlink" title="Reflection"></a>Reflection</h4><ul>
<li>HFL虽然也进行了static point-to analysis，但HFL在runtime时利用符号执行验证识别true dependency，来修正false positive。</li>
<li>kernel的子系统分开坐可能会降低难度</li>
</ul>
<table>
<thead>
<tr>
<th align="center">Category</th>
<th align="center">Analysis Target</th>
<th align="center">Size (.bc)</th>
<th align="center">Syscalls used</th>
</tr>
</thead>
<tbody><tr>
<td align="center">File System</td>
<td align="center">fs&#x2F;</td>
<td align="center">75 MB</td>
<td align="center">open, read, ioctl, write, lseek</td>
</tr>
<tr>
<td align="center">Network</td>
<td align="center">net&#x2F;</td>
<td align="center">255 MB</td>
<td align="center">socket, accept, bind, listen, ioctl, getsocket, setsocket, <br />sendto, recvfrom, sendmsg, recvmsg</td>
</tr>
<tr>
<td align="center">Drivers</td>
<td align="center">drivers&#x2F;</td>
<td align="center">322 MB</td>
<td align="center">open, ioctl, write, read</td>
</tr>
</tbody></table>
<ul>
<li>其实implicit dependencies的话，不是函数A在函数B前面就可以，他们的参数可能还有依赖关系，可能两个field字端要保持一致，也就是说，参数间的依赖关系，不止存在于explict dependencies例如open和read这种关系，还存在于如下这种情况。</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ioctl</span>(fd, DRM_ALLOC, &#123;*_1&#125;);</span><br><span class="line"><span class="built_in">ioctl</span>(fd, DRM_BIND, &#123;*_2&#125;);</span><br><span class="line"><span class="comment">// two ioctl have implicit dependency not only on execution order, but also paramter</span></span><br><span class="line"><span class="comment">// _1.ID = _2.ID is required</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_1</span> &#123;</span><br><span class="line">    u64 x;</span><br><span class="line">    u32 ID;</span><br><span class="line">    u64 y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">_2</span> &#123;</span><br><span class="line">    u32 ID;</span><br><span class="line">    u64 x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/blog/tags/Fuzz-Testing/" rel="tag"># Fuzz Testing</a>
              <a href="/blog/tags/Kernel/" rel="tag"># Kernel</a>
              <a href="/blog/tags/Hybrid-Fuzzing/" rel="tag"># Hybrid Fuzzing</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/blog/2021/01/13/Metamorphic-Testing/" rel="prev" title="Metamorphic Testing">
                  <i class="fa fa-angle-left"></i> Metamorphic Testing
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/blog/2021/01/30/USENIX-18-MoonShine-Optimizing-OS-Fuzzer-Seed-Selection-with-Trace-Distillation/" rel="next" title="[USENIX'18] MoonShine: Optimizing OS Fuzzer Seed Selection with Trace Distillation">
                  [USENIX'18] MoonShine: Optimizing OS Fuzzer Seed Selection with Trace Distillation <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Wei CHEN</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/blog/js/comments.js"></script><script src="/blog/js/utils.js"></script><script src="/blog/js/motion.js"></script><script src="/blog/js/next-boot.js"></script>

  






  





</body>
</html>
