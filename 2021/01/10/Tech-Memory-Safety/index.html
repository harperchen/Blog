<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"harperchen.github.io","root":"/blog/","images":"/blog/images","scheme":"Gemini","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/blog/js/config.js"></script>

    <meta name="description" content="1. ASAN https:&#x2F;&#x2F;juejin.cn&#x2F;post&#x2F;6844904111570157575 https:&#x2F;&#x2F;www.ndss-symposium.org&#x2F;wp-content&#x2F;uploads&#x2F;2018&#x2F;02&#x2F;ndss2018_05A-5_Han_paper.pdf https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;3a2df9b7c353">
<meta property="og:type" content="article">
<meta property="og:title" content="Memory Safety">
<meta property="og:url" content="https://harperchen.github.io/blog/2021/01/10/Tech-Memory-Safety/index.html">
<meta property="og:site_name" content="Wei&#39;s Blog">
<meta property="og:description" content="1. ASAN https:&#x2F;&#x2F;juejin.cn&#x2F;post&#x2F;6844904111570157575 https:&#x2F;&#x2F;www.ndss-symposium.org&#x2F;wp-content&#x2F;uploads&#x2F;2018&#x2F;02&#x2F;ndss2018_05A-5_Han_paper.pdf https:&#x2F;&#x2F;www.jianshu.com&#x2F;p&#x2F;3a2df9b7c353">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2021/01/10/zgxjUHub6L5v2Mc.png">
<meta property="og:image" content="https://i.loli.net/2021/01/10/ezUOlgtBJKV6L9i.png">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/3/31/1713137c20d75aab?imageView2/0/w/1280/h/960/format/webp/ignore-error/1">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/3/31/1713138a2f5cb553?imageView2/0/w/1280/h/960/format/webp/ignore-error/1">
<meta property="og:image" content="https://user-gold-cdn.xitu.io/2020/3/31/1713138d91688f78?imageView2/0/w/1280/h/960/format/webp/ignore-error/1">
<meta property="article:published_time" content="2021-01-10T09:10:01.000Z">
<meta property="article:modified_time" content="2024-03-27T05:21:36.068Z">
<meta property="article:author" content="Wei CHEN">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/01/10/zgxjUHub6L5v2Mc.png">


<link rel="canonical" href="https://harperchen.github.io/blog/2021/01/10/Tech-Memory-Safety/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://harperchen.github.io/blog/2021/01/10/Tech-Memory-Safety/","path":"2021/01/10/Tech-Memory-Safety/","title":"Memory Safety"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Memory Safety | Wei's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Wei's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#asan"><span class="nav-number">1.</span> <span class="nav-text">1. ASAN</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#asan%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="nav-number">1.1.</span> <span class="nav-text">1. ASan工作原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#shadow-memory"><span class="nav-number">1.2.</span> <span class="nav-text">2. Shadow Memory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#asan-%E6%A3%80%E9%AA%8C%E7%AE%97%E6%B3%95"><span class="nav-number">1.3.</span> <span class="nav-text">3. ASan 检验算法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#asan%E4%BB%A3%E7%A0%81%E8%A7%A3%E9%87%8A"><span class="nav-number">1.4.</span> <span class="nav-text">4. ASAN代码解释</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%AE%9E%E7%8E%B0"><span class="nav-number">1.5.</span> <span class="nav-text">5. 代码实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%BC%BA%E9%99%B7"><span class="nav-number">1.6.</span> <span class="nav-text">6. 缺陷</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hwasan"><span class="nav-number">2.</span> <span class="nav-text">HWASAN</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFhwasan"><span class="nav-number">2.1.</span> <span class="nav-text">1. 什么是HWASAN</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%A3%80%E6%B5%8Buseafterfree"><span class="nav-number">2.2.</span> <span class="nav-text">2. 检测UseAfterFree</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#use-after-free"><span class="nav-number">2.2.1.</span> <span class="nav-text">2.1 Use-After-Free</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#heap-over-flow"><span class="nav-number">2.2.2.</span> <span class="nav-text">2.2 Heap-Over-Flow</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E4%BC%98%E7%BC%BA%E7%82%B9"><span class="nav-number">2.2.3.</span> <span class="nav-text">2.3 优缺点</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mte"><span class="nav-number">2.3.</span> <span class="nav-text">3. MTE</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#reference"><span class="nav-number">2.4.</span> <span class="nav-text">Reference</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Wei CHEN"
      src="/blog/images/8.jpg">
  <p class="site-author-name" itemprop="name">Wei CHEN</p>
  <div class="site-description" itemprop="description">Be Brave; Be Confident; <br> Be Happy; Be Optimistic; </div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">60</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/blog/tags/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/harperchen" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;harperchen" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:harperchen1110@gmail.com" title="E-Mail → mailto:harperchen1110@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harperchen.github.io/blog/2021/01/10/Tech-Memory-Safety/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/8.jpg">
      <meta itemprop="name" content="Wei CHEN">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wei's Blog">
      <meta itemprop="description" content="Be Brave; Be Confident; <br> Be Happy; Be Optimistic; ">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Memory Safety | Wei's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Memory Safety
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-01-10 17:10:01" itemprop="dateCreated datePublished" datetime="2021-01-10T17:10:01+08:00">2021-01-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-27 13:21:36" itemprop="dateModified" datetime="2024-03-27T13:21:36+08:00">2024-03-27</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h3 id="asan">1. ASAN</h3>
<p>https://juejin.cn/post/6844904111570157575</p>
<p>https://www.ndss-symposium.org/wp-content/uploads/2018/02/ndss2018_05A-5_Han_paper.pdf</p>
<p>https://www.jianshu.com/p/3a2df9b7c353</p>
<span id="more"></span>
<p>Given the following C++ program <code>test.cpp</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span>* a = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">10</span>];</span><br><span class="line">    a[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (a[argc])</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;xx\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure>
<img src="https://i.loli.net/2021/01/10/zgxjUHub6L5v2Mc.png"
alt="image-20210110202244680" />
<figcaption aria-hidden="true">image-20210110202244680</figcaption>
</figure>
<h4 id="asan工作原理">1. ASan工作原理</h4>
<p>https://github.com/google/sanitizers/wiki/AddressSanitizerAlgorithm</p>
<p>ASAN工具包含两大块：</p>
<ul>
<li>插桩模块(Instrumentation module)</li>
<li>一个运行时库(Runtime library)</li>
</ul>
<p>插桩模块主要会做两件事：（静态插桩，需重新编译）</p>
<ol type="1">
<li>为每个程序中用到的内存地址都开辟shadow
memory来存储内存的相应状态</li>
<li>对所有的memory access都去检查该内存所对应的shadow memory的状态</li>
<li>开辟shadow memory的shadow memory为bad region</li>
<li>为所有栈上对象和全局对象创建前后的保护区(Poisoned
redzone)，为检测溢出做准备。</li>
</ol>
<p>运行时库也同样会做两件事：</p>
<ol type="1">
<li>hook malloc函数，为所有堆对象创建前后的保护区</li>
<li>hook
free函数，将free掉的堆区域隔离(quarantine)一段时间，避免它立即被分配给其他人使用</li>
<li>对错误情况进行输出，包括堆栈信息</li>
</ol>
<h4 id="shadow-memory">2. Shadow Memory</h4>
<p>Shadow
memory是内存中的一块区域，其中的数据仅仅反应其他正常内存的状态信息，可以理解为正常内存的元数据，而正常内存中存储的才是程序真正需要的数据。</p>
<p>Malloc函数返回的地址通常是8字节对齐的，因此任意一个由（对齐的）8字节所组成的内存区域必然落在以下9种状态之中：最前面的k（0≤k≤8）字节是可寻址的，而剩下的8-k字节是不可寻址的。这9种状态便可以用shadow
memory中的一个字节来进行编码。</p>
<p>实际上，一个byte可以编码的状态总共有256（2^8）种，因此用在这里绰绰有余。</p>
<p><img src="https://i.loli.net/2021/01/10/ezUOlgtBJKV6L9i.png" alt="image-20210110165523758" style="zoom: 50%;" /></p>
<p>Shadow memory和normal memory的映射关系如上图所示。一个byte的shadow
memory反映8个byte normal memory的状态。如何根据normal
memory的地址找到它对应的shadow memory呢？</p>
<p>对于64位机器上的Android而言，二者的转换公式如下：</p>
<p>Shadow memory address = (Normal memory address &gt;&gt; 3) +
0x7fff8000 (for 64 bit)</p>
<p>Shadow memory address = (Normal memory address &gt;&gt; 3) +
0x20000000 (for 32 bit)</p>
<p>右移三位的目的是为了完成8=&gt;1的映射，而加一个offset是为了和Normal
memory区分开来。最终内存空间种会存在如下的映射关系：</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/3/31/1713137c20d75aab?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" style="zoom: 50%;" /></p>
<p>Bad代表的是shadow memory的shadow
memory，因此其中数据没有意义，该内存区域不可使用。shadown内存的值有以下几种：</p>
<ul>
<li>8个字节都可寻址，shadow memory的值为0</li>
<li>负数:所有byte都无效，全无效一般都是插入的内存，并且每种插入的内存对应的负数值不同</li>
<li>k：表示前k个byte是有效，后8-k个无效，前提：malloc返回的地址内存对齐</li>
</ul>
<p>为什么0个字节可寻址的情况shadow
memory不为0，而是负数呢？是因为0个字节可寻址其实可以继续分为多种情况，譬如：</p>
<ul>
<li>这块区域是heap redzones</li>
<li>这块区域是stack redzones</li>
<li>这块区域是global redzones</li>
<li>这块区域是freed memory</li>
</ul>
<p>对所有0个字节可寻址的normal memory
region的访问都是非法的，ASAN将会报错。而根据其shadow
memory的值便可以具体判断是哪一种错。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Shadow byte legend (one shadow byte represents 8 application bytes):</span><br><span class="line">  Addressable:           00</span><br><span class="line">  Partially addressable: 01 02 03 04 05 06 07 </span><br><span class="line">  Heap left redzone:     fa (实际上Heap right redzone也是fa)</span><br><span class="line">  Freed Heap region:     fd  <span class="comment"># use-after-free</span></span><br><span class="line">  Stack left redzone:    f1</span><br><span class="line">  Stack mid redzone:     f2</span><br><span class="line">  Stack right redzone:   f3</span><br><span class="line">  Stack after <span class="built_in">return</span>:    f5</span><br><span class="line">  Stack use after scope: f8</span><br><span class="line">  Global redzone:        f9</span><br><span class="line">  Global init order:     f6</span><br><span class="line">  Poisoned by user:      f7</span><br><span class="line">  Container overflow:    <span class="built_in">fc</span></span><br><span class="line">  Array cookie:          ac</span><br><span class="line">  Intra object redzone:  bb</span><br><span class="line">  ASan internal:         fe</span><br><span class="line">  Left alloca redzone:   ca</span><br><span class="line">  Right alloca redzone:  cb</span><br><span class="line">  Shadow gap:            cc</span><br></pre></td></tr></table></figure>
<h4 id="asan-检验算法">3. ASan 检验算法</h4>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ShadowAddr = (Addr &gt;&gt; <span class="number">3</span>) + Offset; <span class="comment">// map from normal memory region to shadow memory</span></span><br><span class="line">k = *ShadowAddr;</span><br><span class="line"><span class="keyword">if</span> (k != <span class="number">0</span> &amp;&amp; ((Addr &amp; <span class="number">7</span>) + AccessSize &gt; k))</span><br><span class="line">	ReportAndCrash(Addr);</span><br></pre></td></tr></table></figure>
<p>在每次内存访问时，都会执行如上的伪代码，以判断此次内存访问是否合规。</p>
<p>首先根据normal memory的地址找到对应shadow
memory的地址，然后取出其中存取的byte值：k。</p>
<ul>
<li>k!=0，说明Normal memory region中的8个字节并不是都可以被寻址的。</li>
<li>Addr &amp; 7，将得知此次内存访问是从memory
region的第几个byte开始的。</li>
<li>AccessSize是此次内存访问需要访问的字节长度。</li>
<li>(Addr&amp;7)+AccessSize &gt;
k，则说明此次内存访问将会访问到不可寻址的字节。（具体可分为k大于0和小于0两种情况来分析）</li>
</ul>
<p>当此次内存访问可能会访问到不可寻址的字节时，ASAN会报错并结合shadow
memory中具体的值明确错误类型。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// before instrumentation</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">char</span> a[<span class="number">8</span>];</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// after instrumentation</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">foo</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">char</span> redzone1[<span class="number">32</span>];  <span class="comment">// 32-byte aligned</span></span><br><span class="line">  <span class="type">char</span> a[<span class="number">8</span>];          <span class="comment">// 32-byte aligned</span></span><br><span class="line">  <span class="type">char</span> redzone2[<span class="number">24</span>];</span><br><span class="line">  <span class="type">char</span> redzone3[<span class="number">32</span>];  <span class="comment">// 32-byte aligned</span></span><br><span class="line">  <span class="type">int</span>  *shadow_base = MemToShadow(redzone1);</span><br><span class="line">  shadow_base[<span class="number">0</span>] = <span class="number">0xffffffff</span>;  <span class="comment">// poison redzone1</span></span><br><span class="line">  shadow_base[<span class="number">1</span>] = <span class="number">0xffffff00</span>;  <span class="comment">// poison redzone2, unpoison &#x27;a&#x27;</span></span><br><span class="line">  shadow_base[<span class="number">2</span>] = <span class="number">0xffffffff</span>;  <span class="comment">// poison redzone3</span></span><br><span class="line">  ...</span><br><span class="line">  shadow_base[<span class="number">0</span>] = shadow_base[<span class="number">1</span>] = shadow_base[<span class="number">2</span>] = <span class="number">0</span>; <span class="comment">// unpoison all</span></span><br><span class="line">  <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>检验算法的汇编举例如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># int  load4(int *a)  &#123; return *a; &#125;</span><br><span class="line">0000000000000000 &lt;load4&gt;:</span><br><span class="line">   0:	48 89 f8             	mov    %rdi,%rax</span><br><span class="line">   3:	48 89 fa             	mov    %rdi,%rdx</span><br><span class="line">   6:	48 c1 e8 03          	shr    $0x3,%rax</span><br><span class="line">   a:	83 e2 07             	and    $0x7,%edx</span><br><span class="line">   d:	0f b6 80 00 80 ff 7f 	movzbl 0x7fff8000(%rax),%eax</span><br><span class="line">  14:	83 c2 03             	add    $0x3,%edx</span><br><span class="line">  17:	38 c2                	cmp    %al,%dl</span><br><span class="line">  19:	7d 03                	jge    1e &lt;load4+0x1e&gt;</span><br><span class="line">  1b:	8b 07                	mov    (%rdi),%eax    &lt;&lt;&lt;&lt;&lt;&lt; original load</span><br><span class="line">  1d:	c3                   	retq   </span><br><span class="line">  1e:	84 c0                	test   %al,%al</span><br><span class="line">  20:	74 f9                	je     1b &lt;load4+0x1b&gt;</span><br><span class="line">  22:	50                   	push   %rax</span><br><span class="line">  23:	e8 00 00 00 00       	callq  __asan_report_load4</span><br></pre></td></tr></table></figure>
<h4 id="asan代码解释">4. ASAN代码解释</h4>
<p>对于下列C++代码</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span>* a = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">10</span>];</span><br><span class="line">    a[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (a[argc])</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;xx\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其LLVM的代码本来为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">define dso_local i32 @main(i32 %argc, i8** %argv) #0 !dbg !9 &#123;</span><br><span class="line">entry:</span><br><span class="line">  %retval = alloca i32, align 4</span><br><span class="line">  %argc.addr = alloca i32, align 4</span><br><span class="line">  %argv.addr = alloca i8**, align 8</span><br><span class="line">  %a = alloca i32*, align 8</span><br><span class="line">  store i32 0, i32* %retval, align 4</span><br><span class="line">  store i32 %argc, i32* %argc.addr, align 4</span><br><span class="line">  store i8** %argv, i8*** %argv.addr, align 8</span><br><span class="line">  %call = call i8* @_Znam(i64 40) #3, !dbg !11</span><br><span class="line">  %0 = bitcast i8* %call to i32*, !dbg !11</span><br><span class="line">  store i32* %0, i32** %a, align 8, !dbg !12</span><br><span class="line">  %1 = load i32*, i32** %a, align 8, !dbg !13</span><br><span class="line">  %arrayidx = getelementptr inbounds i32, i32* %1, i64 5, !dbg !13</span><br><span class="line">  store i32 0, i32* %arrayidx, align 4, !dbg !14</span><br><span class="line">  %2 = load i32*, i32** %a, align 8, !dbg !15</span><br><span class="line">  %3 = load i32, i32* %argc.addr, align 4, !dbg !16</span><br><span class="line">  %idxprom = sext i32 %3 to i64, !dbg !15</span><br><span class="line">  %arrayidx1 = getelementptr inbounds i32, i32* %2, i64 %idxprom, !dbg !15</span><br><span class="line">  %4 = load i32, i32* %arrayidx1, align 4, !dbg !15</span><br><span class="line">  %tobool = icmp ne i32 %4, 0, !dbg !15</span><br><span class="line">  br i1 %tobool, label %if.then, label %if.end, !dbg !15</span><br><span class="line"></span><br><span class="line">if.then:                                          ; preds = %entry</span><br><span class="line">  %call2 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([4 x i8], [4 x i8]* @.str, i64 0, i64 0)), !dbg !17</span><br><span class="line">  br label %if.end, !dbg !17</span><br><span class="line"></span><br><span class="line">if.end:                                           ; preds = %if.then, %entry</span><br><span class="line">  ret i32 0, !dbg !18</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中有a[5]和a[argc]两个内存访问，针对这两个内存访问，Memory
Sanitizer分别加入如下语句进行检查</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">; a[5] </span><br><span class="line">  %arrayidx = getelementptr inbounds i32, i32* %2, i64 5, !dbg !16</span><br><span class="line">  %3 = ptrtoint i32* %arrayidx to i64, !dbg !17</span><br><span class="line">  %4 = lshr i64 %3, 3, !dbg !17</span><br><span class="line">  %5 = add i64 %4, 2147450880, !dbg !17</span><br><span class="line">  %6 = inttoptr i64 %5 to i8*, !dbg !17</span><br><span class="line">  %7 = load i8, i8* %6, !dbg !17</span><br><span class="line">  %8 = icmp ne i8 %7, 0, !dbg !17</span><br><span class="line">  br i1 %8, label %9, label %15, !dbg !17, !prof !18</span><br><span class="line"></span><br><span class="line">9:                                                ; preds = %entry</span><br><span class="line">  %10 = and i64 %3, 7, !dbg !17</span><br><span class="line">  %11 = add i64 %10, 3, !dbg !17</span><br><span class="line">  %12 = trunc i64 %11 to i8, !dbg !17</span><br><span class="line">  %13 = icmp sge i8 %12, %7, !dbg !17</span><br><span class="line">  br i1 %13, label %14, label %15, !dbg !17</span><br><span class="line"></span><br><span class="line">14:                                               ; preds = %9</span><br><span class="line">  call void @__asan_report_store4(i64 %3), !dbg !17</span><br><span class="line">  call void asm sideeffect &quot;&quot;, &quot;&quot;()</span><br><span class="line">  unreachable</span><br><span class="line">  </span><br><span class="line">15:                                               ; preds = %9, %entry</span><br><span class="line">  store i32 0, i32* %arrayidx, align 4, !dbg !17</span><br></pre></td></tr></table></figure>
<p><code>%arrayidx</code>指的是指向<code>a[5]</code>的指针，memory
sanitizer会检查这个指针指向的内存区域是不是合法的。首先将其扩展成64位后左移3个bit后加上offset
2147450880(0x7FFF8000)，也就是%5，该值为对应的shadow
memory的内存地址，从shadow memory中加载内存信息为%7：</p>
<ul>
<li>首先判断该信息是否为0，如果等于0，表示8个内存区域都可以访问，跳转到block
15，说明可以利用<code>%arrayidx</code>访问相应数据</li>
<li>如果不等于0，判断可访问的字节数是否合法，即是否大于k，若大于则跳转到block
14，报错。</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ShadowAddr = (Addr &gt;&gt; <span class="number">3</span>) + Offset; <span class="comment">// map from normal memory region to shadow memory</span></span><br><span class="line">k = *ShadowAddr;</span><br><span class="line"><span class="keyword">if</span> (k != <span class="number">0</span> &amp;&amp; ((Addr &amp; <span class="number">7</span>) + AccessSize &gt; k))</span><br><span class="line">	<span class="built_in">ReportAndCrash</span>(Addr);</span><br></pre></td></tr></table></figure>
<p>同样的<code>%arrayidx1</code>指的是指向<code>a[argc]</code>的指针，memory
sanitizer会检查这个指针指向的内存区域是不是合法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">  %arrayidx1 = getelementptr inbounds i32, i32* %16, i64 %idxprom, !dbg !19</span><br><span class="line">  %18 = ptrtoint i32* %arrayidx1 to i64, !dbg !19</span><br><span class="line">  %19 = lshr i64 %18, 3, !dbg !19</span><br><span class="line">  %20 = add i64 %19, 2147450880, !dbg !19</span><br><span class="line">  %21 = inttoptr i64 %20 to i8*, !dbg !19</span><br><span class="line">  %22 = load i8, i8* %21, !dbg !19</span><br><span class="line">  %23 = icmp ne i8 %22, 0, !dbg !19</span><br><span class="line">  br i1 %23, label %24, label %30, !dbg !19, !prof !18</span><br><span class="line"></span><br><span class="line">24:                                               ; preds = %15</span><br><span class="line">  %25 = and i64 %18, 7, !dbg !19</span><br><span class="line">  %26 = add i64 %25, 3, !dbg !19</span><br><span class="line">  %27 = trunc i64 %26 to i8, !dbg !19</span><br><span class="line">  %28 = icmp sge i8 %27, %22, !dbg !19</span><br><span class="line">  br i1 %28, label %29, label %30, !dbg !19</span><br><span class="line"></span><br><span class="line">29:                                               ; preds = %24</span><br><span class="line">  call void @__asan_report_load4(i64 %18), !dbg !19</span><br><span class="line">  call void asm sideeffect &quot;&quot;, &quot;&quot;()</span><br><span class="line">  unreachable</span><br><span class="line"></span><br><span class="line">30:                                               ; preds = %24, %15</span><br><span class="line">  %31 = load i32, i32* %arrayidx1, align 4, !dbg !19</span><br></pre></td></tr></table></figure>
<h4 id="代码实现">5. 代码实现</h4>
<h4 id="缺陷">6. 缺陷</h4>
<ol type="1">
<li>CPU和Memory资源的消耗</li>
<li>UseAfterFree的检测依赖隔离区，而隔离时间是非永久的，跨越过隔离时间后再次访问是有限的，会导致漏检。</li>
<li>Overflow的检测依赖安全区，而安全区是有大小的，大小是有限的，跨越安全区访问就有可能也不报错，这是另一个漏检的原因。</li>
</ol>
<h3 id="hwasan">HWASAN</h3>
<h4 id="什么是hwasan">1. 什么是HWASAN</h4>
<p>HWASAN是ASAN工具的升级版，它基本上解决了上面所说的ASAN的3个问题。但是它需要64位硬件的支持，也就是说在32位的机器上该工具无法运行。</p>
<p>AArch64是64位的架构，指的是寄存器的宽度是64位，但并不表示内存的寻址范围是2^64。真实的寻址范围和处理器内部的总线宽度有关，实际上ARMv8寻址只用到了低48位。也就是说，一个64bit的指针值，其中真正用于寻址的只有低48位。那么剩下的高16位干什么用呢？答案是随意发挥。AArch64拥有地址标记(Address
tagging, or
top-byte-ignore)的特性，它表示允许软件使用64bit指针值的高8位开发特定功能。</p>
<p>HWASAN用这8bit来存储一块内存区域的标签(tag)。接下来我们以堆内存示例，展示这8bit到底如何起作用。</p>
<p>堆内存通过malloc分配出来，HWASAN在它返回地址时会更改该有效地址的高8位。更改的值是一个随机生成的单字节值，譬如0xaf。此外，该分配出来的内存对应的shadow
memory值也设为0xaf。需要注意的是，HWASAN中normal memory和shadow
memory的映射关系是16➡1，而ASAN中二者的映射关系是8➡1</p>
<h4 id="检测useafterfree">2. 检测UseAfterFree</h4>
<h5 id="use-after-free">2.1 Use-After-Free</h5>
<p>当一个堆内存被分配出来时，返回给用户空间的地址便已经带上了标签（存储于地址的高8位）。之后通过该地址进行内存访问，将先检测地址中的标签值和访问地址对应的shadow
memory的值是否相等。如果相等则验证通过，可以进行正常的内存访问。</p>
<p>当该内存被free时，HWASAN会为该块区域分配一个新的随机值，存储于其对应的shadow
memory中。如果此后再有新的访问，则地址中的标签值必然不等于shadow
memory中存储的新的随机值，因此会有错误产生。通过如下图示可以很好地明白这一点（图中只用了4bit记录标记值，但不影响理解，8bit标记值的检测和它一致）。</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/3/31/1713138a2f5cb553?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" style="zoom: 43%;" /></p>
<h5 id="heap-over-flow">2.2 Heap-Over-Flow</h5>
<p>想要检测HeapOverFlow，有一个前提需要满足：相邻的memory区域需要有不同的shadow
memory值，否则将无法分辨两个不同的memory区域。为每个memory区域随机分配将有概率让两个相邻区域具有同样的shadow
memory值，虽然概率比较小，但总归是个缺陷。因此工具中会有其他逻辑保证这个前提。</p>
<p>下图展示了HeapOverFlow的检测过程。指针p的标签和访问的地址p[32]所对应的shadow
memory值不一致，因此报错（图中只用了4bit记录标记值，但不影响理解，8bit标记值的检测和它一致）。</p>
<p><img src="https://user-gold-cdn.xitu.io/2020/3/31/1713138d91688f78?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" alt="img" style="zoom:30%;" /></p>
<h5 id="优缺点">2.3 优缺点</h5>
<p>和ASAN相比，HWASAN具有如下缺点：</p>
<ol type="1">
<li>可移植性较差，只适用于64位机器。</li>
<li>需要对Linux Kernel做一些改动以支持工具。</li>
<li>对于所有错误的检测将有一定概率false
negative（漏掉一些真实的错误），概率为1/256。原因是tag的生成只能从256（2^8）个数中选一个，因此不同地址的tag将有可能相同。</li>
</ol>
<p>不过相对于这些缺点，HWASAN所拥有的优点更加引人注目：</p>
<ol type="1">
<li>不再需要安全区来检测buffer
overflow，既极大地降低了工具对于内存的消耗，也不会出现ASAN中某些overflow检测不到的情况。</li>
<li>不再需要隔离区来检测UseAfterFree，因此不会出现ASAN中某些UseAfterFree检测不到的情况。</li>
</ol>
<h4 id="mte">3. MTE</h4>
<p>Memory Tagging是Arm
v8.5引入的新的硬件特性，从硬件层面完全实现上述HWASAN的逻辑，并添加相应的汇编指令支持tag的操作和分配等。</p>
<p>https://github.com/google/sanitizers/wiki/Stack-instrumentation-with-ARM-Memory-Tagging-Extension-(MTE)</p>
<h4 id="reference">Reference</h4>
<ol type="1">
<li>https://www.usenix.org/system/files/conference/atc12/atc12-final39.pdf</li>
<li>https://arxiv.org/ftp/arxiv/papers/1802/1802.09517.pdf</li>
<li>https://clang.llvm.org/docs/HardwareAssistedAddressSanitizerDesign.html</li>
<li>https://github.com/google/sanitizers/blob/master/hwaddress-sanitizer/Hardware%20Memory%20Tagging%20to%20make%20C_C%2B%2B%20memory%20safe(r)%20-%20iSecCon%202018.pdf</li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/blog/2021/01/08/LLVM-Pass/" rel="prev" title="LLVM Pass">
                  <i class="fa fa-angle-left"></i> LLVM Pass
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/blog/2021/01/10/Memory-Safety/" rel="next" title="Memory Safety">
                  Memory Safety <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Wei CHEN</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/blog/js/comments.js"></script><script src="/blog/js/utils.js"></script><script src="/blog/js/motion.js"></script><script src="/blog/js/next-boot.js"></script>

  






  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/blog/js/third-party/math/mathjax.js"></script>



</body>
</html>
