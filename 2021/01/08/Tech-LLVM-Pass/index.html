<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"harperchen.github.io","root":"/blog/","images":"/blog/images","scheme":"Gemini","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/blog/js/config.js"></script>

    <meta name="description" content="1. 查看LLVM IR 使用LLVM的编译流程：源码 -&gt; AST -&gt; LLVM IR (.ll)-&gt; LLVM Bitcode (.bc) -&gt; ASM -&gt; Native  llvm-as：把LLVM IR从人类能看懂的文本格式汇编成二进制格式。注意：此处得到的不是目标平台的机器码。 llvm-dis：llvm-as的逆过程，即反汇编。 不过这里的反汇编的对象">
<meta property="og:type" content="article">
<meta property="og:title" content="LLVM Pass">
<meta property="og:url" content="https://harperchen.github.io/blog/2021/01/08/Tech-LLVM-Pass/index.html">
<meta property="og:site_name" content="Wei&#39;s Blog">
<meta property="og:description" content="1. 查看LLVM IR 使用LLVM的编译流程：源码 -&gt; AST -&gt; LLVM IR (.ll)-&gt; LLVM Bitcode (.bc) -&gt; ASM -&gt; Native  llvm-as：把LLVM IR从人类能看懂的文本格式汇编成二进制格式。注意：此处得到的不是目标平台的机器码。 llvm-dis：llvm-as的逆过程，即反汇编。 不过这里的反汇编的对象">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2021/01/12/bSe35pXlxgEafwC.png">
<meta property="og:image" content="https://i.loli.net/2021/01/11/nSwWy7EOp4ZF82P.png">
<meta property="og:image" content="https://i.loli.net/2021/01/10/4q7FotgY5MdRAN6.png">
<meta property="og:image" content="https://i.loli.net/2021/01/12/fO1rKVMFdHAp8xW.png">
<meta property="og:image" content="https://i.loli.net/2021/01/10/icTWFOy1l7Q9Emb.png">
<meta property="og:image" content="https://i.loli.net/2021/01/12/plSRyaQiH3MqIuV.png">
<meta property="og:image" content="https://i.loli.net/2021/01/12/YpbfTmGwciHNEk6.png">
<meta property="og:image" content="https://i.loli.net/2021/01/16/H57i1kxS4QaYhZy.png">
<meta property="og:image" content="https://i.loli.net/2021/01/16/JrHu61kifZCNsmO.png">
<meta property="og:image" content="https://i.loli.net/2021/01/09/Y5XfyPxaQGcSgEu.png">
<meta property="og:image" content="https://i.loli.net/2021/01/09/ztK5RETxmkU71w4.png">
<meta property="og:image" content="https://i.loli.net/2021/01/11/RgknqFWA9MYb1zo.png">
<meta property="og:image" content="https://i.loli.net/2021/01/11/UaYyz6nJcw9EIhT.png">
<meta property="og:image" content="https://i.loli.net/2021/01/11/SmCxYaDPkpn3r85.png">
<meta property="og:image" content="https://i.loli.net/2021/01/11/MKa2EV48fY6kXFl.png">
<meta property="og:image" content="https://i.loli.net/2021/01/11/BX4GxdHpnb9zCuS.png">
<meta property="og:image" content="https://i.loli.net/2021/01/12/5klbasJQOiz6IAC.png">
<meta property="og:image" content="https://i.loli.net/2021/01/11/v6W9y7Q83pGcjFl.png">
<meta property="og:image" content="https://i.loli.net/2021/01/11/ENtIQYoGUuph6PX.png">
<meta property="og:image" content="https://i.loli.net/2021/01/11/Q7SUNhd96AgRWLb.png">
<meta property="og:image" content="https://i.loli.net/2021/01/12/nwErFPyhx3VReQ7.png">
<meta property="og:image" content="https://i.loli.net/2021/01/12/vt4S7Wic2a6z8JT.png">
<meta property="og:image" content="https://i.loli.net/2021/01/12/qjnOP3yTfcxR2K4.png">
<meta property="og:image" content="https://i.loli.net/2021/01/17/C7GnhFcYDimRQ94.png">
<meta property="og:image" content="https://i.loli.net/2021/01/17/oScGwrnBs1PQxdq.png">
<meta property="og:image" content="https://i.loli.net/2021/01/17/UnSOy7zrQLjPt45.png">
<meta property="og:image" content="https://i.loli.net/2021/01/17/7JCIjQiSMgtADdm.png">
<meta property="og:image" content="https://i.loli.net/2021/01/11/V8QW1lRq9zHs3Ei.png">
<meta property="article:published_time" content="2021-01-08T13:09:24.000Z">
<meta property="article:modified_time" content="2024-03-27T05:21:36.079Z">
<meta property="article:author" content="Wei CHEN">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/01/12/bSe35pXlxgEafwC.png">


<link rel="canonical" href="https://harperchen.github.io/blog/2021/01/08/Tech-LLVM-Pass/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://harperchen.github.io/blog/2021/01/08/Tech-LLVM-Pass/","path":"2021/01/08/Tech-LLVM-Pass/","title":"LLVM Pass"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>LLVM Pass | Wei's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Wei's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%9F%A5%E7%9C%8Bllvm-ir"><span class="nav-number">1.</span> <span class="nav-text">1. 查看LLVM IR</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#llvm-ir%E8%AF%AD%E6%B3%95"><span class="nav-number">2.</span> <span class="nav-text">2. LLVM IR语法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#module"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 Module</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#function"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 Function</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#baisc-block"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 Baisc Block</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#instruction"><span class="nav-number">2.4.</span> <span class="nav-text">2.4 Instruction</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E6%95%B0%E7%BB%84"><span class="nav-number">2.4.1.</span> <span class="nav-text">2.4.1 简单数组</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%A4%8D%E6%9D%82%E6%95%B0%E7%BB%84"><span class="nav-number">2.4.2.</span> <span class="nav-text">2.4.2 复杂数组</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">2.4.2.1.</span> <span class="nav-text">2.4.3 结构体</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#operand"><span class="nav-number">2.5.</span> <span class="nav-text">2.5 Operand</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mac%E9%85%8D%E7%BD%AEllvm"><span class="nav-number">3.</span> <span class="nav-text">3. Mac配置LLVM</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#xcode%E7%BC%96%E8%AF%91llvm-project"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 Xcode编译LLVM Project</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#xcode%E7%BC%96%E8%AF%91llvm-pass"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 Xcode编译LLVM Pass</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#xcode-%E8%B0%83%E8%AF%95-llvm-pass"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 Xcode 调试 LLVM Pass</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ubuntu%E9%85%8D%E7%BD%AEllvm"><span class="nav-number">4.</span> <span class="nav-text">4. Ubuntu配置LLVM</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ubuntu%E7%BC%96%E8%AF%91llvm-project"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 Ubuntu编译LLVM Project</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%BC%96%E8%AF%91llvm-pass"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 命令行编译LLVM Pass</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#clion%E7%BC%96%E8%AF%91llvm-pass"><span class="nav-number">4.3.</span> <span class="nav-text">4.3 Clion编译LLVM Pass</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#clion%E8%B0%83%E8%AF%95llvm-pass"><span class="nav-number">4.4.</span> <span class="nav-text">4.4 Clion调试LLVM Pass</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%91%BD%E4%BB%A4%E8%A1%8C%E7%BC%96%E8%AF%91%E5%8D%95%E4%B8%AAllvm-pass%E6%96%87%E4%BB%B6"><span class="nav-number">4.5.</span> <span class="nav-text">4.5 命令行编译单个LLVM
Pass文件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#write-llvm-pass"><span class="nav-number">5.</span> <span class="nav-text">5. Write LLVM Pass</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#read-llvm-pass"><span class="nav-number">6.</span> <span class="nav-text">6. Read LLVM Pass</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%8B%E5%AD%901"><span class="nav-number">6.1.</span> <span class="nav-text">6.1 例子1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BE%8B%E5%AD%90%E4%BA%8C"><span class="nav-number">6.2.</span> <span class="nav-text">6.2 例子二</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%A1%B9%E7%9B%AEsanrazor"><span class="nav-number">7.</span> <span class="nav-text">7. 项目SanRazor</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E7%A8%8B%E5%BA%8F"><span class="nav-number">7.1.</span> <span class="nav-text">7.1 测试程序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%92%E6%A1%A9%E7%A8%8B%E5%BA%8F"><span class="nav-number">7.2.</span> <span class="nav-text">7.2 插桩程序</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%A0%E9%99%A4%E5%A4%9A%E4%BD%99sanitizer"><span class="nav-number">7.3.</span> <span class="nav-text">7.3 删除多余sanitizer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E9%80%BB%E8%BE%91"><span class="nav-number">7.4.</span> <span class="nav-text">7.4 代码逻辑</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Wei CHEN"
      src="/blog/images/8.jpg">
  <p class="site-author-name" itemprop="name">Wei CHEN</p>
  <div class="site-description" itemprop="description">Be Brave; Be Confident; <br> Be Happy; Be Optimistic; </div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">60</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/blog/tags/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/harperchen" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;harperchen" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:harperchen1110@gmail.com" title="E-Mail → mailto:harperchen1110@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harperchen.github.io/blog/2021/01/08/Tech-LLVM-Pass/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/8.jpg">
      <meta itemprop="name" content="Wei CHEN">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wei's Blog">
      <meta itemprop="description" content="Be Brave; Be Confident; <br> Be Happy; Be Optimistic; ">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="LLVM Pass | Wei's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          LLVM Pass
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-01-08 21:09:24" itemprop="dateCreated datePublished" datetime="2021-01-08T21:09:24+08:00">2021-01-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-27 13:21:36" itemprop="dateModified" datetime="2024-03-27T13:21:36+08:00">2024-03-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Techniques/" itemprop="url" rel="index"><span itemprop="name">Techniques</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h3 id="查看llvm-ir">1. 查看LLVM IR</h3>
<p>使用LLVM的编译流程：源码 -&gt; AST -&gt; LLVM IR
(<code>.ll</code>)-&gt; LLVM Bitcode (<code>.bc</code>) -&gt; ASM -&gt;
Native</p>
<ul>
<li><code>llvm-as</code>：把LLVM
IR从人类能看懂的文本格式汇编成二进制格式。注意：此处得到的<strong>不是</strong>目标平台的机器码。</li>
<li><code>llvm-dis</code>：<code>llvm-as</code>的逆过程，即反汇编。
不过这里的反汇编的对象是LLVM IR的二进制格式，而不是机器码。</li>
<li><code>opt</code>：优化LLVM IR。输出新的LLVM IR。</li>
<li><code>llc</code>：把LLVM
IR编译成汇编码。需要用<code>as</code>进一步得到机器码。</li>
<li><code>lli</code>：解释执行LLVM IR</li>
</ul>
<span id="more"></span>
<p>LLVM编译过程的举例 https://www.jianshu.com/p/ccd467ff5209</p>
<p><img src="https://i.loli.net/2021/01/12/bSe35pXlxgEafwC.png" alt="image-20210112131915095" style="zoom:47%;" /></p>
<ol type="1">
<li>.c -&gt; AST</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -Xclang -ast-dump -fsyntax-only test.cpp</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2021/01/11/nSwWy7EOp4ZF82P.png" alt="image-20210110151724272" style="zoom: 67%;" /></p>
<p>or</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang++ -Xclang -ast-view test.cpp <span class="comment"># require the llvm to be compiled in Debug mode</span></span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2021/01/10/4q7FotgY5MdRAN6.png" alt="image-20210110180350012" style="zoom:57%;" /></p>
<ol start="2" type="1">
<li>.c -&gt; LLVM IR (.ll)</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang++ -S -emit-llvm test.cpp</span><br></pre></td></tr></table></figure>
<p>A sample of LLVM IR</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">cat</span> test.ll</span><br><span class="line">define i32 @mult(i32 %a, i32 %b) <span class="comment">#0 &#123;</span></span><br><span class="line">  %1 = mul nsw i32 %a, %b</span><br><span class="line">  ret i32 %1</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>or generate LLVM IR from bitcode</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">llvm-dis test.bc <span class="comment"># test.ll</span></span><br></pre></td></tr></table></figure>
<ol start="3" type="1">
<li>LLVM -&gt; bitcode</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">llvm-as test.ll <span class="comment"># test.bc</span></span><br><span class="line">clang -c -emit-llvm test.cpp</span><br></pre></td></tr></table></figure>
<p>The output is generated in the <code>test.bc</code> file, which is in
bit stream format;</p>
<ol start="4" type="1">
<li>bitcode -&gt; ASM</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">llc test.bc -o test.s</span><br><span class="line">llc test.ll -o test.s</span><br></pre></td></tr></table></figure>
<p>The output is generated in test.S file, which is the assembly
code.</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">	.text</span></span><br><span class="line"><span class="meta">	.file</span>	<span class="string">&quot;test.cpp&quot;</span></span><br><span class="line"><span class="meta">	.globl</span>	main                            # -- Begin function main</span><br><span class="line"><span class="meta">	.p2align</span>	<span class="number">4</span>, <span class="number">0x90</span></span><br><span class="line"><span class="meta">	.type</span>	main,@function</span><br><span class="line"><span class="symbol">main:</span>                                   # @main</span><br><span class="line"><span class="meta">	.cfi_startproc</span></span><br><span class="line"># %bb<span class="number">.0</span>:</span><br><span class="line">	pushq	%rbp</span><br><span class="line"><span class="meta">	.cfi_def_cfa_offset</span> <span class="number">16</span></span><br><span class="line"><span class="meta">	.cfi_offset</span> %rbp, -<span class="number">16</span></span><br><span class="line">	<span class="keyword">movq</span>	%rsp, %rbp</span><br><span class="line"><span class="meta">	.cfi_def_cfa_register</span> %rbp</span><br><span class="line">	subq	<span class="number">$32</span>, %rsp</span><br><span class="line">	...</span><br></pre></td></tr></table></figure>
<p>or use clang to dump assembly code from the bitcode file format</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clang -S test.bc -o test.s</span><br><span class="line">clang++ -S test.cpp -o test.s </span><br></pre></td></tr></table></figure>
<ol start="5" type="1">
<li>ASM -&gt; binary</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clang++ test.s -o test.o</span><br><span class="line">clang++ test.bc -o test.o</span><br></pre></td></tr></table></figure>
<h3 id="llvm-ir语法">2. LLVM IR语法</h3>
<p>官方文档 https://llvm.org/docs/LangRef.html</p>
<p>官方ppt
https://llvm.org/devmtg/2019-04/slides/Tutorial-Bridgers-LLVM_IR_tutorial.pdf</p>
<p>LLVM IR 在线平台 https://godbolt.org/</p>
<p>知乎链接 LLVM IR Tour 上 https://zhuanlan.zhihu.com/p/66793637</p>
<p>知乎链接 LLVM IR Tour 下 https://zhuanlan.zhihu.com/p/66909226</p>
<p><img src="https://i.loli.net/2021/01/12/fO1rKVMFdHAp8xW.png" alt="image-20210112132036280" style="zoom:47%;" /></p>
<h4 id="module">2.1 Module</h4>
<p>Module 可以被视为一个.c文件的 IR 表示，如果用Java的描述的话，
Module相当于Java里的类，是独立存在的一个东西。</p>
<p>每个
Module都是相对独立的东西，主要包含了声明或者定义的函数、声明或定义的全局变量、当前
Module的基本信息，因为在开发 Pass的过程中，基本打交道的就是 Function 和
GlobalVariable 这两个东西。</p>
<p>多个 Module之间是相互隔离的、无法获取对方的内容。平时为了获取 Module
的主要信息，使用它的 M.dump() 方法就会在屏幕上打印出全部信息。LLVM IR
文件的开头是</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = <span class="string">&#x27;test.cpp&#x27;</span></span><br><span class="line">source_filename = <span class="string">&quot;test.cpp&quot;</span></span><br><span class="line">target datalayout = <span class="string">&quot;e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span></span><br><span class="line">target triple = <span class="string">&quot;x86_64-unknown-linux-gnu&quot;</span></span><br></pre></td></tr></table></figure>
<p><code>;</code>后面的注释指明了module的标识，<code>source_filename</code>是表明这个module是从什么文件编译得到的，如果该modules是通过链接得到的，这里的值就会是<code>llvm-link</code>。后面的<code>target datalayout</code>和<code>targe triple</code>用来描述target的信息，包括大小端等。</p>
<p>接下来是字符串<code>@.str</code>的定义，llvm中的标识符分为两种类型：全局的和局部的。全局的标识符包括函数名和全局变量，会加一个<code>@</code>前缀，全局变量永远是指针，局部的标识符会加一个<code>%</code>前缀。一般地，可用标识符对应的正则表达式为<code>[%@][-a-zA-Z$._][-a-zA-Z$._0-9]*</code>。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@.str = private unnamed_addr constant [<span class="number">4</span> x i8] c<span class="string">&quot;xx\0A\00&quot;</span>, <span class="meta">align</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>然后是各函数的声明和定义，最后是一些其他相关信息，例如在文件的下面有attribute
group的信息，因为attribute
group可能很包含很多attribute且复用到多个函数，所以用attribute group
ID(即<code>#0</code>)的形式指明函数的attribute。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">attributes <span class="comment">#0 = &#123; noinline norecurse optnone uwtable &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;min-legal-vector-width&quot;=&quot;0&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;true&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="function">2.2 Function</h4>
<p>Function 是 Module中以List的方式存放的，如果用Java的描述的话，
Function相当于Java里的Method，无法单独存在，必须是在某个
Module里的。主要包含了大量 BasicBlock
、参数和返回值类型、可变参数列表、函数的attribute和其他函数的基本信息（例如函数名、所在
Module等）</p>
<p>Function由无数个 BasicBlock组成，使用列表存放，有且仅有一个
EntryBlock ，是列表中的第一个 BasicBlock，代码真正执行的时候，就从
EntryBlock开始执行。因为函数不一定只有一个出口，所以
Function是无法知道它退出时的Block的，没有这个API，如果非要知道的话可以手动去判断每个
BasicBlock是否有后继。</p>
<p>Function有两个很实用的函数， F.dump() 可以打印出全部信息，
F.viewCfg() 可以将ControlFlowGraph按照dot的方式存到文件里。</p>
<p>函数main的定义如下，<code>dso_local</code>是一个Runtime
Preemption说明符，表明该函数会在同一个链接单元（即该函数所在的文件以及包含的头文件）内解析符号。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">define dso_local i32 @main(i32 <span class="subst">%0</span>, i8** <span class="subst">%1</span>) #<span class="number">0</span> &#123;</span><br><span class="line">  <span class="subst">%3</span> = alloca i32, <span class="meta">align</span> <span class="number">4</span></span><br><span class="line">  <span class="subst">%4</span> = alloca i32, <span class="meta">align</span> <span class="number">4</span></span><br><span class="line">  <span class="subst">%5</span> = alloca i8**, <span class="meta">align</span> <span class="number">8</span></span><br><span class="line">  <span class="subst">%6</span> = alloca i32*, <span class="meta">align</span> <span class="number">8</span></span><br><span class="line">  store i32 <span class="number">0</span>, i32* <span class="subst">%3</span>, <span class="meta">align</span> <span class="number">4</span></span><br><span class="line">  store i32 <span class="subst">%0</span>, i32* <span class="subst">%4</span>, <span class="meta">align</span> <span class="number">4</span></span><br><span class="line">  store i8** <span class="subst">%1</span>, i8*** <span class="subst">%5</span>, <span class="meta">align</span> <span class="number">8</span></span><br><span class="line">  <span class="subst">%7</span> = <span class="keyword">call</span> noalias nonnull i8* @_Znam(i64 <span class="number">40</span>) #<span class="number">3</span></span><br><span class="line">  <span class="subst">%8</span> = bitcast i8* <span class="subst">%7</span> to i32*</span><br><span class="line">  store i32* <span class="subst">%8</span>, i32** <span class="subst">%6</span>, <span class="meta">align</span> <span class="number">8</span></span><br><span class="line">  <span class="subst">%9</span> = load i32*, i32** <span class="subst">%6</span>, <span class="meta">align</span> <span class="number">8</span></span><br><span class="line">  <span class="subst">%10</span> = getelementptr inbounds i32, i32* <span class="subst">%9</span>, i64 <span class="number">5</span></span><br><span class="line">  store i32 <span class="number">0</span>, i32* <span class="subst">%10</span>, <span class="meta">align</span> <span class="number">4</span></span><br><span class="line">  <span class="subst">%11</span> = load i32*, i32** <span class="subst">%6</span>, <span class="meta">align</span> <span class="number">8</span></span><br><span class="line">  <span class="subst">%12</span> = load i32, i32* <span class="subst">%4</span>, <span class="meta">align</span> <span class="number">4</span></span><br><span class="line">  <span class="subst">%13</span> = sext i32 <span class="subst">%12</span> to i64</span><br><span class="line">  <span class="subst">%14</span> = getelementptr inbounds i32, i32* <span class="subst">%11</span>, i64 <span class="subst">%13</span></span><br><span class="line">  <span class="subst">%15</span> = load i32, i32* <span class="subst">%14</span>, <span class="meta">align</span> <span class="number">4</span></span><br><span class="line">  <span class="subst">%16</span> = icmp ne i32 <span class="subst">%15</span>, <span class="number">0</span></span><br><span class="line">  br i1 <span class="subst">%16</span>, label <span class="subst">%17</span>, label <span class="subst">%19</span></span><br><span class="line"></span><br><span class="line"><span class="number">17</span>:                                               <span class="comment">; preds = %2</span></span><br><span class="line">  <span class="subst">%18</span> = <span class="keyword">call</span> i32 (i8*, ...) @printf(i8* getelementptr inbounds ([<span class="number">4</span> x i8], [<span class="number">4</span> x i8]* @.str, i64 <span class="number">0</span>, i64 <span class="number">0</span>))</span><br><span class="line"><span class="symbol">  br label</span> <span class="subst">%19</span></span><br><span class="line"></span><br><span class="line"><span class="number">19</span>:                                               <span class="comment">; preds = %17, %2</span></span><br><span class="line">  <span class="keyword">ret</span> i32 <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在一对花括号里的就是函数体，函数体是由一系列basic
blocks(BB)组成的，这些BB形成了函数的控制流图(Control Flow Graph,
CFG)，该函数的含义如下所示：</p>
<ul>
<li>1: %0 是argc, %1是argv</li>
<li>2-3: %3 %4 是i32</li>
<li>4-5: %5 是i8*** %6是i32**</li>
<li>6-8: *(%3)=0；*(%4)=%0； *(%5)=%1</li>
<li>9-10: %8=(int *) new int[10]</li>
<li>11: <em>(%6)=%8</em></li>
<li>12-14: %10=%8+5；*(%10)=0；a[5]=0</li>
<li>15-19: %11=%8；%12=argc；%15=a[argc]</li>
<li>20-21: if %15 != 0: br %17 else %19</li>
</ul>
<p>LLVM的IR是一个强类型语言，每一条指令都显式地指出了实参的类型，例如<code>mul nsw i32 %call, 7</code>表明要将两个<code>i32</code>的数值相乘，<code>icmp eq i32 %mul, 42</code>表明要将两个i32的数据类型进行相等比较（这里<code>%mul</code>是一个变量，而<code>mul</code>是一条指令，可以看出IR加前缀的好处）。此外，我们还很容易推断出返回值的类型，比如<code>i32</code>的数相乘的返回值就是<code>i32</code>类型，比较两个数值的相等关系的返回值就是<code>i1</code>类型。</p>
<p>可以使用如下命令生成控制流程图。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">opt -analyze -dot-cfg-only test.cpp</span><br><span class="line">opt -analyze -dot-cfg test.cpp</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2021/01/10/icTWFOy1l7Q9Emb.png" alt="image-20210110194638257" style="zoom: 67%;" /></p>
<h4 id="baisc-block">2.3 Baisc Block</h4>
<p>BasicBlock，是 Function 中以List方式存放的，和Soot里的
BasicBlock概念很像，无法单独存在，必须是在某个Function里的，是真正存放可执行代码的容器。主要包含了大量的
Instruction ，前驱、后继的
BasicBlock，以及一些基本信息（例如名字什么的），相比 Function
，它的校验也更加严格，例如不可以凭空出现、不可以处于游离状态。</p>
<p>BasicBlock由很多 Instruction组成，按照是否为 TerminatorInst
可以将指令分为两类，一类是普通的指令，一类是可以成为 TerminatorInst
的指令；因此 BasicBlock一定要以
TerminatorInst类的指令结尾，而且除了最后一个指令是
TerminatorInst，其他指令都是普通指令。常见的 TerminatorInst 有
BranchInst 、 IndirectBrInst 、 SwitchInst 和 Return
，C++里还有一些异常处理：（call不算terminator）</p>
<ul>
<li>Branch: br</li>
<li>Return: rt</li>
<li>Switch: switch</li>
<li>Unreachable: unreachable</li>
<li>Exception handling instructions</li>
</ul>
<p><img src="https://i.loli.net/2021/01/12/plSRyaQiH3MqIuV.png" alt="image-20210112144417317" style="zoom:45%;" /></p>
<p>每个
BasicBlock都可以视为一段顺序执行的代码，完全不会有任何的分支，有分支就会通过
TerminatorInst进行跳转。</p>
<p>BasicBlock
有两种创建方式，一种是凭空创建，然后插入到之前的CFG里；一种比较方便，使用
SplitBasicBlock ，切为相连的两块，可能会遇到PhiNode的问题。</p>
<h4 id="instruction">2.4 Instruction</h4>
<p>Instruction ，是 BasicBlock
中以List方式存放的，和Soot里的Stmt的概念很像，无法单独存在，必须是在某个
BasicBlock 里的，可以视为 IR
层面的汇编语句，或者说指令。类型非常多。</p>
<h5 id="简单数组">2.4.1 简单数组</h5>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@array = <span class="meta">global</span> [<span class="number">17</span> x i8] zeroinitializer      </span><br><span class="line"></span><br><span class="line">constant size: <span class="number">17</span></span><br><span class="line">element type: i8</span><br><span class="line"><span class="symbol">initializer:</span> zeroinitializer</span><br><span class="line"></span><br><span class="line">&lt;result&gt; = getelementptr &lt;ty&gt;, &lt;ty&gt;* &lt;ptrval&gt;, [i32 &lt;idx&gt;]</span><br><span class="line">%new_ptr = getelementptr i32, i32* %base, i32 <span class="number">0</span></span><br><span class="line"># idx offsets by the base type</span><br><span class="line"># idx <span class="keyword">NOT</span> change the pointer type</span><br></pre></td></tr></table></figure>
<h5 id="复杂数组">2.4.2 复杂数组</h5>
<p><img src="https://i.loli.net/2021/01/12/YpbfTmGwciHNEk6.png" alt="image-20210112160447352" style="zoom:25%;" /></p>
<p><img src="https://i.loli.net/2021/01/16/H57i1kxS4QaYhZy.png" alt="image-20210112160638986" style="zoom:25%;" /></p>
<h6 id="结构体">2.4.3 结构体</h6>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%MyStruct = type &#123; i8, i32, [<span class="number">3</span> x i32]&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2021/01/16/JrHu61kifZCNsmO.png" alt="image-20210112160859746" style="zoom:25%;" /></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @COUNTER_SCBranchInfotest = global [2 x &#123; i64, [3 x i64] &#125;] zeroinitializer</span></span><br><span class="line"><span class="comment">// Create the component types of the table</span></span><br><span class="line"><span class="keyword">auto</span>* int64Ty    = Type::<span class="built_in">getInt64Ty</span>(context); <span class="comment">// i64</span></span><br><span class="line"><span class="keyword">auto</span>* int64ArrTy = ArrayType::<span class="built_in">get</span>(int64Ty, <span class="number">3</span>); <span class="comment">// 3 x i64</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span>* structTy   = StructType::<span class="built_in">get</span>(context, &#123;int64Ty, int64ArrTy&#125;, <span class="literal">false</span>); <span class="comment">// &#123;i64, [3 x i64]&#125;</span></span><br><span class="line"><span class="keyword">auto</span>* tableTy    = ArrayType::<span class="built_in">get</span>(structTy, <span class="number">2</span>); <span class="comment">// [2 x &#123;i64, [3 x i64]&#125;]</span></span><br><span class="line">ArrayRef&lt;<span class="type">uint64_t</span>&gt; COUNT = &#123;<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>&#125;;</span><br><span class="line"><span class="keyword">auto</span>* COUNTs = ConstantDataArray::<span class="built_in">get</span>(context, COUNT); <span class="comment">// &#123;0, 0, 0&#125; to initialize the array</span></span><br><span class="line"><span class="keyword">auto</span>* ID = ConstantInt::<span class="built_in">get</span>(int64Ty, <span class="number">0</span>, <span class="literal">false</span>); <span class="comment">// 0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Compute and store an externally visible array of branch information.</span></span><br><span class="line">std::vector&lt;Constant*&gt; values;</span><br><span class="line">std::<span class="built_in">transform</span>(</span><br><span class="line">    toCount.<span class="built_in">begin</span>(),</span><br><span class="line">    toCount.<span class="built_in">end</span>(),</span><br><span class="line">    std::<span class="built_in">back_inserter</span>(values),</span><br><span class="line">    [ID, COUNTs, structTy, str](Instruction* Inst) &#123;</span><br><span class="line">        Constant* structFields[] = &#123;ID, COUNTs&#125;;</span><br><span class="line">        <span class="keyword">return</span> ConstantStruct::<span class="built_in">get</span>(structTy, structFields);</span><br><span class="line">    &#125;); <span class="comment">// two structs  2 x &#123;i64, [3 x i64]&#125; zeroinitializer</span></span><br><span class="line"><span class="keyword">auto</span>* BranchTable = ConstantArray::<span class="built_in">get</span>(tableTy, values); <span class="comment">// a table [2 x &#123; i64, [3 x i64] &#125;] zeroinitializer</span></span><br><span class="line"><span class="keyword">new</span> <span class="built_in">GlobalVariable</span>(m,</span><br><span class="line">                   tableTy,</span><br><span class="line">                   <span class="literal">false</span>,</span><br><span class="line">                   GlobalValue::ExternalLinkage,</span><br><span class="line">                   BranchTable,</span><br><span class="line">                   <span class="string">&quot;COUNTER_&quot;</span>+str);</span><br></pre></td></tr></table></figure>
<h4 id="operand">2.5 Operand</h4>
<p>Operand是 Instruction里的各个参数（如果有的话）。每个 Operand 都是
Value ，就是任意的东西， Function可以作为某些指令的参数、
BasicBlock也可以作为某些指令的参数、甚至
Instruction本身也可以作为某些指令的参数。</p>
<p>在IR中，每个变量都在使用前都必须先定义，且每个变量只能被赋值一次，所以我们称IR是静态单一赋值的。此时在循环中，就有可能会破坏这个规则，一个变量被赋值很多次。例如针对下述循环：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">compiler_factorial</span><span class="params">(<span class="type">int</span> val)</span> </span>&#123;</span><br><span class="line">  <span class="type">int</span> temp = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">2</span>; i &lt;= val; ++i)</span><br><span class="line">    temp *= i;</span><br><span class="line">  <span class="keyword">return</span> temp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>理论上是觉得可以按照如下LLVM IR的写法：</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">define i32 @factoriali(i32 %val) &#123;</span><br><span class="line"><span class="symbol">entry:</span></span><br><span class="line">  %i = <span class="keyword">add</span> i32 <span class="number">0</span>, <span class="number">2</span></span><br><span class="line">  %temp = <span class="keyword">add</span> i32 <span class="number">0</span>, <span class="number">1</span></span><br><span class="line"><span class="symbol">  br label</span> %check_for_condition</span><br><span class="line"><span class="symbol">check_for_condition:</span>                                           </span><br><span class="line">  %i_leq_val = icmp sle i32 %i, %val</span><br><span class="line">  br i1 %i_leq_val, label %for_body, label %end_loop</span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">for_body:</span>                                               </span><br><span class="line">  %temp = <span class="keyword">mul</span> i32 %temp, %i</span><br><span class="line">  %i = <span class="keyword">add</span> i32 %i, <span class="number">1</span></span><br><span class="line"><span class="symbol">  br label</span> %check_for_condition</span><br><span class="line"><span class="symbol">  </span></span><br><span class="line"><span class="symbol">end_loop:</span></span><br><span class="line">  <span class="keyword">ret</span> i32 %temp</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但实际上<code>%temp</code>和<code>%i</code>被赋值了很多次，此时需要<code>phi</code>语句，该语句从上一个执行的basic
block中选择变量的值。</p>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;result&gt; = phi &lt;ty&gt; [&lt;val0&gt;, &lt;label0&gt;], [&lt;val1&gt;, &lt;label1&gt;] ...</span><br></pre></td></tr></table></figure>
<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">define i32 @factoriali(i32 %val) &#123;</span><br><span class="line"><span class="symbol">entry:</span></span><br><span class="line"><span class="symbol">  br label</span> %check_for_condition</span><br><span class="line"><span class="symbol">check_for_condition:</span>                                           </span><br><span class="line">  %current_i = phi i32 [ <span class="number">2</span>, %entry ], [ %i_plus_one, %for_body ]</span><br><span class="line">  %temp      = phi i32 [ <span class="number">1</span>, %entry ], [ %new_temp, %for_body ]</span><br><span class="line">  %i_leq_val = icmp sle i32 %current_i, %val</span><br><span class="line">  br i1 %i_leq_val, label %for_body, label %end_loop</span><br><span class="line"><span class="symbol"></span></span><br><span class="line"><span class="symbol">for_body:</span>                                               </span><br><span class="line">  %new_temp = <span class="keyword">mul</span> nsw i32 %temp, %current_i</span><br><span class="line">  %i_plus_one = <span class="keyword">add</span> i32 %current_i, <span class="number">1</span></span><br><span class="line"><span class="symbol">  br label</span> %check_for_condition</span><br><span class="line"><span class="symbol">  </span></span><br><span class="line"><span class="symbol">end_loop:</span></span><br><span class="line">  <span class="keyword">ret</span> i32 %temp</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="mac配置llvm">3. Mac配置LLVM</h3>
<p>https://www.ctolib.com/topics-118972.html</p>
<p>https://www.jianshu.com/p/b48c1b482c82</p>
<p>https://blog.51cto.com/6095891/2348778</p>
<h4 id="xcode编译llvm-project">3.1 Xcode编译LLVM Project</h4>
<p>下载<a
target="_blank" rel="noopener" href="https://github.com/llvm/llvm-project/releases/download/llvmorg-11.0.0/llvm-11.0.0.src.tar.xz">LLVM</a>和<a
target="_blank" rel="noopener" href="https://github.com/llvm/llvm-project/releases/download/llvmorg-11.0.0/clang-11.0.0.src.tar.xz">Clang</a>并解压，将Clang目录放置到llvm/tools目录下，llvm-10.0.0无法编译通过，选择llvm-11.0.0。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tar -xzvf llvm-11.0.0.src.tar.xz</span><br><span class="line">tar -xzvf clang-11.0.0.src.tar.xz</span><br></pre></td></tr></table></figure>
<p>从官网下载<a
target="_blank" rel="noopener" href="https://github.com/Kitware/CMake/releases/download/v3.19.2/cmake-3.19.2-macos-universal.dmg">.dmg</a>文件，安装cmake，配置环境变量。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$&gt; <span class="built_in">which</span> cmake</span><br><span class="line">/Applications/CMake.app/Contents/bin/cmake</span><br></pre></td></tr></table></figure>
<p>进入llvm目录，新建build目录，进入build目录执行cmake生成配置文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> build</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake -G Xcode CMAKE_BUILD_TYPE=<span class="string">&quot;Debug&quot;</span> ..</span><br></pre></td></tr></table></figure>
<p>点击build目录下的LLVM.xcodeproj工程文件，提示是否自动创建schemes，点击manually
manage schemes手动创建，并添加ALL_BUILD，如下图。</p>
<p><img src="https://i.loli.net/2021/01/09/Y5XfyPxaQGcSgEu.png" alt="开发和调试第一个 LLVM Pass" style="zoom: 45%;" /></p>
<p>在Xcode中编译llvm，全程约半个小时。</p>
<figure>
<img src="https://i.loli.net/2021/01/09/ztK5RETxmkU71w4.png"
alt="image-20210109165627072" />
<figcaption aria-hidden="true">image-20210109165627072</figcaption>
</figure>
<p>Tips: <a
target="_blank" rel="noopener" href="https://www.cnblogs.com/LittleSec/p/12757964.html">macOS使用源码build的clang无法编译c/cpp的问题:
fatal error: 'stdio.h' file not found</a></p>
<h4 id="xcode编译llvm-pass">3.2 Xcode编译LLVM Pass</h4>
<p>若要再添加新的LLVM
Pass，需要将代码放置到<code>lib/Transform</code>目录下后，将下面信息加入<code>llvm/lib/Transforms/CMakeLists.txt</code>中。</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_subdirectory</span>(SRPass)</span><br></pre></td></tr></table></figure>
<p>重新进入<code>build</code>的目录执行<code>cmake</code>命令，然后再次加载Xcode
Project文件，会看到新的LLVM Pass已经加载到了工程中。</p>
<p><img src="https://i.loli.net/2021/01/11/RgknqFWA9MYb1zo.png" alt="image-20210111224621797" style="zoom:40%;" /></p>
<p>选择Manage Schemes，将新的LLVM Pass设置为Scheme，编译LLVM
Pass，生成的dylib在<code>build/Debug/lib/</code>目录下。</p>
<p><img src="https://i.loli.net/2021/01/11/UaYyz6nJcw9EIhT.png" alt="image-20210111234433374" style="zoom:70%;" /></p>
<p>给定如下程序<code>test.cpp</code>，首先编译为llvm bitcode。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span>* a = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">10</span>];</span><br><span class="line">    a[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (a[argc])</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;xx\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用opt运行LLVM Pass如下，运行成功。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># https://www.cs.cornell.edu/~asampson/blog/clangpass.html</span></span><br><span class="line"><span class="comment">#include &quot;llvm/IR/LegacyPassManager.h&quot;</span></span><br><span class="line"><span class="comment">#include &quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;</span></span><br><span class="line">clang++ -gline-tables-only -flto -fsanitize=address -c test.cpp -o test.orig.bc -isysroot `xcrun --show-sdk-path`</span><br><span class="line"></span><br><span class="line">opt -load SRPass.dylib -dcc -o test.cov.o test.orig.bc</span><br><span class="line"></span><br><span class="line"><span class="comment"># clang++要和opt是一起编译出来的才行</span></span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2021/01/11/SmCxYaDPkpn3r85.png" alt="image-20210111234620100" style="zoom:47%;" /></p>
<h4 id="xcode-调试-llvm-pass">3.3 Xcode 调试 LLVM Pass</h4>
<p>用opt为target来调试这个Pass，Xcode中添加opt的目标文件到scheme中。</p>
<p><img src="https://i.loli.net/2021/01/11/MKa2EV48fY6kXFl.png" alt="image-20210111235014164" style="zoom:77%;" /></p>
<p>编辑scheme的启动参数，和命令行中的保持一致。</p>
<p><img src="https://i.loli.net/2021/01/11/BX4GxdHpnb9zCuS.png" alt="image-20210111235127009" style="zoom:77%;" /></p>
<p>command+r运行，在<code>DynamicCallCounter.cpp</code>的函数<code>runOnModule</code>中加入断点，就可以调试LLVM
Pass了。</p>
<p><img src="https://i.loli.net/2021/01/12/5klbasJQOiz6IAC.png" alt="image-20210112001157315" style="zoom:67%;" /></p>
<p>为了在执行 opt 时能自动检测
Pass有没有被修改，若修改则重新编译，可以把 <code>SRPass</code> 加到 opt
的依赖里面，编辑 tools/opt/CMakeLists.txt如下：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">add_llvm_tool(opt</span><br><span class="line">  AnalysisWrappers.cpp</span><br><span class="line">  BreakpointPrinter.cpp</span><br><span class="line">  GraphPrinters.cpp</span><br><span class="line">  NewPMDriver.cpp</span><br><span class="line">  PassPrinters.cpp</span><br><span class="line">  PrintSCC.cpp</span><br><span class="line">  opt.cpp</span><br><span class="line"></span><br><span class="line">  DEPENDS</span><br><span class="line">  intrinsics_gen</span><br><span class="line">  SRPass</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<h3 id="ubuntu配置llvm">4. Ubuntu配置LLVM</h3>
<h4 id="ubuntu编译llvm-project">4.1 Ubuntu编译LLVM Project</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">svn co http://llvm.org/svn/llvm-project/llvm/tags/RELEASE_900/final llvm</span><br><span class="line"><span class="built_in">cd</span> llvm/tools</span><br><span class="line">svn co http://llvm.org/svn/llvm-project/cfe/tags/RELEASE_900/final clang</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"><span class="built_in">cd</span> tools/clang/tools</span><br><span class="line">svn co http://llvm.org/svn/llvm-project/clang-tools-extra/tags/RELEASE_900/final extra</span><br><span class="line"><span class="built_in">cd</span> ../../..</span><br><span class="line"><span class="built_in">cd</span> projects</span><br><span class="line">svn co http://llvm.org/svn/llvm-project/compiler-rt/tags/RELEASE_900/final compiler-rt</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"><span class="built_in">cd</span> projects</span><br><span class="line">svn co http://llvm.org/svn/llvm-project/libcxx/tags/RELEASE_900/final libcxx</span><br><span class="line">svn co http://llvm.org/svn/llvm-project/libcxxabi/tags/RELEASE_900/final libcxxabi</span><br><span class="line"><span class="built_in">cd</span> ..</span><br><span class="line"><span class="built_in">mkdir</span> bulid</span><br><span class="line"><span class="built_in">cd</span> build</span><br><span class="line">cmake -G <span class="string">&quot;Unix Makefiles&quot;</span> -DCMAKE_BUILD_TYPE=Release -DLLVM_TARGETS_TO_BUILD=<span class="string">&quot;X86&quot;</span> ..</span><br><span class="line">make -j 12</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<h4 id="命令行编译llvm-pass">4.2 命令行编译LLVM Pass</h4>
<p>Move the source code of SanRazor into your llvm project:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mv</span> src/SRPass llvm/lib/Transforms/</span><br><span class="line"><span class="built_in">mv</span> src/SmallPtrSet.h llvm/include/llvm/ADT/</span><br></pre></td></tr></table></figure>
<p>Add the following command to <code>CMakeLists.txt</code> under
<code>llvm/lib/Transforms</code>:</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">add_subdirectory</span><span class="params">(SRPass)</span></span></span><br></pre></td></tr></table></figure>
<p>Compile your llvm project again:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> llvm/build</span><br><span class="line">make -j 12</span><br></pre></td></tr></table></figure>
<p>How to run a LLVM Pass</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opt -load SRPass.so -hello &lt; hello.bc</span><br></pre></td></tr></table></figure>
<p>or</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -Xclang -load -Xclang SRPass.so ...</span><br></pre></td></tr></table></figure>
<p>How to get the option of LLVM Pass</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">opt -load SRPass.so -<span class="built_in">help</span></span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2021/01/11/v6W9y7Q83pGcjFl.png" alt="image-20210111150707330" style="zoom:67%;" /></p>
<h4 id="clion编译llvm-pass">4.3 Clion编译LLVM Pass</h4>
<p>修改clion的环境变量
https://llvm.org/docs/CMake.html#cmake-out-of-source-pass</p>
<p><img src="https://i.loli.net/2021/01/11/ENtIQYoGUuph6PX.png" alt="image-20210111205335982" style="zoom:67%;" /></p>
<p>在CMakeList.txt中加入如下语句
https://ld246.com/article/1541748937641</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.17</span>)</span><br><span class="line"><span class="keyword">find_package</span>(LLVM <span class="number">9</span> REQUIRED CONFIG)</span><br><span class="line"><span class="keyword">project</span>(SRPass)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_definitions</span>(<span class="variable">$&#123;LLVM_DEFINITIONS&#125;</span>)</span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">$&#123;LLVM_INCLUDE_DIRS&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">list</span>(APPEND CMAKE_MODULE_PATH <span class="string">&quot;$&#123;LLVM_CMAKE_DIR&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">include</span>(AddLLVM)</span><br><span class="line"><span class="keyword">link_directories</span>(<span class="variable">$&#123;LLVM_LIBRARY_DIRS&#125;</span>)</span><br></pre></td></tr></table></figure>
<p>Reload cmake file, then compile it.</p>
<p><img src="https://i.loli.net/2021/01/11/Q7SUNhd96AgRWLb.png" alt="image-20210111214459943" style="zoom:67%;" /></p>
<p>或者按照以下目录</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">├── CMakeLists<span class="selector-class">.txt</span></span><br><span class="line">├── README<span class="selector-class">.md</span></span><br><span class="line">└── skeleton</span><br><span class="line">    ├── CMakeLists<span class="selector-class">.txt</span></span><br><span class="line">    └── Skeleton.cpp</span><br></pre></td></tr></table></figure>
<p>在根目录下的 <code>CMakeLists.txt</code> 内容如下：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">sk in llvm-detectDataPass/skeleton at Lab <span class="keyword">on</span>  master</span><br><span class="line">➜ cat CMakeLists.txt</span><br><span class="line"><span class="keyword">cmake_minimum_required</span>(VERSION <span class="number">3.4</span>)</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">NOT</span> <span class="keyword">DEFINED</span> ENV&#123;LLVM_HOME&#125;)</span><br><span class="line">    <span class="keyword">message</span>(FATAL_ERROR <span class="string">&quot;$LLVM_HOME is not defined&quot;</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">NOT</span> <span class="keyword">DEFINED</span> ENV&#123;LLVM_DIR&#125;)</span><br><span class="line">    <span class="keyword">set</span>(ENV&#123;LLVM_DIR&#125; $ENV&#123;LLVM_HOME&#125;/lib/cmake/llvm)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">find_package</span>(LLVM REQUIRED CONFIG)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_definitions</span>(<span class="variable">$&#123;LLVM_DEFINITIONS&#125;</span>)</span><br><span class="line"><span class="keyword">include_directories</span>(<span class="variable">$&#123;LLVM_INCLUDE_DIRS&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">add_subdirectory</span>(skeleton)  <span class="comment"># Use your pass name here.</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">list</span>(APPEND CMAKE_MODULE_PATH <span class="string">&quot;$&#123;LLVM_CMAKE_DIR&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">include</span>(AddLLVM)</span><br></pre></td></tr></table></figure>
<p>在 Pass 目录的 <code>CMakeLists.txt</code> 的内容如下所示：</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">add_llvm_library(SkeletonPass MODULE</span><br><span class="line">        <span class="comment"># List your source files here.</span></span><br><span class="line">        Skeleton.cpp</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line"><span class="comment">## Use C++11 to compile your pass (i.e., supply -std=c++11).</span></span><br><span class="line"><span class="keyword">target_compile_features</span>(SkeletonPass PRIVATE cxx_range_for cxx_auto_type)</span><br><span class="line"></span><br><span class="line"><span class="comment"># LLVM is (typically) built with no C++ RTTI. We need to match that;</span></span><br><span class="line"><span class="comment"># otherwise, we&#x27;ll get linker errors about missing RTTI data.</span></span><br><span class="line"><span class="keyword">set_target_properties</span>(SkeletonPass PROPERTIES</span><br><span class="line">        COMPILE_FLAGS <span class="string">&quot;-D__GLIBCXX_USE_CXX11_ABI=0 -fno-rtti&quot;</span></span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<h4 id="clion调试llvm-pass">4.4 Clion调试LLVM Pass</h4>
<p>在Clion中加载整个LLVM项目，load最顶层的<code>CMakeList.txt</code>，首先选择SRPass为编译目标，编译出<code>SRPass.so</code>。</p>
<p><img src="https://i.loli.net/2021/01/12/nwErFPyhx3VReQ7.png" alt="image-20210112003019185" style="zoom:50%;" /></p>
<p>编译出的so文件在<code>cmake-build-debug/lib/SRPass.so</code>中。将<code>test.cpp</code>程序编译成LLVM
bitcode</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">build/bin/clang++ -gline-tables-only -flto -fsanitize=address -c test.cpp -o test.orig.bc</span><br><span class="line"></span><br><span class="line">opt -load cmake-build-debug/lib/SRPass.so -dcc -o test.cov.o test.orig.bc</span><br></pre></td></tr></table></figure>
<p>然后选择<code>opt</code>为编译目标，配置其运行参数如上，在<code>runOnModel</code>函数上打断点，编译运行调试opt。</p>
<p><img src="https://i.loli.net/2021/01/12/vt4S7Wic2a6z8JT.png" alt="image-20210112003618457" style="zoom:40%;" /></p>
<p>程序停在断点处，调试成功。</p>
<figure>
<img src="https://i.loli.net/2021/01/12/qjnOP3yTfcxR2K4.png"
alt="image-20210112014730638" />
<figcaption aria-hidden="true">image-20210112014730638</figcaption>
</figure>
<h4 id="命令行编译单个llvm-pass文件">4.5 命令行编译单个LLVM
Pass文件</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ clang++ -c Hello.cpp `llvm-config --cxxflags` -fPIC</span><br><span class="line">$ clang++ -shared -o Hello.so Hello.o `llvm-config --ldflags`</span><br><span class="line">$ <span class="built_in">ls</span></span><br><span class="line">CMakeLists.txt  Hello.cpp  Hello.exports  Hello.o  Hello.so</span><br><span class="line">$ vim test.cpp</span><br><span class="line">$ clang -c -emit-llvm test.cpp</span><br><span class="line">$ opt -load ./Hello.so -hello ./test.bc</span><br><span class="line">WARNING: You<span class="string">&#x27;re attempting to print out a bitcode file.</span></span><br><span class="line"><span class="string">This is inadvisable as it may cause display problems. If</span></span><br><span class="line"><span class="string">you REALLY want to taste LLVM bitcode first-hand, you</span></span><br><span class="line"><span class="string">can force output with the `-f&#x27;</span> option.</span><br><span class="line"></span><br><span class="line">Hello: main</span><br></pre></td></tr></table></figure>
<p><code>llvm-config</code>提供了<code>CXXFLAGS</code>与<code>LDFLAGS</code>参数方便查找LLVM的头文件与库文件。
如果链接有问题，还可以用<code>llvm-config --libs</code>提供动态链接的LLVM库。
<code>-fPIC -shared</code> 显然是编译动态库的必要参数。</p>
<h3 id="write-llvm-pass">5. Write LLVM Pass</h3>
<p>Pass编写 https://www.leadroyal.cn/?p=719</p>
<p>AFL也是一个LLVM Pass https://zhuanlan.zhihu.com/p/122522485</p>
<p>继承现有的Pass的类：All LLVM passes are subclasses of the <a
target="_blank" rel="noopener" href="https://llvm.org/doxygen/classllvm_1_1Pass.html">Pass</a> class,
which implement functionality by overriding virtual methods inherited
from <code>Pass</code>. Depending on how your pass works, you should
inherit from the <a
target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMPass.html#writing-an-llvm-pass-modulepass">ModulePass</a>
, <a
target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMPass.html#writing-an-llvm-pass-callgraphsccpass">CallGraphSCCPass</a>,
<a
target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMPass.html#writing-an-llvm-pass-functionpass">FunctionPass</a>
, or <a
target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMPass.html#writing-an-llvm-pass-looppass">LoopPass</a>,
or <a
target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMPass.html#writing-an-llvm-pass-regionpass">RegionPass</a>
classes, which gives the system more information about what your pass
does, and how it can be combined with other passes. One of the main
features of the LLVM Pass Framework is that it schedules passes to run
in an efficient way based on the constraints that your pass meets (which
are indicated by which class they derive from).</p>
<p>Configure and build LLVM, put your code under directory
<code>llvm/lib/Transforms/Hello</code>, add the following cmake file to
compile the source code into a shared object
<code>lib/LLVMHello.so</code>. This file can be dynamically loaded by
the opt tool via <code>-load</code> option.</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">add_llvm_library( LLVMHello MODULE</span><br><span class="line">  Hello.cpp</span><br><span class="line"></span><br><span class="line">  PLUGIN_TOOL</span><br><span class="line">  opt</span><br><span class="line">  )</span><br></pre></td></tr></table></figure>
<p>Write the code <code>Hello.cpp</code>. Start out with several header
files. This pass operates on functions.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Pass.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Function.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Support/raw_ostream.h&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>Next we have the following code, which is required because the
functions from the include files live in the llvm namespace.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br></pre></td></tr></table></figure>
<p>Then we start out an anonymous namespace. Anonymous namespaces are to
C++ what the “<code>static</code>” keyword is to C (at global scope). It
makes the things declared inside of the anonymous namespace visible only
to the current file.</p>
<p>Next we declare our own class <code>Hello</code> which is a subclass
of <code>FunctionPass</code>. This class operates on a function at a
time. This declares pass identifier used by LLVM to identify pass. This
allows LLVM to avoid using expensive C++ runtime information. We declare
a <a
target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMPass.html#writing-an-llvm-pass-runonfunction">runOnFunction</a>
method, which overrides an abstract virtual method inherited from <a
target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMPass.html#writing-an-llvm-pass-functionpass">FunctionPass</a>.
This is where we are supposed to do our thing, so we just print out our
message with the name of each function.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> &#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">Hello</span> : <span class="keyword">public</span> FunctionPass &#123;</span><br><span class="line">        <span class="type">static</span> <span class="type">char</span> ID;</span><br><span class="line">        <span class="built_in">Hello</span>() : <span class="built_in">FunctionPass</span>(ID) &#123;&#125;</span><br><span class="line">        <span class="function"><span class="type">bool</span> <span class="title">runOnFunction</span><span class="params">(Function &amp;F)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">            <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;Hello: &quot;</span>;</span><br><span class="line">            <span class="built_in">errs</span>().<span class="built_in">write_escaped</span>(F.<span class="built_in">getName</span>()) &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;; <span class="comment">// end of struct Hello</span></span><br><span class="line">&#125;  <span class="comment">// end of anonymous namespace</span></span><br></pre></td></tr></table></figure>
<p>We initialize pass ID here. LLVM uses ID’s address to identify a
pass, so initialization value is not important. Lastly, we <a
target="_blank" rel="noopener" href="https://llvm.org/docs/WritingAnLLVMPass.html#writing-an-llvm-pass-registration">register
our class</a> <code>Hello</code>, giving it a command line argument
“<code>hello</code>”, and a name “Hello World Pass”. The last two
arguments describe its behavior: if a pass walks CFG without modifying
it then the third argument is set to <code>true</code>; if a pass is an
analysis pass, for example dominator tree pass, then <code>true</code>
is supplied as the fourth argument.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> Hello::ID = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Register for opt</span></span><br><span class="line"><span class="function"><span class="type">static</span> RegisterPass&lt;Hello&gt; <span class="title">X</span><span class="params">(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;Hello World Pass&quot;</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="literal">false</span> <span class="comment">/* Only looks at CFG */</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="literal">false</span> <span class="comment">/* Analysis Pass */</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>If we want to register the pass as a step of an existing pipeline,
some extension points are provided, e.g.
<code>PassManagerBuilder::EP_EarlyAsPossible</code> to apply our pass
before any optimization, or
<code>PassManagerBuilder::EP_FullLinkTimeOptimizationLast</code> to
apply it after Link Time Optimizations.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Register for clang</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/LegacyPassManager.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> llvm::RegisterStandardPasses <span class="title">Y</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    llvm::PassManagerBuilder::EP_EarlyAsPossible,</span></span></span><br><span class="line"><span class="params"><span class="function">    [](<span class="type">const</span> llvm::PassManagerBuilder &amp;Builder,</span></span></span><br><span class="line"><span class="params"><span class="function">       llvm::legacy::PassManagerBase &amp;PM) &#123; PM.add(<span class="keyword">new</span> Hello()); &#125;)</span></span>;</span><br></pre></td></tr></table></figure>
<p><code>static RegisterPass&lt;Hello&gt; X</code>是给opt加载Pass用的，
<code>static RegisterStandardPasses Y</code>是给clang加载Pass用的，
若使用<code>opt</code>加载Pass，则只需要<code>X</code>，若使用<code>clang</code>加载Pass，则两个都需要。</p>
<p>如果在编写的Pass中需要使用到其它Pass提供的函数功能，需要在函数<code>getAnalysisUsage</code>中说明，比如像要获取程序中存在循环的信息，可以在该函数里面申请需要依赖的Pass是<code>LoopInfoWrapperPass</code>，导入相应头文件，并在
getAnalysisUsage 中写下如下语句：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">getAnalysisUsage</span><span class="params">(AnalysisUsage &amp;AU)</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Analysis/LoopInfo.h&quot;</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">getAnalysisUsage</span><span class="params">(AnalysisUsage&amp; AU)</span> <span class="type">const</span> </span>&#123;</span><br><span class="line">    AU.<span class="built_in">addRequired</span>&lt;LoopInfoWrapperPass&gt;();</span><br><span class="line">	AU.<span class="built_in">setPreservesAll</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后就可以通过它提供接口获取存在循环的个数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LoopInfo &amp;LI = <span class="built_in">getAnalysis</span>&lt;LoopInfoWrapperPass&gt;().<span class="built_in">getLoopInfo</span>();</span><br><span class="line"><span class="type">int</span> loopCounter = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (LoopInfo::iterator i = LI.<span class="built_in">begin</span>(), e = LI.<span class="built_in">end</span>(); i != e; ++i) &#123;</span><br><span class="line">    loopCounter++;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;loop num:&quot;</span> &lt;&lt; loopCounter &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br></pre></td></tr></table></figure>
<h3 id="read-llvm-pass">6. Read LLVM Pass</h3>
<p>https://llvm.org/docs/ProgrammersManual.html</p>
<p>https://llvm.org/docs/ProgrammersManual.html#helpful-hints-for-common-operations</p>
<p>https://llvm.org/docs/ProgrammersManual.html#the-core-llvm-class-hierarchy-reference</p>
<p>https://github.com/imdea-software/LLVM_Instrumentation_Pass/blob/master/InstrumentFunctions/Pass.cpp</p>
<h4 id="例子1">6.1 例子1</h4>
<p>查看文件中有没有main函数，如果没有main函数就创建main函数并调用所有模块中的其他函数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Pass.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/IRBuilder.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/IntrinsicInst.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/LegacyPassManager.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> llvm &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">SimpleInvoker</span>: <span class="keyword">public</span> ModulePass &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="type">static</span> <span class="type">char</span> ID;</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">SimpleInvoker</span>() : <span class="built_in">ModulePass</span>(ID) &#123;&#125;</span><br><span class="line">        <span class="function"><span class="type">bool</span> <span class="title">runOnModule</span><span class="params">(Module &amp;M)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!M.<span class="built_in">getFunction</span>(<span class="string">&quot;main&quot;</span>)) &#123; <span class="comment">// 是否有main函数</span></span><br><span class="line">                <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;Main Function Not Found! So create.\n&quot;</span>;</span><br><span class="line">                <span class="comment">// 创建main函数类型</span></span><br><span class="line">                FunctionType *FT = FunctionType::<span class="built_in">get</span>(Type::<span class="built_in">getInt32Ty</span>(M.<span class="built_in">getContext</span>()), <span class="literal">false</span>);</span><br><span class="line">                <span class="comment">// 根据类型创建函数</span></span><br><span class="line">                Function *F = Function::<span class="built_in">Create</span>(FT, GlobalVariable::LinkageTypes::ExternalLinkage, <span class="string">&quot;main&quot;</span>, &amp;M);</span><br><span class="line">                <span class="comment">// 创建main函数的entry basic block</span></span><br><span class="line">                BasicBlock *EntryBB = BasicBlock::<span class="built_in">Create</span>(M.<span class="built_in">getContext</span>(), <span class="string">&quot;EntryBlock&quot;</span>, F);</span><br><span class="line">                IRBuilder&lt;&gt; <span class="built_in">IRB</span>(EntryBB);</span><br><span class="line">                <span class="keyword">for</span> (Function &amp;FF: M) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (FF.<span class="built_in">getName</span>() == <span class="string">&quot;main&quot;</span>)</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="keyword">if</span> (FF.<span class="built_in">empty</span>())</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    <span class="comment">// 调用模块中其余函数</span></span><br><span class="line">                    IRB.<span class="built_in">CreateCall</span>(&amp;FF);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//为main函数添加return 0</span></span><br><span class="line">                IRB.<span class="built_in">CreateRet</span>(ConstantInt::<span class="built_in">get</span>(Type::<span class="built_in">getInt32Ty</span>(M.<span class="built_in">getContext</span>()), <span class="number">0</span>));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    </span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> SimpleInvoker::ID = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> RegisterPass&lt;SimpleInvoker&gt; <span class="title">Y</span><span class="params">(<span class="string">&quot;showname&quot;</span>, <span class="string">&quot;&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="例子二">6.2 例子二</h4>
<p>输出栈上和全局的字符串。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Pass.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/IRBuilder.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/IntrinsicInst.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">declarePrintf</span><span class="params">(Function &amp;F)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">insertRodata</span><span class="params">(Function &amp;F)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">insertData</span><span class="params">(Function &amp;F)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">insertStack</span><span class="params">(Function &amp;F)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> llvm &#123;</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">ShowName</span>: <span class="keyword">public</span> FunctionPass &#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="type">static</span> <span class="type">char</span> ID;</span><br><span class="line">        <span class="built_in">ShowName</span>() : <span class="built_in">FunctionPass</span>(ID) &#123;&#125;</span><br><span class="line">        <span class="function"><span class="type">bool</span> <span class="title">runOnFunction</span><span class="params">(Function &amp;F)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">            <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;enter ShowName&quot;</span> &lt;&lt; F.<span class="built_in">getName</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">            <span class="built_in">declarePrintf</span>(F);</span><br><span class="line">            <span class="built_in">insertRodata</span>(F);</span><br><span class="line">            <span class="built_in">insertData</span>(F);</span><br><span class="line">            <span class="built_in">insertStack</span>(F);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> ShowName::ID = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="type">static</span> RegisterPass&lt;ShowName&gt; <span class="title">Y</span><span class="params">(<span class="string">&quot;showname&quot;</span>, <span class="string">&quot;&quot;</span>)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">declarePrintf</span><span class="params">(Function &amp;F)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取print函数</span></span><br><span class="line">    Function *func_printf = F.<span class="built_in">getParent</span>()-&gt;<span class="built_in">getFunction</span>(<span class="string">&quot;printf&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!func_printf) &#123;</span><br><span class="line">        <span class="comment">// 如果没有print函数就声明printf函数，同样先定义函数类型，再创建相应函数。</span></span><br><span class="line">        FunctionType *FT = FunctionType::<span class="built_in">get</span>(Type::<span class="built_in">getInt8Ty</span>(F.<span class="built_in">getContext</span>()), <span class="literal">true</span>);</span><br><span class="line">        Function::<span class="built_in">Create</span>(FT, Function::ExternalLinkage, <span class="string">&quot;printf&quot;</span>, F.<span class="built_in">getParent</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">insertRodata</span><span class="params">(Function &amp;F)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取entry block</span></span><br><span class="line">    BasicBlock *entryBlock = &amp;F.<span class="built_in">getEntryBlock</span>();</span><br><span class="line">    <span class="comment">// 创建一个名为printfRodataBlock的空Block</span></span><br><span class="line">    BasicBlock *printfBlock = BasicBlock::<span class="built_in">Create</span>(F.<span class="built_in">getContext</span>(), <span class="string">&quot;printfRodataBlock&quot;</span>, &amp;F, entryBlock);</span><br><span class="line">    string function_string = <span class="string">&quot;Function &quot;</span>;</span><br><span class="line">    function_string += F.<span class="built_in">getName</span>();</span><br><span class="line">    function_string += <span class="string">&quot;is invoked! @rodata\n&quot;</span>;</span><br><span class="line">    IRBuilder&lt;&gt; <span class="built_in">IRB</span>(printfBlock);</span><br><span class="line">    <span class="comment">// 获取printf函数</span></span><br><span class="line">    Function *func_printf = F.<span class="built_in">getParent</span>()-&gt;<span class="built_in">getFunction</span>(<span class="string">&quot;printf&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!func_printf)</span><br><span class="line">        <span class="built_in">assert</span>(<span class="literal">false</span> &amp;&amp; <span class="string">&quot;printf not found&quot;</span>);</span><br><span class="line">    <span class="comment">// 创建一个全局字符串function_strings</span></span><br><span class="line">    Value *str = IRB.<span class="built_in">CreateGlobalStringPtr</span>(function_string);</span><br><span class="line">    <span class="comment">// 调用printf，以str为参数</span></span><br><span class="line">    IRB.<span class="built_in">CreateCall</span>(func_printf, &#123;str&#125;);</span><br><span class="line">    <span class="comment">// 给当前block添加terminator语句为结尾</span></span><br><span class="line">    IRB.<span class="built_in">CreateBr</span>(entryBlock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">insertData</span><span class="params">(Function &amp;F)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取entry block</span></span><br><span class="line">    BasicBlock *entryBlock = &amp;F.<span class="built_in">getEntryBlock</span>();</span><br><span class="line">    <span class="comment">// 创建一个名为printfDataBlock的空Block</span></span><br><span class="line">    BasicBlock *printfBlock = BasicBlock::<span class="built_in">Create</span>(F.<span class="built_in">getContext</span>(), <span class="string">&quot;printfDataBlock&quot;</span>, &amp;F, entryBlock);</span><br><span class="line">    string function_string = <span class="string">&quot;Function &quot;</span>;</span><br><span class="line">    function_string += F.<span class="built_in">getName</span>();</span><br><span class="line">    function_string += <span class="string">&quot; is invoked! @data\n&quot;</span>;</span><br><span class="line">    IRBuilder&lt;&gt; <span class="built_in">IRB</span>(printfBlock);</span><br><span class="line">    <span class="comment">// 获取printf函数</span></span><br><span class="line">    Function *func_printf = F.<span class="built_in">getParent</span>()-&gt;<span class="built_in">getFunction</span>(<span class="string">&quot;printf&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!func_printf)</span><br><span class="line">        <span class="built_in">assert</span>(<span class="literal">false</span> &amp;&amp; <span class="string">&quot;printf not found&quot;</span>);</span><br><span class="line">    <span class="comment">// 创建全局字符串function_strings</span></span><br><span class="line">    GlobalVariable *GV = IRB.<span class="built_in">CreateGlobalString</span>(function_string);</span><br><span class="line">    <span class="comment">// 使其变成非constant</span></span><br><span class="line">    GV-&gt;<span class="built_in">setConstant</span>(<span class="literal">false</span>);</span><br><span class="line">    <span class="comment">// 创建一个0</span></span><br><span class="line">    Constant *Zero = ConstantInt::<span class="built_in">get</span>(Type::<span class="built_in">getInt32Ty</span>(F.<span class="built_in">getContext</span>()), <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 创建一个二级索引</span></span><br><span class="line">    Constant *Indices[] = &#123;Zero, Zero&#125;;</span><br><span class="line">    <span class="comment">// 获取指向字符串第一个元素的指针</span></span><br><span class="line">    Value *str = ConstantExpr::<span class="built_in">getInBoundsGetElementPtr</span>(GV-&gt;<span class="built_in">getValueType</span>(), GV, Indices);</span><br><span class="line">    <span class="comment">// 调用printf，以str为参数</span></span><br><span class="line">    IRB.<span class="built_in">CreateCall</span>(func_printf, &#123;str&#125;);</span><br><span class="line">    <span class="comment">// 给当前block添加terminator语句为结尾</span></span><br><span class="line">    IRB.<span class="built_in">CreateBr</span>(entryBlock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">insertStack</span><span class="params">(Function &amp;F)</span> </span>&#123;</span><br><span class="line">    BasicBlock *entryBlock = &amp;F.<span class="built_in">getEntryBlock</span>();</span><br><span class="line">    BasicBlock *printfBlock = BasicBlock::<span class="built_in">Create</span>(F.<span class="built_in">getContext</span>(), <span class="string">&quot;printfStackBlock&quot;</span>, &amp;F, entryBlock);</span><br><span class="line">    string function_string = <span class="string">&quot;Function &quot;</span>;</span><br><span class="line">    function_string += F.<span class="built_in">getName</span>();</span><br><span class="line">    function_string += <span class="string">&quot; is invoked! @stack\n&quot;</span>;</span><br><span class="line">    IRBuilder&lt;&gt; <span class="built_in">IRB</span>(printfBlock);</span><br><span class="line">    Function *func_printf = F.<span class="built_in">getParent</span>()-&gt;<span class="built_in">getFunction</span>(<span class="string">&quot;printf&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!func_printf)</span><br><span class="line">        <span class="built_in">assert</span>(<span class="literal">false</span> &amp;&amp; <span class="string">&quot;printf not found&quot;</span>);</span><br><span class="line">    <span class="comment">// 创建0</span></span><br><span class="line">    Value *Zero = ConstantInt::<span class="built_in">get</span>(Type::<span class="built_in">getInt8Ty</span>(F.<span class="built_in">getContext</span>()), <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 创建长度function_string.size() + 1</span></span><br><span class="line">    Value *Size = ConstantInt::<span class="built_in">get</span>(Type::<span class="built_in">getInt64Ty</span>(F.<span class="built_in">getContext</span>()), function_string.<span class="built_in">size</span>() + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 创建布尔值false</span></span><br><span class="line">    Value *Bool = ConstantInt::<span class="built_in">get</span>(Type::<span class="built_in">getInt1Ty</span>(F.<span class="built_in">getContext</span>()), <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建一个array类型</span></span><br><span class="line">    ArrayType *arrayType = ArrayType::<span class="built_in">get</span>(IntegerType::<span class="built_in">getInt8Ty</span>(F.<span class="built_in">getContext</span>()), function_string.<span class="built_in">size</span>() + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// 找到memset这个函数</span></span><br><span class="line">    Function *func_memset = Intrinsic::<span class="built_in">getDeclaration</span>(F.<span class="built_in">getParent</span>(), Intrinsic::memset, &#123;IntegerType::<span class="built_in">getInt8PtrTy</span>(F.<span class="built_in">getContext</span>()), IntegerType::<span class="built_in">getInt64Ty</span>(F.<span class="built_in">getContext</span>())&#125;);</span><br><span class="line">    <span class="comment">// 在栈上开辟arrayType类型的局部变量</span></span><br><span class="line">    AllocaInst *alloc = IRB.<span class="built_in">CreateAlloca</span>(arrayType);</span><br><span class="line">    alloc-&gt;<span class="built_in">setAlignment</span>(<span class="number">16</span>);</span><br><span class="line">    <span class="comment">// 获取该类型首地址</span></span><br><span class="line">    Value *str = IRB.<span class="built_in">CreateGEP</span>(alloc, &#123;Zero, Zero&#125;);</span><br><span class="line">    <span class="comment">// 调用memset对其进行初始化</span></span><br><span class="line">    IRB.<span class="built_in">CreateCall</span>(func_memset, &#123;str, Zero, Size, Bool&#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> <span class="type">int</span> i = <span class="number">0</span>; i &lt; function_string.<span class="built_in">size</span>(); i++) &#123;</span><br><span class="line">        <span class="comment">// 索引</span></span><br><span class="line">        Value *Index = ConstantInt::<span class="built_in">get</span>(Type::<span class="built_in">getInt64Ty</span>(F.<span class="built_in">getContext</span>()), i);</span><br><span class="line">        <span class="comment">// 被设置的值</span></span><br><span class="line">        Value *CDATA = ConstantInt::<span class="built_in">get</span>(Type::<span class="built_in">getInt8Ty</span>(F.<span class="built_in">getContext</span>()), function_string[i]);</span><br><span class="line">        <span class="comment">// 找到相应指针</span></span><br><span class="line">        Value *GEP = IRB.<span class="built_in">CreateGEP</span>(alloc, &#123;Zero, Index&#125;);</span><br><span class="line">        <span class="comment">// 将字符存储到对应位置</span></span><br><span class="line">        IRB.<span class="built_in">CreateStore</span>(CDATA, GEP);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 调用printf，以str为参数</span></span><br><span class="line">    IRB.<span class="built_in">CreateCall</span>(func_printf, &#123;str&#125;);</span><br><span class="line">    <span class="comment">// 给当前block添加terminator语句为结尾</span></span><br><span class="line">    IRB.<span class="built_in">CreateBr</span>(entryBlock);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="项目sanrazor">7. 项目SanRazor</h3>
<h4 id="测试程序">7.1 测试程序</h4>
<p>给定C++程序</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span>* a = <span class="keyword">new</span> <span class="type">int</span>[<span class="number">10</span>];</span><br><span class="line">    a[<span class="number">5</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (a[argc])</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;xx\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写Makefile编译该程序</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">.SUFFIXES:.c .o</span></span><br><span class="line"></span><br><span class="line">CXX=clang++</span><br><span class="line"></span><br><span class="line">DIR := $&#123;CURDIR&#125; <span class="comment"># 使用绝对路径 防止后续被覆盖</span></span><br><span class="line">SRCS=<span class="variable">$(DIR)</span>/test.cpp</span><br><span class="line">OBJS=$(SRCS:.c=.o)</span><br><span class="line">EXEC=main</span><br><span class="line"></span><br><span class="line"><span class="section">start: <span class="variable">$(OBJS)</span></span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$(CFLAGS)</span> -o <span class="variable">$(EXEC)</span> <span class="variable">$(OBJS)</span></span><br><span class="line">	@echo <span class="string">&quot;-----------------------------OK-----------------------&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="section">.c.o:</span></span><br><span class="line">	<span class="variable">$(CXX)</span> <span class="variable">$(CFLAGS)</span> -o <span class="variable">$@</span> -c <span class="variable">$&lt;</span></span><br><span class="line"></span><br><span class="line"><span class="section">clean:</span></span><br><span class="line">	rm -rf <span class="variable">$(EXEC)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>执行make编译程序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  temp make</span><br><span class="line">clang++  -o main /home/harper/Projects/llvm/temp/test.cpp</span><br><span class="line">-----------------------------OK-----------------------</span><br><span class="line">➜  temp </span><br></pre></td></tr></table></figure>
<h4 id="插桩程序">7.2 插桩程序</h4>
<p><code>SRPass.so</code>的用法如下，首先插桩，用来记录每个分支的执行次数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> SR_STATE_PATH=<span class="string">&quot;<span class="subst">$(pwd)</span>/Cov&quot;</span></span><br><span class="line"><span class="built_in">export</span> SR_WORK_PATH=<span class="string">&quot;../coverage.sh&quot;</span>   <span class="comment"># 生成包含插桩所需外部函数的C文件</span></span><br><span class="line">SanRazor-clang -SR-init</span><br><span class="line">make clean</span><br><span class="line">make CC=SanRazor-clang CXX=SanRazor-clang++ CFLAGS=<span class="string">&quot;-Wall -Winline -g -O3 -fsanitize=address&quot;</span>  LDFLAGS=<span class="string">&quot;-fsanitize=address&quot;</span></span><br></pre></td></tr></table></figure>
<p>执行结果如下 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">➜  llvm <span class="built_in">export</span> PATH=/home/harper/Projects/llvm/build/bin:<span class="variable">$PATH</span></span><br><span class="line">➜  llvm <span class="built_in">cd</span> temp</span><br><span class="line">➜  temp <span class="built_in">ls</span></span><br><span class="line">Cov  coverage.sh  _home_harper_Projects_llvm_temp_test.cpp  main  Makefile  test.cpp  test.cpp.o</span><br><span class="line">➜  temp <span class="built_in">export</span> SR_STATE_PATH=<span class="string">&quot;<span class="subst">$(pwd)</span>/Cov&quot;</span></span><br><span class="line">➜  temp SanRazor-clang++ -SR-init</span><br><span class="line"><span class="comment"># Initialized Cov folder in /home/harper/Projects/llvm/temp/Cov. Now run:</span></span><br><span class="line"><span class="built_in">export</span> SR_STATE_PATH=<span class="string">&quot;/home/harper/Projects/llvm/temp/Cov&quot;</span></span><br><span class="line">➜  temp make clean</span><br><span class="line"><span class="built_in">rm</span> -rf main</span><br><span class="line">➜  temp <span class="built_in">ls</span></span><br><span class="line">Cov  coverage.sh  _home_harper_Projects_llvm_temp_test.cpp  Makefile  test.cpp  test.cpp.o</span><br><span class="line">➜  temp make CC=SanRazor-clang CXX=SanRazor-clang++ CFLAGS=<span class="string">&quot;-Wall -Winline -g -O3 -fsanitize=address&quot;</span>  LDFLAGS=<span class="string">&quot;-fsanitize=address&quot;</span></span><br><span class="line"></span><br><span class="line">SanRazor-clang++ -Wall -Winline -g -O3 -fsanitize=address -o main /home/harper/Projects/llvm/temp/test.cpp</span><br><span class="line">[<span class="string">&quot;/home/harper/Projects/llvm/build/bin/clang++&quot;</span>, <span class="string">&quot;-gline-tables-only&quot;</span>, <span class="string">&quot;-flto&quot;</span>, <span class="string">&quot;-Wall&quot;</span>, <span class="string">&quot;-Winline&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;-O3&quot;</span>, <span class="string">&quot;-fsanitize=address&quot;</span>, <span class="string">&quot;-o&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/test.cpp.o&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/test.cpp&quot;</span>, <span class="string">&quot;-o&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.orig.bc&quot;</span>]</span><br><span class="line">[<span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/../coverage.sh&quot;</span>, <span class="string">&quot;_home_harper_Projects_llvm_temp_test&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.glob.o&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/&quot;</span>, <span class="string">&quot;&quot;</span>]</span><br><span class="line">[<span class="string">&quot;/home/harper/Projects/llvm/build/bin/opt&quot;</span>, <span class="string">&quot;-load&quot;</span>, <span class="string">&quot;SRPass.so&quot;</span>, <span class="string">&quot;-dcc&quot;</span>, <span class="string">&quot;-o&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.cov.o&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.orig.bc&quot;</span>]</span><br><span class="line">Start SCIPass on /home/harper/Projects/llvm/temp/test.cpp</span><br><span class="line">End SCIPass on /home/harper/Projects/llvm/temp/test.cpp</span><br><span class="line">_home_harper_Projects_llvm_temp_test</span><br><span class="line">S check : :---S check : :---U check : if.end:if.then---/home/harper/Projects/llvm/temp/test.cpp :: 2 :: 1</span><br><span class="line">Insert call <span class="built_in">functions</span> <span class="keyword">for</span> SC branches <span class="keyword">in</span> /home/harper/Projects/llvm/temp/test.cpp!</span><br><span class="line">Insert call <span class="built_in">functions</span> <span class="keyword">for</span> UC branches <span class="keyword">in</span> /home/harper/Projects/llvm/temp/test.cpp!</span><br><span class="line">DCC Pass completed</span><br><span class="line">[<span class="string">&quot;/home/harper/Projects/llvm/build/bin/opt&quot;</span>, <span class="string">&quot;-load&quot;</span>, <span class="string">&quot;SRPass.so&quot;</span>, <span class="string">&quot;-dcc&quot;</span>, <span class="string">&quot;-o&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.cov.bc&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.orig.bc&quot;</span>]</span><br><span class="line">Start SCIPass on /home/harper/Projects/llvm/temp/test.cpp</span><br><span class="line">End SCIPass on /home/harper/Projects/llvm/temp/test.cpp</span><br><span class="line">_home_harper_Projects_llvm_temp_test</span><br><span class="line">S check : :---S check : :---U check : if.end:if.then---/home/harper/Projects/llvm/temp/test.cpp :: 2 :: 1</span><br><span class="line">Insert call <span class="built_in">functions</span> <span class="keyword">for</span> SC branches <span class="keyword">in</span> /home/harper/Projects/llvm/temp/test.cpp!</span><br><span class="line">Insert call <span class="built_in">functions</span> <span class="keyword">for</span> UC branches <span class="keyword">in</span> /home/harper/Projects/llvm/temp/test.cpp!</span><br><span class="line">DCC Pass completed</span><br><span class="line">[<span class="string">&quot;/home/harper/Projects/llvm/build/bin/llc&quot;</span>, <span class="string">&quot;-O3&quot;</span>, <span class="string">&quot;-filetype=obj&quot;</span>, <span class="string">&quot;-relocation-model=pic&quot;</span>, <span class="string">&quot;-o&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.loc.o&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.cov.o&quot;</span>]</span><br><span class="line">[<span class="string">&quot;ld&quot;</span>, <span class="string">&quot;-r&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.glob.o&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.loc.o&quot;</span>, <span class="string">&quot;-o&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/test.cpp.o&quot;</span>]</span><br><span class="line">[<span class="string">&quot;/home/harper/Projects/llvm/build/bin/clang++&quot;</span>, <span class="string">&quot;-Wall&quot;</span>, <span class="string">&quot;-Winline&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;-O3&quot;</span>, <span class="string">&quot;-fsanitize=address&quot;</span>, <span class="string">&quot;-o&quot;</span>, <span class="string">&quot;main&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/test.cpp.o&quot;</span>]</span><br><span class="line">-----------------------------OK-----------------------</span><br></pre></td></tr></table></figure></p>
<p>这一步实际执行的命令如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">clang++ -gline-tables-only -flto -fsanitize=address -o test.cpp.o -c test.cpp -o test.orig.bc <span class="comment"># 先生成llvm ir</span></span><br><span class="line">../coverage.sh _home_harper_Projects_llvm_temp_test test.glob.o Cov/  <span class="comment"># 生成test.glob.o，其中包含插桩所调用的函数</span></span><br><span class="line">opt -load SRPass.so -dcc -o test.cov.o test.orig.bc <span class="comment"># 插桩，记录每个分支的执行情况</span></span><br><span class="line">opt -load SRPass.so -dcc -o test.cov.bc test.orig.bc <span class="comment"># 等同于上一条语句 只是输出的文件格式不同</span></span><br><span class="line">llc -O3 -filetype=obj -relocation-model=pic -o test.loc.o test.cov.o <span class="comment"># 变成obj文件</span></span><br><span class="line">ld -r test.glob.o test.loc.o -o test.o <span class="comment"># 链接成test.o</span></span><br><span class="line">clang++ -o <span class="built_in">test</span> test.o <span class="comment"># 生成最后的可执行程序</span></span><br></pre></td></tr></table></figure>
<p>我们可以查看<code>test.orig.bc</code>和<code>test.cov.bc</code>的区别，通过llvm-dis将其转换为可读的格式。</p>
<figure>
<img src="https://i.loli.net/2021/01/17/C7GnhFcYDimRQ94.png"
alt="image-20210117141032037" />
<figcaption aria-hidden="true">image-20210117141032037</figcaption>
</figure>
<p>我们发现所有跟memory
sanitizer相关的指令都被标注了出来，而且每个sanity check和user
check前都被插桩，调用函数来记录每个分支的执行次数，执行生成的可执行文件，执行情况就被分别存储在<code>_home_harper_Projects_llvm_temp_test_UC.txt</code>和<code>_home_harper_Projects_llvm_temp_test_SC.txt</code>中。</p>
<h4 id="删除多余sanitizer">7.3 删除多余sanitizer</h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SanRazor-clang -SR-opt -san-level=L2 -use-asap=1.0</span><br><span class="line">make clean</span><br><span class="line">make CC=SanRazor-clang CXX=SanRazor-clang++ CFLAGS=<span class="string">&quot;-Wall -Winline -g -O3 -fsanitize=address&quot;</span>  LDFLAGS=<span class="string">&quot;-fsanitize=address&quot;</span> -j 12</span><br></pre></td></tr></table></figure>
<p>执行情况如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">➜  temp SanRazor-clang++ -SR-opt -san-level=L2 -use-asap=1.0</span><br><span class="line">L2</span><br><span class="line">L2</span><br><span class="line">1.0</span><br><span class="line">➜  temp make clean</span><br><span class="line"><span class="built_in">rm</span> -rf main                                                                                                               </span><br><span class="line">➜  temp make CC=SanRazor-clang CXX=SanRazor-clang++ CFLAGS=<span class="string">&quot;-Wall -Winline -g -O3 -fsanitize=address&quot;</span>  LDFLAGS=<span class="string">&quot;-fsanitize=address&quot;</span></span><br><span class="line"></span><br><span class="line">SanRazor-clang++ -Wall -Winline -g -O3 -fsanitize=address -o main /home/harper/Projects/llvm/temp/test.cpp</span><br><span class="line">***********************</span><br><span class="line">asan</span><br><span class="line">[<span class="string">&quot;/home/harper/Projects/llvm/build/bin/opt&quot;</span>, <span class="string">&quot;-load&quot;</span>, <span class="string">&quot;SRPass.so&quot;</span>, <span class="string">&quot;-DynPassL2&quot;</span>, <span class="string">&quot;-scovL2=/home/harper/Projects/llvm/temp/Cov/_home_harper_Projects_llvm_temp_test_SC.txt&quot;</span>,</span><br><span class="line"><span class="string">&quot;-ucovL2=/home/harper/Projects/llvm/temp/Cov/_home_harper_Projects_llvm_temp_test_UC.txt&quot;</span>, <span class="string">&quot;-logL2=/home/harper/Projects/llvm/temp/Cov/check.txt&quot;</span>, <span class="string">&quot;-use-asapL2=1.0&quot;</span>, <span class="string">&quot;-o&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.sr.o&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.orig.bc&quot;</span>]</span><br><span class="line">Start SCIPass on /home/harper/Projects/llvm/temp/test.cpp</span><br><span class="line">End SCIPass on /home/harper/Projects/llvm/temp/test.cpp</span><br><span class="line">DynPassL2 on /home/harper/Projects/llvm/temp/test;/home/harper/Projects/llvm/temp/Cov/_home_harper_Projects_llvm_temp_test_SC.txt</span><br><span class="line">2:2----</span><br><span class="line">Harper Optimized on /home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.orig.bc</span><br><span class="line">Reduced::UC:0SC:1:1--------</span><br><span class="line">1:1----</span><br><span class="line">UC num :: 1;SC Num :: 2;SC percent after L1 :: 5.000000e+01%;SC percent after L2 :: 5.000000e+01%</span><br><span class="line">SC cost percent:: 1.000000e+02;SC cost percent after L1 :: 5.000000e+01%;SC cost percent after L2 :: 5.000000e+01%</span><br><span class="line">com:1:1:1:1</span><br><span class="line"><span class="built_in">test</span>:1:1</span><br><span class="line">Total asap cost:18Reduced total asap cost9</span><br><span class="line">SafePass jj on /home/harper/Projects/llvm/temp/test</span><br><span class="line">Total cost:18 ,total num:2</span><br><span class="line">1::1Budget:5.000000e-02 ,budget removed:0.000000e+00 ,budget new:0.000000e+00</span><br><span class="line">10.000000e+000.000000e+000.000000e+000.000000e+00</span><br><span class="line">[<span class="string">&quot;/home/harper/Projects/llvm/build/bin/opt&quot;</span>, <span class="string">&quot;-load&quot;</span>, <span class="string">&quot;SRPass.so&quot;</span>, <span class="string">&quot;-DynPassL2&quot;</span>, <span class="string">&quot;-scovL2=/home/harper/Projects/llvm/temp/Cov/_home_harper_Projects_llvm_temp_test_SC.txt&quot;</span>, <span class="string">&quot;-ucovL2=/home/harper/Projects/llvm/temp/Cov/_home_harper_Projects_llvm_temp_test_UC.txt&quot;</span>, <span class="string">&quot;-logL2=/home/harper/Projects/llvm/temp/Cov/check.txt&quot;</span>, <span class="string">&quot;-use-asapL2=1.0&quot;</span>, <span class="string">&quot;-o&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.sr.bc&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.orig.bc&quot;</span>]</span><br><span class="line">Start SCIPass on /home/harper/Projects/llvm/temp/test.cpp</span><br><span class="line">End SCIPass on /home/harper/Projects/llvm/temp/test.cpp</span><br><span class="line">DynPassL2 on /home/harper/Projects/llvm/temp/test;/home/harper/Projects/llvm/temp/Cov/_home_harper_Projects_llvm_temp_test_SC.txt</span><br><span class="line">2:2----</span><br><span class="line">Harper Optimized on /home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.orig.bc</span><br><span class="line">Reduced::UC:0SC:1:1--------</span><br><span class="line">1:1----</span><br><span class="line">UC num :: 1;SC Num :: 2;SC percent after L1 :: 5.000000e+01%;SC percent after L2 :: 5.000000e+01%</span><br><span class="line">SC cost percent:: 1.000000e+02;SC cost percent after L1 :: 5.000000e+01%;SC cost percent after L2 :: 5.000000e+01%</span><br><span class="line">com:1:1:1:1</span><br><span class="line"><span class="built_in">test</span>:1:1</span><br><span class="line">Total asap cost:18Reduced total asap cost9</span><br><span class="line">SafePass jj on /home/harper/Projects/llvm/temp/test</span><br><span class="line">Total cost:18 ,total num:2</span><br><span class="line">1::1Budget:5.000000e-02 ,budget removed:0.000000e+00 ,budget new:0.000000e+00</span><br><span class="line">10.000000e+000.000000e+000.000000e+000.000000e+00</span><br><span class="line">[<span class="string">&quot;/home/harper/Projects/llvm/build/bin/opt&quot;</span>, <span class="string">&quot;-O3&quot;</span>, <span class="string">&quot;-o&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.opt.o&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.sr.o&quot;</span>]</span><br><span class="line">[<span class="string">&quot;/home/harper/Projects/llvm/build/bin/opt&quot;</span>, <span class="string">&quot;-load&quot;</span>, <span class="string">&quot;SRPass.so&quot;</span>, <span class="string">&quot;-SCClean&quot;</span>, <span class="string">&quot;-o&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.opt.o&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.opt.o&quot;</span>]</span><br><span class="line">[<span class="string">&quot;/home/harper/Projects/llvm/build/bin/opt&quot;</span>, <span class="string">&quot;-O3&quot;</span>, <span class="string">&quot;-o&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.opt.o&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.opt.o&quot;</span>]</span><br><span class="line">[<span class="string">&quot;/home/harper/Projects/llvm/build/bin/llc&quot;</span>, <span class="string">&quot;-O3&quot;</span>, <span class="string">&quot;-filetype=obj&quot;</span>, <span class="string">&quot;-relocation-model=pic&quot;</span>, <span class="string">&quot;-o&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/test.cpp.o&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.opt.o&quot;</span>]</span><br><span class="line">[<span class="string">&quot;/home/harper/Projects/llvm/build/bin/llc&quot;</span>, <span class="string">&quot;-O3&quot;</span>, <span class="string">&quot;-filetype=obj&quot;</span>, <span class="string">&quot;-relocation-model=pic&quot;</span>, <span class="string">&quot;-o&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.bc&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/Cov/objects/home/harper/Projects/llvm/temp/test.cpp.opt.o&quot;</span>]</span><br><span class="line">[<span class="string">&quot;/home/harper/Projects/llvm/build/bin/clang++&quot;</span>, <span class="string">&quot;-Wall&quot;</span>, <span class="string">&quot;-Winline&quot;</span>, <span class="string">&quot;-g&quot;</span>, <span class="string">&quot;-O3&quot;</span>, <span class="string">&quot;-fsanitize=address&quot;</span>, <span class="string">&quot;-o&quot;</span>, <span class="string">&quot;main&quot;</span>, <span class="string">&quot;/home/harper/Projects/llvm/temp/test.cpp.o&quot;</span>]</span><br></pre></td></tr></table></figure>
<p>实际上执行的命令如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">opt -load SRPass.so -DynPassL2 -scovL2=test_SC.txt -ucovL2=test_UC.txt -logL2=check.txt -use-asapL2=1.0 -o test.sr.o test.orig.bc <span class="comment"># 读取执行次数，标记冗余的check，将其设置为false</span></span><br><span class="line">opt -load SRPass.so -DynPassL2 -scovL2=test_SC.txt -ucovL2=test_UC.txt -logL2=check.txt -use-asapL2=1.0 -o test.sr.bc test.orig.bc <span class="comment"># 同上</span></span><br><span class="line">opt -O3 -o test.opt.o test.sr.o</span><br><span class="line">opt -load SRPass.so -SCClean -o test.opt.o test.opt.o <span class="comment"># 删除冗余的check</span></span><br><span class="line">opt -O3 -o test.opt.o test.opt.o</span><br><span class="line">llc -O3 -filetype=obj -relocation-model=pic -o test.o test.opt.o</span><br><span class="line">llc -O3 -filetype=obj -relocation-model=pic -o test.bc test.opt.o</span><br><span class="line">clang++ -o <span class="built_in">test</span> test.o</span><br></pre></td></tr></table></figure>
<p>我们首先比较<code>test.orig.bc</code>和<code>test.sr.bc</code>，第二个冗余的分支语句被设置为了false。</p>
<figure>
<img src="https://i.loli.net/2021/01/17/oScGwrnBs1PQxdq.png"
alt="image-20210117142006991" />
<figcaption aria-hidden="true">image-20210117142006991</figcaption>
</figure>
<p>然后比较<code>test.sr.bc</code>和<code>test.opt.bc</code>，可以发现有些语句直接被删除了。</p>
<figure>
<img src="https://i.loli.net/2021/01/17/UnSOy7zrQLjPt45.png"
alt="image-20210117142941747" />
<figcaption aria-hidden="true">image-20210117142941747</figcaption>
</figure>
<p>经O3优化后，所有第二个sanity check都被删除</p>
<figure>
<img src="https://i.loli.net/2021/01/17/7JCIjQiSMgtADdm.png"
alt="image-20210117143531357" />
<figcaption aria-hidden="true">image-20210117143531357</figcaption>
</figure>
<h4 id="代码逻辑">7.4 代码逻辑</h4>
<p>Search for <code>RegisterPass</code> in the whole project, find the
customized features of this <code>SRPass.so</code> file</p>
<p><img src="https://i.loli.net/2021/01/11/V8QW1lRq9zHs3Ei.png" alt="image-20210111150855153" style="zoom:77%;" /></p>
<p>For this project, there are 7 customized featrures, which corresponds
to seven option</p>
<p><code>-SCIPass</code>对应SCIPass类，是最基本的类，该类分析所有的check
list，包括user check和sanity check</p>
<p><code>-dcc</code>对应DynamicCallCounter类，该类继承自ModulePass，处理对SC和UC进行插桩，统计在给定workload的情况下每个分支的执行次数</p>
<p><code>-DynPassL0/L1/L2</code>
对应DynPassL0/L1/L2类，该类继承自ModulePass，每次处理一个program，根据执行次数和静态依赖信息将冗余的sanity
check的if语句设置为永远false</p>
<p><code>-SCClean</code>用于删除冗余sanitizer对应的指令</p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/blog/2021/01/08/OpenArk-Compiler/" rel="prev" title="OpenArk Compiler">
                  <i class="fa fa-angle-left"></i> OpenArk Compiler
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/blog/2021/01/08/LLVM-Pass/" rel="next" title="LLVM Pass">
                  LLVM Pass <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Wei CHEN</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/blog/js/comments.js"></script><script src="/blog/js/utils.js"></script><script src="/blog/js/motion.js"></script><script src="/blog/js/next-boot.js"></script>

  






  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/blog/js/third-party/math/mathjax.js"></script>



</body>
</html>
