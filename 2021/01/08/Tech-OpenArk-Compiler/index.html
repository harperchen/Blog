<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"harperchen.github.io","root":"/blog/","images":"/blog/images","scheme":"Gemini","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/blog/js/config.js"></script>

    <meta name="description" content="1. Maple IR前端 Maple IR是方舟编译器的中间表示语言，设计原则是尽可能多的保留源文件的信息，其中信息包括声明部分（符号表）和代码部分。Maple IR是平台无关的，不依赖任何处理器。Maple IR也有配套的Maple VM，可以直接运行Maple IR。可以利用不同的前端将C&#x2F;C++，Java等不同的语言转化成Maple IR，也可以扩展支持别的语言。">
<meta property="og:type" content="article">
<meta property="og:title" content="[Tech] OpenArk Compiler">
<meta property="og:url" content="https://harperchen.github.io/blog/2021/01/08/Tech-OpenArk-Compiler/index.html">
<meta property="og:site_name" content="Wei&#39;s Blog">
<meta property="og:description" content="1. Maple IR前端 Maple IR是方舟编译器的中间表示语言，设计原则是尽可能多的保留源文件的信息，其中信息包括声明部分（符号表）和代码部分。Maple IR是平台无关的，不依赖任何处理器。Maple IR也有配套的Maple VM，可以直接运行Maple IR。可以利用不同的前端将C&#x2F;C++，Java等不同的语言转化成Maple IR，也可以扩展支持别的语言。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2021/01/20/xVlMuHn41mqTSfp.png">
<meta property="og:image" content="https://i.loli.net/2021/01/22/cAOmhzBoknJZ7qe.png">
<meta property="og:image" content="https://i.loli.net/2021/01/26/UWHA7fpgh38MOir.png">
<meta property="og:image" content="https://i.loli.net/2021/01/26/hfGZSJHq8gm21iT.png">
<meta property="og:image" content="https://i.loli.net/2021/01/22/EWgLx7VaFQYSCO3.png">
<meta property="og:image" content="https://i.loli.net/2021/01/26/QmrfZsvKB9TLFCX.png">
<meta property="og:image" content="https://i.loli.net/2021/01/23/9fhxQqVCrjY8LmR.png">
<meta property="og:image" content="https://i.loli.net/2021/01/23/FHrMeEnm86cdbfi.png">
<meta property="og:image" content="https://i.loli.net/2021/01/20/gEvT3aWi8j1HVbq.png">
<meta property="og:image" content="https://i.loli.net/2021/01/20/9JdCpVYWc2GDzS1.png">
<meta property="og:image" content="https://i.loli.net/2021/01/20/P1KRtkcwfdImuZY.png">
<meta property="og:image" content="https://i.loli.net/2021/01/21/WwgG4Ntye2fzR9X.png">
<meta property="og:image" content="https://i.loli.net/2021/01/21/9qe5yaCPNSxb2pV.png">
<meta property="og:image" content="https://i.loli.net/2021/01/23/kbasN7np3Ry4d8Y.png">
<meta property="article:published_time" content="2021-01-08T08:49:25.000Z">
<meta property="article:modified_time" content="2024-03-27T05:21:36.080Z">
<meta property="article:author" content="Wei CHEN">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/01/20/xVlMuHn41mqTSfp.png">


<link rel="canonical" href="https://harperchen.github.io/blog/2021/01/08/Tech-OpenArk-Compiler/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://harperchen.github.io/blog/2021/01/08/Tech-OpenArk-Compiler/","path":"2021/01/08/Tech-OpenArk-Compiler/","title":"[Tech] OpenArk Compiler"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>[Tech] OpenArk Compiler | Wei's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Wei's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#maple-ir%E5%89%8D%E7%AB%AF"><span class="nav-number">1.</span> <span class="nav-text">1. Maple IR前端</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#cc-to-maple"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 C&#x2F;C++ to Maple</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#java-to-maple"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 Java to Maple</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#others"><span class="nav-number">1.3.</span> <span class="nav-text">1.3 Others</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#maple-ir%E8%AE%BE%E8%AE%A1"><span class="nav-number">2.</span> <span class="nav-text">2. Maple IR设计</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#from-java"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 From Java</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#from-cc"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 From C&#x2F;C++</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E9%85%8D%E7%BD%AEopenark"><span class="nav-number">3.</span> <span class="nav-text">3. 配置OpenArk</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#openark-compiler"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 OpenArk Compiler</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#java2jar"><span class="nav-number">3.1.1.</span> <span class="nav-text">3.3.1 java2jar</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#jbc2mpl"><span class="nav-number">3.1.2.</span> <span class="nav-text">3.3.2 jbc2mpl</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#maple"><span class="nav-number">3.1.3.</span> <span class="nav-text">3.3.3 maple</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#mplcg"><span class="nav-number">3.1.4.</span> <span class="nav-text">3.3.4 mplcg</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#irbuild"><span class="nav-number">3.1.5.</span> <span class="nav-text">3.3.5 irbuild</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#others-1"><span class="nav-number">3.1.6.</span> <span class="nav-text">3.3.6 others</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mapleall-for-cc"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 Mapleall for C&#x2F;C++</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#maple-engine-for-java"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 Maple Engine for Java</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#phase%E4%BB%8B%E7%BB%8D"><span class="nav-number">4.</span> <span class="nav-text">4. Phase介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89phase%E7%B1%BB"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 自定义Phase类</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#phasemanager"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 PhaseManager</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#interleavedmanager-driverrunner"><span class="nav-number">4.3.</span> <span class="nav-text">4.3 InterleavedManager
&amp;&amp; DriverRunner</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#phase%E8%BF%90%E8%A1%8C%E6%9C%BA%E5%88%B6"><span class="nav-number">4.4.</span> <span class="nav-text">4.4 Phase运行机制</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89phase"><span class="nav-number">5.</span> <span class="nav-text">5. 自定义Phase</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89module-phase"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 自定义Module Phase</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89function-phase"><span class="nav-number">5.2.</span> <span class="nav-text">5.2 自定义Function Phase</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%8F%92%E6%A1%A9%E7%A4%BA%E4%BE%8B"><span class="nav-number">6.</span> <span class="nav-text">7. 插桩示例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#reference"><span class="nav-number">7.</span> <span class="nav-text">Reference</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Wei CHEN"
      src="/blog/images/WechatIMG14.jpg">
  <p class="site-author-name" itemprop="name">Wei CHEN</p>
  <div class="site-description" itemprop="description">Be Brave; Be Confident; <br> Be Happy; Be Optimistic; </div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">60</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/blog/tags/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/harperchen" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;harperchen" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:harperchen1110@gmail.com" title="E-Mail → mailto:harperchen1110@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harperchen.github.io/blog/2021/01/08/Tech-OpenArk-Compiler/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/WechatIMG14.jpg">
      <meta itemprop="name" content="Wei CHEN">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wei's Blog">
      <meta itemprop="description" content="Be Brave; Be Confident; <br> Be Happy; Be Optimistic; ">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="[Tech] OpenArk Compiler | Wei's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [Tech] OpenArk Compiler
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-01-08 16:49:25" itemprop="dateCreated datePublished" datetime="2021-01-08T16:49:25+08:00">2021-01-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-27 13:21:36" itemprop="dateModified" datetime="2024-03-27T13:21:36+08:00">2024-03-27</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h4 id="maple-ir前端">1. Maple IR前端</h4>
<p>Maple
IR是方舟编译器的中间表示语言，设计原则是尽可能多的保留源文件的信息，其中信息包括声明部分（符号表）和代码部分。Maple
IR是平台无关的，不依赖任何处理器。Maple IR也有配套的Maple
VM，可以直接运行Maple
IR。可以利用不同的前端将C/C++，Java等不同的语言转化成Maple
IR，也可以扩展支持别的语言。</p>
<span id="more"></span>
<p>Maple
IR支持所有已知的程序分析和优化操作，它支持在不同语义层面表示程序代码，也就是说，不同于LLVM
IR的显示单层IR表示，方舟编译器的Maple IR提出多层中间表示：</p>
<ul>
<li>高层中间表示尽可能的保留源码内部的信息，适合language-specific的分析和优化；</li>
<li>低层中间表示接近汇编指令，差不多和汇编指令有一对一的映射，可以进行通用general
purpose的优化；</li>
</ul>
<p>越高层次的IR，支持的Opcode越多，越底层的IR，支持的Opcode越接近处理器的汇编；高层次的IR，程序结构是有层级的，低层次的IR，程序结构是扁平的，变成了序列化指令的形式；高层次的IR是与平台无关的，低层次的IR变得和平台有关。多层IR表示能够最大化在IR层的优化效果。（不知道能否显式表现出多层IR）</p>
<p>Maple
IR存储到文件的时候有两个格式，一个是mpl，一个是mplt。mplt是声明文件，mpl是定义文件。Maple
IR的定位本身就是一种高级语言。mplt对应C++的<code>.h</code>，里面存放类的声明，mpt文件对应C++的<code>.cpp</code>文件，里面存放方法的实现。</p>
<h5 id="cc-to-maple">1.1 C/C++ to Maple</h5>
<p><code>ast2mpl</code>是C和C++的前端，将clangAst转换为mpl格式的中间表示语言。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ast2mpl printHuawei.c -I /usr/lib/gcc/x86_64-linux-gnu/8/include <span class="comment"># generate printHuawei.mpl</span></span><br></pre></td></tr></table></figure>
<h5 id="java-to-maple">1.2 Java to Maple</h5>
<p><code>jbc2mpl</code>是Java的前端，java
bytecode转化为mpl格式的中间表示语言，用jar或class作为输入都可以。java-core是java语言的基础类库，想要使用java的基础包就需要这个类库的支持。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># use .class as input</span></span><br><span class="line">jbc2mpl -mplt /home/wchenbt/OpenArkCompiler/output/aarch64-clang-release/libjava-core/java-core.mplt -inclass HelloWorld.class -out HelloWorld</span><br><span class="line"><span class="comment"># use .jar as input</span></span><br><span class="line">jbc2mpl -mplt /home/wchenbt/OpenArkCompiler/output/aarch64-clang-release/libjava-core/java-core.mplt -injar HelloWorld.jar -out HelloWorld</span><br><span class="line"><span class="comment"># use java-core.jar as input</span></span><br><span class="line">jbc2mpl -injar /home/wchenbt/OpenArkCompiler/output/aarch64-clang-release/libjava-core/java-core.jar -inclass HelloWorld.class -out HelloWorld</span><br></pre></td></tr></table></figure>
<h5 id="others">1.3 Others</h5>
<p>方舟编译器利用如下前端将除C/C++和Java以外的语言转化为中间表示语言Maple：</p>
<ul>
<li>dex2mpl</li>
<li>js2mpl</li>
<li>mplfe：前端开发框架，多个前端开发作准备</li>
</ul>
<h4 id="maple-ir设计">2. Maple IR设计</h4>
<p>Maple
IR有二进制格式和ASCII码格式，但不是<code>.mpl</code>和<code>.mplt</code>。ASCII码格式包含</p>
<ul>
<li>declaration statements（声明语句）：符号表信息</li>
<li>executable states（执行语句）：程序代码</li>
</ul>
<p>每个Maple
IR文件对应一个CU编译单元，编译单元由全局范围内的声明组成。声明是由函数组成的，也称为PU，PU则包含局部声明。</p>
<p>（类比于LLVM IR的Module，Function和Baisc Block）</p>
<p><img src="https://i.loli.net/2021/01/20/xVlMuHn41mqTSfp.png" alt="image-20210120222004928" style="zoom:40%;" /></p>
<p>Maple IR中的execution node有三种：</p>
<ul>
<li>Leaf nodes (terminal nodes)：constant or the value of a storeage
unit</li>
<li>Expression nodes: An expression node performs an operation on its
operands to compute a result. Each operand can be either a leaf node or
another expression node. Expression nodes are the internal nodes of
expression trees.</li>
<li>Statement nodes</li>
</ul>
<p>In all the executable nodes, the <em>opcode</em> field specifies the
operation of the node, followed by additional field specification
relevant to the opcode. The operands for the node are specified inside
<em>parentheses</em> separated <em>commas</em>. The general form is:</p>
<p><em>opcode fields (opnd0, opnd1, opnd2)</em></p>
<p>例如C语言中的赋值语句 "a = b" 对应的Maple IR使用 dassign (direct
assignment opcode) 将b的值赋给a。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">dassign</span> <span class="variable">$a</span> (dread i32 <span class="variable">$b</span>)</span><br></pre></td></tr></table></figure>
<p>若有嵌套，需要另起一行，例如表达式a = b + c - d对应的Maple IR如下</p>
<figure class="highlight wasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">dassign <span class="variable">$a</span> <span class="punctuation">(</span></span><br><span class="line">  sub <span class="type">i32</span><span class="punctuation">(</span></span><br><span class="line">    add <span class="type">i32</span><span class="punctuation">(</span>dread <span class="type">i32</span> <span class="variable">$b</span>, dread <span class="type">i32</span> <span class="variable">$c</span><span class="punctuation">)</span>,</span><br><span class="line">    dread <span class="type">i32</span> <span class="variable">$d</span><span class="punctuation">))</span></span><br></pre></td></tr></table></figure>
<p>方舟的IR和LLVM IR的区别为</p>
<ul>
<li>方舟编译器的IR专门为Javascript预留了12个基本类型，这显然是为了后续支持Javascript所做的准备</li>
<li>LLVM
IR的整型设计的更加简洁，直接用iN来表示。而方舟编译器IR是用了i16/i32/i64/u16/u32/u64来表示</li>
</ul>
<h5 id="from-java">2.1 From Java</h5>
<p>如下是HelloWorld.java程序对应的Maple IR。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先是一些这个类的基本信息，称为Module Declaration。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">flavor <span class="number">1</span> <span class="comment">// how the IR was produced, indicating the state of the compilation process</span></span><br><span class="line">srclang <span class="number">3</span> <span class="comment">// gives the source language that produces the Maple IR module</span></span><br><span class="line">id <span class="number">65535</span> <span class="comment">// unique module id assigned to the module</span></span><br><span class="line">numfuncs <span class="number">2</span> <span class="comment">// number of function definitions in the module,</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;HelloWorld.mplt&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;/home/wchenbt/OpenArkCompiler/output/aarch64-clang-release/libjava-core/java-core.mplt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// entry point</span></span><br><span class="line">entryfunc &amp;LHelloWorld_3B_7Cmain_7C_28ALjava_2Flang_2FString_3B_29V</span><br><span class="line"></span><br><span class="line">fileinfo &#123;</span><br><span class="line">  <span class="meta">@INFO_filename</span> <span class="string">&quot;HelloWorld.class&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">srcfileinfo &#123;</span><br><span class="line">  <span class="number">1</span> <span class="string">&quot;HelloWorld.java&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>接下来是符号表信息，每个文件里有一个global符号表，每个函数又分别有一个local符号表，每个符号表中有变量信息、类型信息和函数原型信息。代码中通过名字引用符号表中的信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个类的信息</span></span><br><span class="line">javaclass $LHelloWorld_3B &lt;$LHelloWorld_3B&gt; <span class="keyword">public</span></span><br><span class="line"><span class="comment">// 两个函数原型声明</span></span><br><span class="line">func &amp;LHelloWorld_3B_7C_3Cinit_3E_7C_28_29V <span class="keyword">public</span> <span class="title function_">constructor</span> <span class="params">(<span class="keyword">var</span> %_this &lt;* &lt;$LHelloWorld_3B&gt;&gt;)</span> <span class="keyword">void</span></span><br><span class="line">func &amp;LHelloWorld_3B_7Cmain_7C_28ALjava_2Flang_2FString_3B_29V <span class="keyword">public</span> <span class="title function_">static</span> <span class="params">(<span class="keyword">var</span> %Reg2_R742 &lt;* &lt;[] &lt;* &lt;$Ljava_2Flang_2FString_3B&gt;&gt;&gt;&gt;)</span> <span class="keyword">void</span></span><br><span class="line"><span class="comment">// 全局变量</span></span><br><span class="line"><span class="keyword">var</span> $_C_STR_d9bd4a0c2c2117158ed933ab7468a461 fstatic &lt;[<span class="number">4</span>] u64&gt; readonly = [<span class="number">0</span>, <span class="number">0x1900000000</span>, <span class="number">0x6c6c6548c63cb61d</span>, <span class="number">0x21646c726f57206f</span>] <span class="comment">// &quot;Hello World&quot;</span></span><br><span class="line"><span class="keyword">var</span> $Ljava_2Flang_2FSystem_3B_7Cout extern &lt;* &lt;$Ljava_2Fio_2FPrintStream_3B&gt;&gt; <span class="keyword">final</span> <span class="keyword">public</span> <span class="keyword">static</span> <span class="comment">// System.out</span></span><br><span class="line"><span class="keyword">var</span> $__cinf_Ljava_2Flang_2FString_3B extern &lt;$__class_meta__&gt;</span><br><span class="line"></span><br><span class="line">func &amp;MCC_GetOrInsertLiteral () &lt;* &lt;$Ljava_2Flang_2FString_3B&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>接下来，是两个声明函数的定义，一个是构造函数，一个是main函数，函数开头是局部符号表信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">func &amp;LHelloWorld_3B_7C_3Cinit_3E_7C_28_29V <span class="keyword">public</span> <span class="title function_">constructor</span> <span class="params">(<span class="keyword">var</span> %_this &lt;* &lt;$LHelloWorld_3B&gt;&gt;)</span> <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="comment">// 局部符号表信息</span></span><br><span class="line">  funcid <span class="number">48971</span></span><br><span class="line">  <span class="keyword">var</span> %Reg1_R44446 &lt;* &lt;$LHelloWorld_3B&gt;&gt;</span><br><span class="line">  <span class="keyword">var</span> %Reg0_R44446 &lt;* &lt;$LHelloWorld_3B&gt;&gt;</span><br><span class="line">  <span class="keyword">var</span> %Reg0_R57 &lt;* &lt;$Ljava_2Flang_2FObject_3B&gt;&gt;</span><br><span class="line"></span><br><span class="line">  dassign %Reg1_R44446 <span class="number">0</span> (dread ref %_this)</span><br><span class="line">  #LINE HelloWorld.java : <span class="number">15</span>, INSTIDX : <span class="number">0</span>||<span class="number">0000</span>:  aload_0</span><br><span class="line">LOC <span class="number">1</span> <span class="number">15</span></span><br><span class="line">  dassign %Reg0_R44446 <span class="number">0</span> (dread ref %Reg1_R44446)</span><br><span class="line">  #LINE HelloWorld.java : <span class="number">15</span>, INSTIDX : <span class="number">1</span>||<span class="number">0001</span>:  invokespecial</span><br><span class="line">  dassign %Reg0_R57 <span class="number">0</span> (retype ref &lt;* &lt;$Ljava_2Flang_2FObject_3B&gt;&gt; (dread ref %Reg0_R44446))</span><br><span class="line">  callassigned &amp;Ljava_2Flang_2FObject_3B_7C_3Cinit_3E_7C_28_29V (dread ref %Reg0_R57) &#123;&#125;</span><br><span class="line">  #LINE HelloWorld.java : <span class="number">15</span>, INSTIDX : <span class="number">4</span>||<span class="number">0004</span>:  <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">return</span> ()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">func &amp;LHelloWorld_3B_7Cmain_7C_28ALjava_2Flang_2FString_3B_29V <span class="keyword">public</span> <span class="title function_">static</span> <span class="params">(<span class="keyword">var</span> %Reg2_R742 &lt;* &lt;[] &lt;* &lt;$Ljava_2Flang_2FString_3B&gt;&gt;&gt;&gt;)</span> <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="comment">// 局部符号表信息</span></span><br><span class="line">  funcid <span class="number">48972</span></span><br><span class="line">  <span class="keyword">var</span> %Reg0_R561 &lt;* &lt;$Ljava_2Fio_2FPrintStream_3B&gt;&gt;</span><br><span class="line">  <span class="keyword">var</span> %Reg1_R43 &lt;* &lt;$Ljava_2Flang_2FString_3B&gt;&gt;</span><br><span class="line">  <span class="keyword">var</span> %L_STR_163987 &lt;* &lt;$Ljava_2Flang_2FString_3B&gt;&gt;</span><br><span class="line">  <span class="comment">// main的参数</span></span><br><span class="line">ALIAS %args %Reg2_R742 &lt;* &lt;[] &lt;* &lt;$Ljava_2Flang_2FString_3B&gt;&gt;&gt;&gt;</span><br><span class="line">  intrinsiccallwithtype &lt;$LHelloWorld_3B&gt; JAVA_CLINIT_CHECK ()</span><br><span class="line">  #LINE HelloWorld.java : <span class="number">17</span>, INSTIDX : <span class="number">0</span>||<span class="number">0000</span>:  getstatic</span><br><span class="line">LOC <span class="number">1</span> <span class="number">17</span> <span class="comment">// System.out.println(&quot;Hello World!&quot;);</span></span><br><span class="line">  intrinsiccallwithtype &lt;$Ljava_2Flang_2FSystem_3B&gt; JAVA_CLINIT_CHECK ()</span><br><span class="line">  dassign %Reg0_R561 <span class="number">0</span> (dread ref $Ljava_2Flang_2FSystem_3B_7Cout)</span><br><span class="line">  #LINE HelloWorld.java : <span class="number">17</span>, INSTIDX : <span class="number">3</span>||<span class="number">0003</span>:  ldc</span><br><span class="line">  <span class="comment">// 引用HelloWorld字符串对应的变量</span></span><br><span class="line">  callassigned &amp;MCC_GetOrInsertLiteral (addrof ptr $_C_STR_d9bd4a0c2c2117158ed933ab7468a461) &#123; dassign %L_STR_163987 <span class="number">0</span> &#125;</span><br><span class="line">  dassign %Reg1_R43 <span class="number">0</span> (dread ptr %L_STR_163987)</span><br><span class="line">  #LINE HelloWorld.java : <span class="number">17</span>, INSTIDX : <span class="number">5</span>||<span class="number">0005</span>:  invokevirtual</span><br><span class="line">  <span class="comment">// System.out.println</span></span><br><span class="line">  virtualcallassigned &amp;Ljava_2Fio_2FPrintStream_3B_7Cprintln_7C_28Ljava_2Flang_2FString_3B_29V (dread ref %Reg0_R561, dread ref %Reg1_R43) &#123;&#125;</span><br><span class="line">  #LINE HelloWorld.java : <span class="number">18</span>, INSTIDX : <span class="number">8</span>||0008:  <span class="keyword">return</span></span><br><span class="line">LOC <span class="number">1</span> <span class="number">18</span></span><br><span class="line">  <span class="keyword">return</span> ()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>再看一个Java代码对应的Maple IR，感受一下Maple IR如何做算术运算。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们从main函数中可以看出，不同于LLVM IR，Maple
IR不是SSA，一个变量可以被赋值多次，和LLVM
IR相同的是，每个操作数都指明了类型。语句中经常在中间位置有一个0，这是field-ID，涉及结构体或class成员的编号，对于基本数据类型，field-ID都是0。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件信息</span></span><br><span class="line">flavor <span class="number">1</span></span><br><span class="line">srclang <span class="number">3</span></span><br><span class="line">id <span class="number">65535</span></span><br><span class="line">numfuncs <span class="number">2</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;HelloWorld.mplt&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;/home/wchenbt/OpenArkCompiler/output/aarch64-clang-release/libjava-core/java-core.mplt&quot;</span></span><br><span class="line">entryfunc &amp;LHelloWorld_3B_7Cmain_7C_28ALjava_2Flang_2FString_3B_29V</span><br><span class="line">fileinfo &#123;</span><br><span class="line">  <span class="meta">@INFO_filename</span> <span class="string">&quot;HelloWorld.class&quot;</span>&#125;</span><br><span class="line">srcfileinfo &#123;</span><br><span class="line">  <span class="number">1</span> <span class="string">&quot;HelloWorld.java&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 全局符号表</span></span><br><span class="line">javaclass $LHelloWorld_3B &lt;$LHelloWorld_3B&gt; <span class="keyword">public</span></span><br><span class="line">func &amp;LHelloWorld_3B_7C_3Cinit_3E_7C_28_29V <span class="keyword">public</span> <span class="title function_">constructor</span> <span class="params">(<span class="keyword">var</span> %_this &lt;* &lt;$LHelloWorld_3B&gt;&gt;)</span> <span class="keyword">void</span></span><br><span class="line">func &amp;LHelloWorld_3B_7Cmain_7C_28ALjava_2Flang_2FString_3B_29V <span class="keyword">public</span> <span class="title function_">static</span> <span class="params">(<span class="keyword">var</span> %Reg5_R742 &lt;* &lt;[] &lt;* &lt;$Ljava_2Flang_2FString_3B&gt;&gt;&gt;&gt;)</span> <span class="keyword">void</span></span><br><span class="line"><span class="keyword">var</span> $__cinf_Ljava_2Flang_2FString_3B extern &lt;$__class_meta__&gt;</span><br><span class="line">func &amp;MCC_GetOrInsertLiteral () &lt;* &lt;$Ljava_2Flang_2FString_3B&gt;&gt;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// 构造函数</span></span><br><span class="line">func &amp;LHelloWorld_3B_7C_3Cinit_3E_7C_28_29V <span class="keyword">public</span> <span class="title function_">constructor</span> <span class="params">(<span class="keyword">var</span> %_this &lt;* &lt;$LHelloWorld_3B&gt;&gt;)</span> <span class="keyword">void</span> &#123;</span><br><span class="line">  funcid <span class="number">48971</span></span><br><span class="line">  <span class="keyword">var</span> %Reg1_R44446 &lt;* &lt;$LHelloWorld_3B&gt;&gt;</span><br><span class="line">  <span class="keyword">var</span> %Reg0_R44446 &lt;* &lt;$LHelloWorld_3B&gt;&gt;</span><br><span class="line">  <span class="keyword">var</span> %Reg0_R57 &lt;* &lt;$Ljava_2Flang_2FObject_3B&gt;&gt;</span><br><span class="line"></span><br><span class="line">  dassign %Reg1_R44446 <span class="number">0</span> (dread ref %_this)</span><br><span class="line">  #LINE HelloWorld.java : <span class="number">15</span>, INSTIDX : <span class="number">0</span>||<span class="number">0000</span>:  aload_0</span><br><span class="line">LOC <span class="number">1</span> <span class="number">15</span></span><br><span class="line">  dassign %Reg0_R44446 <span class="number">0</span> (dread ref %Reg1_R44446)</span><br><span class="line">  #LINE HelloWorld.java : <span class="number">15</span>, INSTIDX : <span class="number">1</span>||<span class="number">0001</span>:  invokespecial</span><br><span class="line">  dassign %Reg0_R57 <span class="number">0</span> (retype ref &lt;* &lt;$Ljava_2Flang_2FObject_3B&gt;&gt; (dread ref %Reg0_R44446))</span><br><span class="line">  callassigned &amp;Ljava_2Flang_2FObject_3B_7C_3Cinit_3E_7C_28_29V (dread ref %Reg0_R57) &#123;&#125;</span><br><span class="line">  #LINE HelloWorld.java : <span class="number">15</span>, INSTIDX : <span class="number">4</span>||<span class="number">0004</span>:  <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">return</span> ()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// main函数</span></span><br><span class="line">func &amp;LHelloWorld_3B_7Cmain_7C_28ALjava_2Flang_2FString_3B_29V <span class="keyword">public</span> <span class="title function_">static</span> <span class="params">(<span class="keyword">var</span> %Reg5_R742 &lt;* &lt;[] &lt;* &lt;$Ljava_2Flang_2FString_3B&gt;&gt;&gt;&gt;)</span> <span class="keyword">void</span> &#123;</span><br><span class="line">  <span class="comment">// 局部符号表信息</span></span><br><span class="line">  funcid <span class="number">48972</span></span><br><span class="line">  <span class="keyword">var</span> %Reg0_I i32</span><br><span class="line">  <span class="keyword">var</span> %Reg2_I i32</span><br><span class="line">  <span class="keyword">var</span> %Reg3_I i32</span><br><span class="line">  <span class="keyword">var</span> %Reg1_I i32</span><br><span class="line">  <span class="keyword">var</span> %Reg4_I i32</span><br><span class="line"></span><br><span class="line">ALIAS %a %Reg2_I i32</span><br><span class="line">ALIAS %c %Reg4_I i32</span><br><span class="line">ALIAS %b %Reg3_I i32</span><br><span class="line"><span class="comment">// main的参数</span></span><br><span class="line">ALIAS %args %Reg5_R742 &lt;* &lt;[] &lt;* &lt;$Ljava_2Flang_2FString_3B&gt;&gt;&gt;&gt;</span><br><span class="line">  intrinsiccallwithtype &lt;$LHelloWorld_3B&gt; JAVA_CLINIT_CHECK ()</span><br><span class="line">  #LINE HelloWorld.java : <span class="number">17</span>, INSTIDX : <span class="number">0</span>||<span class="number">0000</span>:  iconst_0</span><br><span class="line">LOC <span class="number">1</span> <span class="number">17</span> <span class="comment">// int a = 0;</span></span><br><span class="line">  dassign %Reg0_I <span class="number">0</span> (constval i32 <span class="number">0</span>)</span><br><span class="line">  #LINE HelloWorld.java : <span class="number">17</span>, INSTIDX : <span class="number">1</span>||<span class="number">0001</span>:  istore_1</span><br><span class="line">  dassign %Reg2_I <span class="number">0</span> (dread i32 %Reg0_I)</span><br><span class="line">  #LINE HelloWorld.java : <span class="number">18</span>, INSTIDX : <span class="number">2</span>||<span class="number">0002</span>:  iconst_1</span><br><span class="line">LOC <span class="number">1</span> <span class="number">18</span> <span class="comment">// int b = 1;</span></span><br><span class="line">  dassign %Reg0_I <span class="number">0</span> (constval i32 <span class="number">1</span>)</span><br><span class="line">  #LINE HelloWorld.java : <span class="number">18</span>, INSTIDX : <span class="number">3</span>||<span class="number">0003</span>:  istore_2</span><br><span class="line">  dassign %Reg3_I <span class="number">0</span> (dread i32 %Reg0_I)</span><br><span class="line">  #LINE HelloWorld.java : <span class="number">19</span>, INSTIDX : <span class="number">4</span>||<span class="number">0004</span>:  iload_1</span><br><span class="line">LOC <span class="number">1</span> <span class="number">19</span> <span class="comment">// int c = a + b;</span></span><br><span class="line">  dassign %Reg0_I <span class="number">0</span> (dread i32 %Reg2_I)</span><br><span class="line">  #LINE HelloWorld.java : <span class="number">19</span>, INSTIDX : <span class="number">5</span>||<span class="number">0005</span>:  iload_2</span><br><span class="line">  dassign %Reg1_I <span class="number">0</span> (dread i32 %Reg3_I)</span><br><span class="line">  #LINE HelloWorld.java : <span class="number">19</span>, INSTIDX : <span class="number">6</span>||<span class="number">0006</span>:  iadd</span><br><span class="line">  dassign %Reg0_I <span class="number">0</span> (add <span class="title function_">i32</span> <span class="params">(dread i32 %Reg0_I, dread i32 %Reg1_I)</span>)</span><br><span class="line">  #LINE HelloWorld.java : <span class="number">19</span>, INSTIDX : <span class="number">7</span>||<span class="number">0007</span>:  istore_3</span><br><span class="line">  dassign %Reg4_I <span class="number">0</span> (dread i32 %Reg0_I)</span><br><span class="line">  #LINE HelloWorld.java : <span class="number">20</span>, INSTIDX : <span class="number">8</span>||0008:  <span class="keyword">return</span></span><br><span class="line">LOC <span class="number">1</span> <span class="number">20</span></span><br><span class="line">  <span class="keyword">return</span> ()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="from-cc">2.2 From C/C++</h5>
<p>如下显示C代码对应Maple IR的例子</p>
<p>C代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello World\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Maple IR，每个函数都被赋予了一个funcid。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">func</span> <span class="selector-tag">&amp;</span><span class="selector-tag">main</span> <span class="selector-tag">public</span> () <span class="selector-tag">i32</span> &#123;</span><br><span class="line">  <span class="selector-tag">funcid</span> <span class="number">108</span></span><br><span class="line">  <span class="selector-tag">funcinfo</span> &#123;</span><br><span class="line">    <span class="variable">@INFO_funcname</span> <span class="string">&quot;main&quot;</span>,</span><br><span class="line">    <span class="variable">@INFO_signature</span> <span class="string">&quot;main|&quot;</span>,</span><br><span class="line">    <span class="variable">@INFO_classname</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="variable">@INFO_fullname</span> <span class="string">&quot;main|()I&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-tag">var</span> %<span class="selector-tag">retvar_7</span> <span class="selector-tag">i32</span></span><br><span class="line">  <span class="selector-tag">var</span> %<span class="selector-tag">retvar_8</span> <span class="selector-tag">i32</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">LOC</span> <span class="number">2</span> <span class="number">19</span></span><br><span class="line">  <span class="selector-id">#printf</span>(<span class="string">&quot;Hello World\n&quot;</span>);</span><br><span class="line">  <span class="selector-tag">callassigned</span> <span class="selector-tag">&amp;</span><span class="selector-tag">printf</span> (conststr a64 <span class="string">&quot;Hello World\x0a&quot;</span>) &#123; <span class="selector-tag">dassign</span> %<span class="selector-tag">retvar_8</span> <span class="number">0</span> &#125;</span><br><span class="line"><span class="selector-tag">LOC</span> <span class="number">2</span> <span class="number">20</span></span><br><span class="line">  <span class="selector-id">#return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="selector-tag">return</span> (constval i32 <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>C代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">foo</span><span class="params">(<span class="type">int</span> i,<span class="type">int</span> j)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (i + j) * <span class="number">-998</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Maple
IR用树的形式表示statement，类似于AST的格式，组织嵌套的statement。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">func</span> <span class="selector-tag">&amp;</span><span class="selector-tag">foo</span> <span class="selector-tag">public</span> (var %i i32, var %j i32) <span class="selector-tag">i32</span> &#123;</span><br><span class="line">  <span class="selector-tag">funcid</span> <span class="number">108</span></span><br><span class="line">  <span class="selector-tag">funcinfo</span> &#123;</span><br><span class="line">    <span class="variable">@INFO_funcname</span> <span class="string">&quot;foo&quot;</span>,</span><br><span class="line">    <span class="variable">@INFO_signature</span> <span class="string">&quot;foo|II&quot;</span>,</span><br><span class="line">    <span class="variable">@INFO_classname</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="variable">@INFO_fullname</span> <span class="string">&quot;foo|(II)I&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-tag">var</span> %<span class="selector-tag">retvar_7</span> <span class="selector-tag">i32</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">LOC</span> <span class="number">2</span> <span class="number">19</span></span><br><span class="line">  <span class="selector-id">#return</span> (i + j) * <span class="selector-tag">-998</span>;</span><br><span class="line">  <span class="selector-tag">return</span> (mul i32 (</span><br><span class="line">    add i32 (dread i32 %i, dread i32 %j),</span><br><span class="line">    neg i32 (constval i32 <span class="number">998</span>)))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>C代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> a[<span class="number">10</span>];</span><br><span class="line"><span class="type">void</span> <span class="title function_">init</span><span class="params">(<span class="type">void</span>)</span> &#123;</span><br><span class="line">  <span class="type">int</span> i;</span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++)</span><br><span class="line">    a[i]=i*<span class="number">3</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Maple IR，从这里其实可以看出，可读的Maple
IR还是处于比较高层次的，因为用到了while关键字。</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">var $a &lt;[<span class="number">10</span>] f<span class="number">32</span>&gt; public used</span><br><span class="line">...</span><br><span class="line">func &amp;init public () void &#123;</span><br><span class="line">  funcid <span class="number">108</span></span><br><span class="line">  funcinfo &#123;</span><br><span class="line">    <span class="title">@INFO_funcname</span> <span class="string">&quot;init&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="title">@INFO_signature</span> <span class="string">&quot;init|&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="title">@INFO_classname</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="title">@INFO_fullname</span> <span class="string">&quot;init|()V&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">  var <span class="variable">%i</span> <span class="type">i32</span> public used</span><br><span class="line">  var <span class="variable">%condvar_9</span> <span class="type">i32</span></span><br><span class="line">  var <span class="variable">%post_10</span> <span class="type">i32</span></span><br><span class="line"></span><br><span class="line">LOC <span class="number">2</span> <span class="number">20</span></span><br><span class="line">  #int i<span class="comment">;</span></span><br><span class="line">LOC <span class="number">2</span> <span class="number">21</span></span><br><span class="line">  #for(i<span class="operator">=</span><span class="number">0</span><span class="comment">; i&lt;10; i++)</span></span><br><span class="line">  #i<span class="operator">=</span><span class="number">0</span><span class="comment">; i&lt;10; i++)</span></span><br><span class="line">  dassign <span class="variable">%i</span> <span class="number">0</span> (constval <span class="type">i32</span> <span class="number">0</span>)</span><br><span class="line">  dassign <span class="variable">%condvar_9</span> <span class="number">0</span> (lt <span class="type">i32</span> <span class="type">i32</span> (dread <span class="type">i32</span> <span class="variable">%i</span><span class="punctuation">,</span> constval <span class="type">i32</span> <span class="number">10</span>))</span><br><span class="line">  while (dread <span class="type">i32</span> <span class="variable">%condvar_9</span>) &#123;</span><br><span class="line">LOC <span class="number">2</span> <span class="number">22</span></span><br><span class="line">    #a[i]<span class="operator">=</span>i*<span class="number">3</span><span class="comment">;</span></span><br><span class="line">    iassign &lt;* f<span class="number">32</span>&gt; <span class="number">0</span> (</span><br><span class="line">      array <span class="number">0</span> ptr &lt;* &lt;[<span class="number">10</span>] f<span class="number">32</span>&gt;&gt; (addrof ptr $a<span class="punctuation">,</span> dread <span class="type">i32</span> <span class="variable">%i</span>)<span class="punctuation">,</span> </span><br><span class="line">      cvt f<span class="number">32</span> <span class="type">i32</span> (<span class="keyword">mul</span> <span class="type">i32</span> (dread <span class="type">i32</span> <span class="variable">%i</span><span class="punctuation">,</span> constval <span class="type">i32</span> <span class="number">3</span>)))</span><br><span class="line">    dassign <span class="variable">%post_10</span> <span class="number">0</span> (dread <span class="type">i32</span> <span class="variable">%i</span>)</span><br><span class="line">    dassign <span class="variable">%i</span> <span class="number">0</span> (<span class="keyword">add</span> <span class="type">i32</span> (dread <span class="type">i32</span> <span class="variable">%i</span><span class="punctuation">,</span> constval <span class="type">i32</span> <span class="number">1</span>))</span><br><span class="line">    dassign <span class="variable">%condvar_9</span> <span class="number">0</span> (lt <span class="type">i32</span> <span class="type">i32</span> (dread <span class="type">i32</span> <span class="variable">%i</span><span class="punctuation">,</span> constval <span class="type">i32</span> <span class="number">10</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>C代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">SS</span>&#123;</span></span><br><span class="line">  <span class="type">int</span> f1;</span><br><span class="line">  <span class="type">char</span> f2:<span class="number">6</span>;</span><br><span class="line">  <span class="type">char</span> f3:<span class="number">2</span>;</span><br><span class="line">&#125;SS;</span><br><span class="line">SS <span class="title function_">foo</span><span class="params">(SS x)</span>&#123;</span><br><span class="line">  x.f2=<span class="number">33</span>;</span><br><span class="line">  <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Maple
IR，这里我们可以看到field-ID不再是0，field-ID是为了方便直接访问一个结构体之中的field，而不是访问整个结构体。</p>
<ul>
<li>支持field-ID的结构有三种：struct、class、interface；除了这三种结构，field-ID也存在，其值为0，</li>
<li>field-ID的扩展主要是为了方便dassign、dread、iassign、iread这几条指令使用。</li>
<li>field-ID赋值的时候，最顶层的结构是给0，然后访问其内部的每个field，每个field给一个唯一的编号，然后每个field递增1，所以访问f2时field
ID是2；</li>
<li>如果要分配编号的field是一个结构，那么给其一个field-ID编号，并对其内部嵌套的field继续进行编号；</li>
<li>对于class而言，父类就像是子类的内部的结构，子类的第一个field就是父类；</li>
<li>如果一个结构既单独存在，又嵌套在另外一个结构之中，那么从不同的角度出发，这个结构的field会被分配不同field-ID编号，因为field-ID的分配是从顶层结构开始的；</li>
</ul>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">type</span> $SS &lt;struct &#123;</span><br><span class="line">  <span class="title">@f1</span> <span class="type">i32</span> public<span class="punctuation">,</span></span><br><span class="line">  <span class="title">@f2</span> :<span class="number">6</span> <span class="type">i8</span> public<span class="punctuation">,</span></span><br><span class="line">  <span class="title">@f3</span> :<span class="number">2</span> <span class="type">i8</span> public&#125;&gt;</span><br><span class="line">...</span><br><span class="line">func &amp;foo public (var <span class="variable">%x</span> &lt;$SS&gt;) &lt;$SS&gt; &#123;</span><br><span class="line">  funcid <span class="number">108</span></span><br><span class="line">  funcinfo &#123;</span><br><span class="line">    <span class="title">@INFO_funcname</span> <span class="string">&quot;foo&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="title">@INFO_signature</span> <span class="string">&quot;foo|SS;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="title">@INFO_classname</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="title">@INFO_fullname</span> <span class="string">&quot;foo|(SS;)SS;&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">  var <span class="variable">%retvar_7</span> &lt;$SS&gt;</span><br><span class="line"></span><br><span class="line">LOC <span class="number">2</span> <span class="number">24</span></span><br><span class="line">  #<span class="keyword">x</span>.f<span class="number">2</span><span class="operator">=</span><span class="number">33</span><span class="comment">;</span></span><br><span class="line">  dassign <span class="variable">%x</span> <span class="number">2</span> (cvt <span class="type">i8</span> <span class="type">i32</span> (constval <span class="type">i32</span> <span class="number">33</span>))</span><br><span class="line">LOC <span class="number">2</span> <span class="number">25</span></span><br><span class="line">  #return <span class="keyword">x</span><span class="comment">;</span></span><br><span class="line">  return (dread agg <span class="variable">%x</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>C代码</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">fact</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span>(n!=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> n*fact(n<span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Maple IR实现递归。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">func</span> <span class="selector-tag">&amp;</span><span class="selector-tag">fact</span> <span class="selector-tag">public</span> (var %n i32) <span class="selector-tag">i32</span> &#123;</span><br><span class="line">  <span class="selector-tag">funcid</span> <span class="number">108</span></span><br><span class="line">  <span class="selector-tag">funcinfo</span> &#123;</span><br><span class="line">    <span class="variable">@INFO_funcname</span> <span class="string">&quot;fact&quot;</span>,</span><br><span class="line">    <span class="variable">@INFO_signature</span> <span class="string">&quot;fact|I&quot;</span>,</span><br><span class="line">    <span class="variable">@INFO_classname</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="variable">@INFO_fullname</span> <span class="string">&quot;fact|(I)I&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-tag">var</span> %<span class="selector-tag">retvar_7</span> <span class="selector-tag">i32</span></span><br><span class="line">  <span class="selector-tag">var</span> %<span class="selector-tag">retvar_8</span> <span class="selector-tag">i32</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">LOC</span> <span class="number">2</span> <span class="number">19</span></span><br><span class="line">  <span class="selector-id">#if</span>(n!=<span class="number">1</span>)</span><br><span class="line">  <span class="selector-tag">if</span> (ne i32 i32 (dread i32 %n, constval i32 <span class="number">1</span>)) &#123;</span><br><span class="line"><span class="selector-tag">LOC</span> <span class="number">2</span> <span class="number">20</span></span><br><span class="line">    <span class="selector-id">#return</span> <span class="selector-tag">n</span>*<span class="selector-tag">fact</span>(n-<span class="number">1</span>);</span><br><span class="line">    <span class="selector-tag">callassigned</span> <span class="selector-tag">&amp;</span><span class="selector-tag">fact</span> (sub i32 (dread i32 %n, constval i32 <span class="number">1</span>)) &#123; <span class="selector-tag">dassign</span> %<span class="selector-tag">retvar_8</span> <span class="number">0</span> &#125;</span><br><span class="line">    <span class="selector-tag">dassign</span> %<span class="selector-tag">retvar_7</span> <span class="number">0</span> (mul i32 (dread i32 %n, dread i32 %retvar_8))</span><br><span class="line">    <span class="selector-tag">goto</span> @<span class="selector-tag">exit6</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-tag">else</span> &#123;</span><br><span class="line"><span class="selector-tag">LOC</span> <span class="number">2</span> <span class="number">21</span></span><br><span class="line">    <span class="selector-id">#return</span> <span class="number">1</span>;</span><br><span class="line">    <span class="selector-tag">dassign</span> %<span class="selector-tag">retvar_7</span> <span class="number">0</span> (constval i32 <span class="number">1</span>)</span><br><span class="line">    <span class="selector-tag">goto</span> @<span class="selector-tag">exit6</span></span><br><span class="line">  &#125;</span><br><span class="line">@<span class="selector-tag">exit6</span>   </span><br><span class="line">  <span class="selector-tag">return</span> (dread i32 %retvar_7)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>给定该Java程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="comment">// LA_3B_7C_3Cinit field-id is 1</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> a; <span class="comment">// field-id is 4</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">seta</span><span class="params">(<span class="type">int</span> b)</span> &#123; <span class="comment">// LA_3B_7Cseta_7C field-id is 2</span></span><br><span class="line">        a = b;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">geta</span><span class="params">()</span> &#123; <span class="comment">// LA_3B_7Cgeta_7C field-id is 3</span></span><br><span class="line">        <span class="keyword">return</span> a; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> <span class="keyword">extends</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">seta</span><span class="params">(<span class="type">int</span> b)</span> &#123;</span><br><span class="line">        a = b + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FieldId</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">B</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">B</span>();</span><br><span class="line">        obj.seta(<span class="number">3</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> obj.geta();</span><br><span class="line">        System.out.println(num);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>class A的field ID情况下：</p>
<p>1、LA_3B_7C_3Cinit....</p>
<p>2、LA_3B_7Cseta_7C....</p>
<p>3、LA_3B_7Cgeta_7C...</p>
<p>4、a</p>
<p>B的情况：</p>
<p>1、A</p>
<p>2、LA_3B_7C_3Cinit....</p>
<p>3、LA_3B_7Cseta_7C...</p>
<p>4、LA_3B_7Cgeta_7C...</p>
<p>5、a</p>
<p>6、LB_3B_7C_3Cinit....</p>
<p>7、LB_3B_7Cseta_7C...</p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="variable">%SS</span> &lt;struct &#123; <span class="title">@g1</span> f<span class="number">64</span><span class="punctuation">,</span> <span class="title">@g2</span> f<span class="number">64</span> &#125;&gt;</span><br><span class="line">var <span class="variable">%s</span> [struct&#123;<span class="title">@f1i32</span><span class="punctuation">,</span> <span class="title">@f2</span> &lt;<span class="variable">%SS</span>&gt;<span class="punctuation">,</span> <span class="title">@f3</span>:<span class="number">4</span> <span class="type">i32</span>&#125; <span class="operator">=</span> </span><br><span class="line">      [ <span class="number">1</span> <span class="operator">=</span> <span class="number">99</span><span class="punctuation">,</span></span><br><span class="line">        <span class="number">2</span> <span class="operator">=</span> [<span class="number">1</span><span class="operator">=</span> <span class="number">10.0</span>]<span class="punctuation">,</span>          # field f<span class="number">2</span>.g<span class="number">1</span> has field ID <span class="number">1</span> in struct <span class="variable">%SS</span> <span class="keyword">and</span> is initialized <span class="keyword">to</span> <span class="number">10.0</span></span><br><span class="line">        <span class="number">4</span> <span class="operator">=</span> <span class="number">22.2</span><span class="punctuation">,</span>               # field f<span class="number">2</span>.g<span class="number">2</span> has field ID <span class="number">4</span> in struct <span class="variable">%s</span> <span class="keyword">and</span> is initialized <span class="keyword">to</span> <span class="number">22.2</span></span><br><span class="line">        <span class="number">5</span> <span class="operator">=</span> <span class="number">15</span> ]                # field f<span class="number">3</span> (<span class="number">4</span> bits in size) has field ID <span class="number">5</span> in struct <span class="variable">%s</span> <span class="keyword">and</span> is initialized <span class="keyword">to</span> <span class="number">15</span></span><br></pre></td></tr></table></figure>
<h4 id="配置openark">3. 配置OpenArk</h4>
<p>首先配置方舟编译器主项目，主项目最后只能生成汇编程序<code>.s</code>，之后介绍两个的孵化器项目mapleall和maple
engine，可以再处理<code>.s</code>分别至运行C/C++的<code>.out</code>文件和java程序的<code>.so</code>文件，并分别利用<code>qemu-aarch64</code>和<code>maple_engine</code>运行。</p>
<h5 id="openark-compiler">3.1 OpenArk Compiler</h5>
<p>方舟编译器的总目录，下述项目mapleall属于FutureWei编译器分支，未来会合并到总目录这里。方舟编译器目录结构为：</p>
<ul>
<li>build：环境设置脚本，和一些build所用的Makefile</li>
<li>samples：示例程序目录，本次发布共公开了六个示例程序</li>
<li>src目录：源码目录，先介绍其中的mapleall目录
<ul>
<li>bin：直接提供的可执行文件</li>
<li>mpl_phase：maple phase的基本框架的代码</li>
<li>maple_driver：maple可执行程序的主要源码所在的位置，它会调用其他的maple_开头的目录的部分内容</li>
<li>maple_ipa：interleaved_manager和module_phase_manager的相关代码</li>
<li>maple_ir：针对maple的ir的基本操作的相关代码，与LLVM针对IR的基本操作类似，主要是对IR进行基本的分析，获取IR所要表达的信息，为之后的优化作准备。</li>
<li>maple_me：有关MeFuncPhase类别的phase的框架及其具体内容，这是phase相关的一部分，所有的具体的MeFuncPhase的子类，实现都在该目录之下。</li>
<li>mpl2mpl：包含从maple ir到maple
ir的转换，这种转换都是为了后续的me做准备，该目录下的主题内容是ModulePhase类别的Phase的具体实现。</li>
</ul></li>
<li>tools目录：为编译和使用过程中所用到的其他工具所预留的目录，该目录后续将存放llvm、gn、ninja</li>
</ul>
<p>首先安装如下依赖</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get -y install openjdk-8-jdk git-core build-essential zlib1g-dev libc6-dev-i386 g++-multilib gcc-multilib linux-libc-dev gcc-5-aarch64-linux-gnu g++-5-aarch64-linux-gnu unzip tar curl python3-paramiko python-paramiko python-requests</span><br></pre></td></tr></table></figure>
<p>在OpenArkcompiler目录下执行以下命令，编译出OpenArkCompiler，默认输出路径output/TYPE/bin。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> build/envsetup.sh arm debug <span class="comment"># 设置环境变量</span></span><br><span class="line">make setup <span class="comment"># 自动下载依赖包</span></span><br><span class="line">make <span class="comment"># 编译OpenArkCompiler</span></span><br><span class="line">make libcore <span class="comment">#编译maple runtime</span></span><br><span class="line">make testall <span class="comment"># 该命令会失败</span></span><br></pre></td></tr></table></figure>
<p>编译完成后，在<code>output/aarch64-clang-release/bin</code>目录下，可以看到编译出来的二进制文件，其中<code>dex2mpl/java2jar/jbc2mpl</code>在编译前就已经在目录<code>src/mapleall/bin</code>下了，只有maple是编译来的。</p>
<h6 id="java2jar">3.3.1 java2jar</h6>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">OUTPUT=<span class="variable">$1</span>                                       <span class="comment"># HelloWorld.jar</span></span><br><span class="line">CORE_ALL_JAR=<span class="variable">$2</span>                                 <span class="comment"># libjava-core/java-core.jar</span></span><br><span class="line"><span class="built_in">shift</span> 2</span><br><span class="line">javac -g -d . -bootclasspath <span class="variable">$&#123;CORE_ALL_JAR&#125;</span> <span class="variable">$@</span> <span class="comment"># -bootclasspath =&gt; -sourcepath</span></span><br><span class="line">                                                <span class="comment"># HelloWorld.java =&gt; HelloWorld.class</span></span><br><span class="line">jar -cvf <span class="variable">$&#123;OUTPUT&#125;</span> *.class                      <span class="comment"># HelloWorld.class =&gt; HelloWorld.jar</span></span><br></pre></td></tr></table></figure>
<p>该脚本类似于javac和jar的联合体，将java文件变成class文件后，再打包成jar文件，使用方法如下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HelloWorld.java =&gt; HelloWorld.class =&gt; HelloWorld.jar</span></span><br><span class="line">➜  helloworld git:(master) ✗ java2jar  HelloWorld.jar /home/wchenbt/OpenArkCompiler/output/aarch64-clang-release/libjava-core/java-core.jar <span class="string">&quot;HelloWorld.java&quot;</span></span><br><span class="line">added manifest</span><br><span class="line">adding: HelloWorld.class(<span class="keyword">in</span> = 534) (out= 329)(deflated 38%)</span><br><span class="line">➜  helloworld git:(master) ✗ <span class="built_in">ls</span></span><br><span class="line">HelloWorld.class  HelloWorld.jar  HelloWorld.java  Makefile</span><br><span class="line">➜  helloworld git:(master) ✗</span><br></pre></td></tr></table></figure>
<h6 id="jbc2mpl">3.3.2 jbc2mpl</h6>
<p>将class文件或者jar文件转化为maple IR格式，生成的是maple
IR的最高级形态，用法如下，运行后生成文件<code>HelloWorld.mpl</code>和<code>HelloWorld.mplt</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">➜  helloworld git:(master) ✗ jbc2mpl -mplt /home/wchenbt/OpenArkCompiler/output/aarch64-clang-release/libjava-core/java-core.mplt  HelloWorld.jar</span><br><span class="line">➜  helloworld git:(master) ✗ <span class="built_in">ls</span></span><br><span class="line">HelloWorld.class  HelloWorld.jar  HelloWorld.java  HelloWorld.mpl  HelloWorld.mplt  Makefile</span><br><span class="line">➜  helloworld git:(master) ✗</span><br></pre></td></tr></table></figure>
<p>也可以用如下命令运行该工具将<code>java-core.jar</code>转换为<code>mpl</code>格式以后续使用，编译别的文件需要加上<code>-mplt java-core.mplt</code>，因为java-core是java的核心类库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jbc2mpl -injar java-core.jar -out libjava-core</span><br></pre></td></tr></table></figure>
<h6 id="maple">3.3.3 maple</h6>
<p>所有的编译器都会有一个统一的命令入口，例如gcc命令，这个命令可以调用很多的工具来完成整个编译的过程，包括linker。在方舟编译器中，这个命令是maple，通过maple命令完成前端输入解析，中端优化，后端代码生成和链接。</p>
<p>针对maple
IR的一个工具，可以利用<code>--run=cmd1:cmd2</code>命令运行</p>
<ul>
<li>jbc2mpl：实际上是命令行运行和3.3.2的工具</li>
<li>me&amp;mpl2mpl：执行Module和Function的优化，生成HelloWorld.VtableImpl.mpl文件。</li>
<li>mplcg：将maple文件编译成汇编格式，生成HelloWorld.VtableImpl.s文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">➜  helloworld git:(master) ✗ maple --run=me:mpl2mpl --option=<span class="string">&quot; --O2 --quiet: --O2 --quiet --regnativefunc --no-nativeopt --maplelinker --emitVtableImpl&quot;</span> ./HelloWorld.mpl</span><br><span class="line">Starting mpl2mpl&amp;mplme</span><br><span class="line">Starting:./maple --run=me:mpl2mpl --option=<span class="string">&quot; --O2 --quiet: --O2 --quiet --regnativefunc --no-nativeopt --maplelinker --emitVtableImpl&quot;</span> ./HelloWorld.mpl</span><br><span class="line">Starting parse input</span><br><span class="line">Parse consumed 0s</span><br><span class="line">Processing mpl2mpl&amp;mplme</span><br><span class="line">[mpl2mpl] Module phases cost 117ms</span><br><span class="line">[me] Function phases cost 0ms</span><br><span class="line">[mpl2mpl] Module phases cost 17ms</span><br><span class="line"> Mpl2mpl&amp;mplme consumed 0s</span><br><span class="line">➜  helloworld git:(master) ✗ <span class="built_in">ls</span></span><br><span class="line">HelloWorld.class  HelloWorld.jar  HelloWorld.java  HelloWorld.mpl  HelloWorld.mplt  HelloWorld.VtableImpl.mpl  Makefile</span><br></pre></td></tr></table></figure>
<p>也可以直接运行如下命令，直接生成最终的汇编文件。java-core是java语言的基础类库，想要使用java的基础包就需要这个类库的支持。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">maple -O2 --mplt /home/wchenbt/OpenArkCompiler/output/aarch64-clang-release/libjava-core/java-core.mplt HelloWorld.jar</span><br></pre></td></tr></table></figure>
<h6 id="mplcg">3.3.4 mplcg</h6>
<p>该工具将mpl格式生成后段汇编代码，用法如下，需要通过maple来运行mplcg，运行后生成汇编文件<code>HelloWorld.VtableImpl.s</code>：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">➜  helloworld git:(master) ✗ maple --run=mplcg --option=<span class="string">&quot; --O2 --quiet --no-pie --verbose-asm --fpic --maplelinker&quot;</span> --infile ./HelloWorld.VtableImpl.mpl</span><br><span class="line">Mplcg Parser consumed 319ms</span><br><span class="line">Starting mplcg</span><br><span class="line">Starting:./maple --run=mplcg --option=<span class="string">&quot; --O2 --quiet --no-pie --verbose-asm --fpic --maplelinker&quot;</span> --infile ./HelloWorld.VtableImpl.mpl</span><br><span class="line">Processing mplcg</span><br><span class="line">Mplcg consumed 0s</span><br><span class="line">➜  helloworld git:(master) ✗ <span class="built_in">ls</span></span><br><span class="line">HelloWorld.class  HelloWorld.java  HelloWorld.mplt            HelloWorld.VtableImpl.primordials.txt  Makefile</span><br><span class="line">HelloWorld.jar    HelloWorld.mpl   HelloWorld.VtableImpl.mpl  HelloWorld.VtableImpl.s</span><br></pre></td></tr></table></figure>
<h6 id="irbuild">3.3.5 irbuild</h6>
<p>该工具不开源，是操作mplt文件，将其转换为二进制或者mpl文件。mplt是mpl的头文件，跟C一样，相当于<code>.h</code>，在maple的非后端过程中，都是使用mplt的头文件作为输入即可，链接的时候才需要使用mpl文件。将maple当成C语言来看待，maple的处理过程相当于C语言的编译过程，只需要使用其他单元的头文件声明处理当前的单元，链接的时候才需要其它的单元定义。</p>
<p>执行如下命令可以将<code>HelloWorld.mplt</code>转换为文本格式<code>HelloWorld.irb.mpl</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$&gt; irbuild i HelloWorld.mplt </span><br><span class="line">$&gt; <span class="built_in">ls</span></span><br><span class="line">HelloWorld.class    HelloWorld.jar   HelloWorld.mpl   HelloWorld.VtableImpl.mpl</span><br><span class="line">HelloWorld.irb.mpl  HelloWorld.java  HelloWorld.mplt  Makefile</span><br></pre></td></tr></table></figure>
<p>转换后文件内容如下，可以看出类似于C++的头文件。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">flavor <span class="number">1</span></span><br><span class="line">srclang <span class="number">3</span></span><br><span class="line">id <span class="number">65535</span></span><br><span class="line">numfuncs <span class="number">0</span></span><br><span class="line">type $LHelloWorld_3B &lt;class &lt;$Ljava_2Flang_2FObject_3B&gt; &#123;</span><br><span class="line">  <span class="meta">@INFO_srcfile</span> <span class="string">&quot;HelloWorld.java&quot;</span>,</span><br><span class="line">  <span class="meta">@INFO_classname</span> <span class="string">&quot;LHelloWorld_3B&quot;</span>,</span><br><span class="line">  <span class="meta">@INFO_classnameorig</span> <span class="string">&quot;LHelloWorld;&quot;</span>,</span><br><span class="line">  <span class="meta">@INFO_superclassname</span> <span class="string">&quot;Ljava_2Flang_2FObject_3B&quot;</span>,</span><br><span class="line">  <span class="meta">@INFO_attribute_string</span> <span class="string">&quot; public &quot;</span>,</span><br><span class="line">  <span class="meta">@INFO_access_flags</span> <span class="number">33</span>,</span><br><span class="line">  &amp;LHelloWorld_3B_7C_3Cinit_3E_7C_28_29V <span class="keyword">public</span> <span class="title function_">constructor</span> <span class="params">(&lt;* &lt;$LHelloWorld_3B&gt;&gt;)</span> <span class="keyword">void</span>,</span><br><span class="line">  &amp;LHelloWorld_3B_7Cmain_7C_28ALjava_2Flang_2FString_3B_29V <span class="keyword">public</span> <span class="title function_">static</span> <span class="params">(&lt;* &lt;[] &lt;* &lt;$Ljava_2Flang_2FString_3B&gt;&gt;&gt;&gt;)</span> <span class="keyword">void</span>&#125;&gt;</span><br><span class="line">type $Ljava_2Flang_2FString_3B &lt;classincomplete &#123;&#125;&gt;</span><br><span class="line">type $Ljava_2Flang_2FObject_3B &lt;classincomplete &#123;&#125;&gt;</span><br></pre></td></tr></table></figure>
<h6 id="others-1">3.3.6 others</h6>
<ul>
<li>dex2mpl</li>
<li>java2d8</li>
<li>maplegen</li>
</ul>
<p>到目前为止，我们完成了Java的编译过程<code>.jave =&gt;.class =&gt;.jar =&gt;.mpl =&gt;.s</code>。</p>
<p><img src="https://i.loli.net/2021/01/22/cAOmhzBoknJZ7qe.png" alt="image-20210122190033739" style="zoom:50%;" /></p>
<h5 id="mapleall-for-cc">3.2 Mapleall for C/C++</h5>
<p>https://gitee.com/openarkcompiler-incubator/mapleall
该项目是华为的孵化器项目，用来编译运行C/C++程序的项目。</p>
<p><code>bin/ast2mpl</code>是方舟编译器针对C的前端，用来将clangAST转化为方舟编译器的IR
Maple，但是并没开源，是直接上传的二进制。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> mapleall</span><br><span class="line">make setup</span><br><span class="line"><span class="comment"># choose one of the following four options</span></span><br><span class="line"><span class="built_in">source</span> envsetup.sh arm release <span class="comment"># for aarch64 target.s</span></span><br><span class="line"><span class="built_in">source</span> envsetup.sh engine release <span class="comment"># for maple engine target.s</span></span><br><span class="line"><span class="built_in">source</span> envsetup.sh ark release <span class="comment"># the same as engine</span></span><br><span class="line"><span class="built_in">source</span> envsetup.sh riscv release <span class="comment"># for riscv target.s</span></span><br><span class="line"><span class="comment"># ---</span></span><br><span class="line">make </span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>生成的二进制文件在<code>bin</code>目录下，每种编译方式对应不同目录<code>aarch64-clang-release</code>或<code>ark-clang-release</code>：</p>
<ul>
<li>ast2mpl</li>
<li>irbuild</li>
<li>maple</li>
<li>mplcg</li>
</ul>
<p>若要运行C程序，执行如下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> envsetup.sh arm release <span class="comment"># for aarch64 target.s</span></span><br><span class="line">make </span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>进入<code>examples/C</code>目录，运行<code>maple_aarch64_with_ast2mpl.sh</code>运行例子C程序<code>printHuawei.c</code>，该编译过程使用华为的前端<code>ast2mpl</code>，将ClangAST变为Maple
IR中间语言，编译过程为<code>.c -&gt; .mpl -&gt; .s -&gt; .out</code>，执行的命令如下。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># printHuawei.c =&gt; printHuawei.mpl</span></span><br><span class="line">mapleall/bin/ast2mpl printHuawei.c -I /usr/lib/gcc/x86_64-linux-gnu/8/include</span><br><span class="line"><span class="comment"># printHuawei.mpl =&gt; printHuawei.s</span></span><br><span class="line">mapleall/bin/aarch64-clang-release/maple -exe=me,mplcg -option=<span class="string">&quot;-O2 --quiet:-O2 -quiet&quot;</span> printHuawei.mpl</span><br><span class="line"><span class="comment"># printHuawei.s =&gt; printHuawei.out</span></span><br><span class="line">aarch64-linux-gnu-gcc -o printHuawei.out printHuawei.s</span><br><span class="line">qemu-aarch64 -L /usr/aarch64-linux-gnu/ printHuawei.out</span><br></pre></td></tr></table></figure>
<figure>
<img src="https://i.loli.net/2021/01/26/UWHA7fpgh38MOir.png"
alt="image-20210118213627783" />
<figcaption aria-hidden="true">image-20210118213627783</figcaption>
</figure>
<p>运行<code>maple_aarch64_with_whirl2mpl.sh</code>运行例子C程序<code>printHuawei.c</code>，该编译过程使用Open64的前端，将C程序变为Whirl
IR中间语言。如果自己<code>aarch64-linux-gnu-gcc</code>的版本是7的话，需要修改<code>whirl2mpl</code>这个脚本里的<code>FLAGS</code>如下所示。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FLAGS=<span class="string">&quot;-cc1 -emit-llvm -triple aarch64-linux-gnu -D__clang__ -D__BLOCKS__ -isystem /usr/aarch64-linux-gnu/include -isystem /usr/lib/gcc-cross/aarch64-linux-gnu/7/include&quot;</span></span><br></pre></td></tr></table></figure>
<p>运行结果如图所示，编译过程为<code>.c -&gt; .B -&gt; .bpl -&gt; .s -&gt; .out</code>。</p>
<figure>
<img src="https://i.loli.net/2021/01/26/hfGZSJHq8gm21iT.png"
alt="image-20210118215951069" />
<figcaption aria-hidden="true">image-20210118215951069</figcaption>
</figure>
<p>现在我们完成了用方舟编译器编译C/C++项目的过程。</p>
<p><img src="https://i.loli.net/2021/01/22/EWgLx7VaFQYSCO3.png" alt="image-20210122200756840" style="zoom:40%;" /></p>
<h5 id="maple-engine-for-java">3.3 Maple Engine for Java</h5>
<p>https://gitee.com/openarkcompiler-incubator/maple_engine</p>
<p>该项目也是一个孵化器项目，用来编译运行Java程序的项目，该项目会自动拉取编译上述mapleall项目。首先安装所需的软件包</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install -y build-essential clang cmake libffi-dev libelf-dev libunwind-dev libssl-dev openjdk8-jdk openjdk-8-jdk-headless unzip python-minimal python3 gdb bc</span><br></pre></td></tr></table></figure>
<p>下载代码并设置Maple构建环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://gitee.com/openarkcompiler-incubator/maple_engine.git</span><br><span class="line"><span class="built_in">cd</span> maple_engine</span><br><span class="line"><span class="built_in">source</span> ./envsetup.sh</span><br></pre></td></tr></table></figure>
<p>构建Maple编译器和Maple Engine</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./maple_build/tools/build-maple.sh</span><br></pre></td></tr></table></figure>
<p>在另一台电脑构建定制的OpenJDK8，将构建Java核心库libcore.so和运行用户Java程序所需的如下jar文件拷贝到构建maple_engine的./maple_build/jar/目录下。<a
target="_blank" rel="noopener" href="https://gitee.com/openarkcompiler-incubator/maple_engine/blob/master/maple_build/doc/build_OpenJDK8.md">Official
Document</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Java 核心库</span></span><br><span class="line">rt.jar (customized)</span><br><span class="line">charsets.jar</span><br><span class="line">jce.jar</span><br><span class="line">jsse.jar</span><br></pre></td></tr></table></figure>
<p>其中一个组件 rt.jar 是方舟引擎定制版. 要生成方舟引擎定制版的 rt.jar
文件, 需要修改 OpenJDK-8 的 Object.java
，然后从源代码构建OpenJDK-8。首先安装以下依赖，</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install mercurial build-essential cpio zip libx11-dev libxext-dev libxrender-dev \</span><br><span class="line">      libxtst-dev libxt-dev libcups2-dev libfreetype6-dev libasound2-dev libfontconfig1-dev</span><br></pre></td></tr></table></figure>
<p>下载OpenJDK-8的源码，在运行maple
engine的电脑上查看安装的OpenJDK-8-JRE的修订版本号</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ apt list openjdk-8-jre</span><br><span class="line">Listing... Done</span><br><span class="line">openjdk-8-jre/bionic-updates,bionic-security,now 8u275-b01-0ubuntu1~18.04 amd64 [installed]</span><br><span class="line">N: There is 1 additional version. Please use the <span class="string">&#x27;-a&#x27;</span> switch to see it</span><br></pre></td></tr></table></figure>
<p>根据上述命令输出的版本号在构建定制OpenJDK8的电脑上执行下述命令，下载源码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">hg <span class="built_in">clone</span> http://hg.openjdk.java.net/jdk8u/jdk8u -r jdk8u275-b01 ~/my_openjdk8</span><br><span class="line"><span class="built_in">cd</span> ~/my_openjdk8</span><br><span class="line">bash ./get_source.sh</span><br></pre></td></tr></table></figure>
<p>修改<code>~/my_openjdk8/jdk/src/share/classes/java/lang/Object.java</code>文件，插入如下字段声明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Object</span> &#123;</span><br><span class="line">    <span class="type">long</span> reserved_1; <span class="type">int</span> reserved_2; <span class="comment">// Add two extra fields here  在这添加两个额外字段</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">registerNatives</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>
<p>构建定制的OpenJDK-8</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/my_openjdk8</span><br><span class="line">bash ./configure</span><br><span class="line"><span class="built_in">export</span> DISABLE_HOTSPOT_OS_VERSION_CHECK=ok</span><br><span class="line">make all</span><br></pre></td></tr></table></figure>
<p>把如下的已经构建好的.jar文件复制到运行maple
engine机器上的目录maple_build/jar/ 下：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">build<span class="regexp">/linux-x86_64-normal-server-release/im</span>ages<span class="regexp">/lib/</span>rt.jar</span><br><span class="line">build<span class="regexp">/linux-x86_64-normal-server-release/im</span>ages<span class="regexp">/lib/</span>jce.jar</span><br><span class="line">build<span class="regexp">/linux-x86_64-normal-server-release/im</span>ages<span class="regexp">/lib/</span>jsse.jar</span><br><span class="line">build<span class="regexp">/linux-x86_64-normal-server-release/im</span>ages<span class="regexp">/lib/</span>charsets.jar</span><br></pre></td></tr></table></figure>
<p>修改<code>maple_build/tools/build-libcore.sh</code>中的<code>-bootclasspath</code>为<code>-sourcepath</code>，执行如下命令构建Java核心库</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./maple_build/tools/build-libcore.sh</span><br></pre></td></tr></table></figure>
<p>所有编译用户程序所需代码在目录maple_runtime/lib/x86_64目录下，主要就是<code>libcore.so</code>，另外还有几个工具用来编译运行java程序，在<code>maple_build/tools</code>目录下：</p>
<ul>
<li>java2asm.sh
<ul>
<li>javac: java to java bytecode</li>
<li>jbc2mpl: java bytecode to maple</li>
<li>maple: maple to assembly</li>
</ul></li>
<li>asm2so.sh
<ul>
<li>g++: .s -&gt; .o -&gt; .so</li>
</ul></li>
<li>run-app.sh</li>
</ul>
<p>给定如下Java程序</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloWorld</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Hello World!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行如下命令对其进行编译</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># MAPLE_BUILD_TOOLS = maple_build/tools</span></span><br><span class="line"><span class="built_in">cd</span> maple_build/examples/HelloWorld</span><br><span class="line"><span class="comment"># .java -&gt; .mpl -&gt; .s</span></span><br><span class="line"><span class="string">&quot;<span class="variable">$MAPLE_BUILD_TOOLS</span>&quot;</span>/java2asm.sh HelloWorld.java</span><br><span class="line"><span class="comment"># .s -&gt; .so</span></span><br><span class="line"><span class="string">&quot;<span class="variable">$MAPLE_BUILD_TOOLS</span>&quot;</span>/asm2so.sh HelloWorld.s</span><br></pre></td></tr></table></figure>
<p>执行如下命令运行该程序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;<span class="variable">$MAPLE_BUILD_TOOLS</span>&quot;</span>/run-app.sh -classpath ./HelloWorld.so HelloWorld</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2021/01/26/QmrfZsvKB9TLFCX.png" style="zoom:87%;" /></p>
<p>调试应用程序</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;<span class="variable">$MAPLE_BUILD_TOOLS</span>&quot;</span>/run-app.sh -gdb -classpath ./HelloWorld.so HelloWorld</span><br></pre></td></tr></table></figure>
<p>Now, we are able to compile and run both Java and C/C++ programs. The
compilation process for Java is shown below:</p>
<p><img src="https://i.loli.net/2021/01/23/9fhxQqVCrjY8LmR.png" alt="image-20210123152622279" style="zoom: 43%;" /></p>
<p>The compilation process for C/C++ is shown below:</p>
<p><img src="https://i.loli.net/2021/01/23/FHrMeEnm86cdbfi.png" alt="image-20210123152952757" style="zoom:43%;" /></p>
<h4 id="phase介绍">4. Phase介绍</h4>
<p>官方Phase介绍
https://gitee.com/openarkcompiler/OpenArkCompiler/blob/master/doc/cn/CompilerPhaseDescription.md</p>
<p>方舟编译器引入了一个phase的概念，这个概念有点类似于LLVM的pass，用于管理方舟编译器的优化。方舟编译器实现三级管理机制，InterleavedManager负责PhaseManager的创建、管理和运行；PhaseManager负责Phase的创建、管理和运行。</p>
<p><img src="https://i.loli.net/2021/01/20/gEvT3aWi8j1HVbq.png" alt="image-20210120164825674" style="zoom:40%;" /></p>
<h5 id="自定义phase类">4.1 自定义Phase类</h5>
<p>Phase的核心是重载Run函数，类似于LLVM
Pass的runOnXXX函数。Phase中端主要包含两大类ModulePhase和MeFuncPhase，都继承自Phase类。ModulePhase的定义在<code>src/maple_ipa/include/module_phase.h</code>，MeFuncPhase的定义在<code>src/maple_me/include/me_phase.h</code>中。当添加一个新的phase的时候，必须要实现一个Run方法，并重写PhaseName方法返回名字，例子如下：</p>
<p>定义新的Function Phase</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> maple &#123; </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MeDoExample</span> : <span class="keyword">public</span> MeFuncPhase &#123; <span class="comment">// 继承MeFuncPhase </span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">MeDoExample</span><span class="params">(MePhaseID id)</span> : MeFuncPhase(id) &#123;</span>&#125;;</span><br><span class="line">    <span class="keyword">virtual</span> ~<span class="built_in">MeDoExample</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="comment">// 需要重载的函数</span></span><br><span class="line">    <span class="function">AnalysisResult *<span class="title">Run</span><span class="params">(MeFunction *func, MeFuncResultMgr *m, ModuleResultMgr *mrm)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="comment">// 重写该函数的返回值</span></span><br><span class="line">    <span class="function">std::string <span class="title">PhaseName</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;me_example&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">&#125; <span class="comment">// namespace maple</span></span><br></pre></td></tr></table></figure>
<p>定义新的Module Phase</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> maple &#123; </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DoExample</span> : <span class="keyword">public</span> ModulePhase &#123; <span class="comment">// 继承ModulePhase</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">explicit</span> <span class="title">DoExample</span><span class="params">(ModulePhaseID id)</span> : ModulePhase(id) &#123;</span>&#125;;</span><br><span class="line">    ~<span class="built_in">DoExample</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="comment">// 需要重载的函数</span></span><br><span class="line">    <span class="function">AnalysisResult *<span class="title">Run</span><span class="params">(MIRModule *<span class="keyword">module</span>, ModuleResultMgr *mgr)</span> <span class="keyword">override</span></span>;</span><br><span class="line">    <span class="comment">// 重写该函数的返回值</span></span><br><span class="line">    <span class="function">std::string <span class="title">PhaseName</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;example&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;  <span class="comment">// namespace maple</span></span><br></pre></td></tr></table></figure>
<p>The role that <code>Run</code> method plays is the same as
<code>runOnXXX</code> method places in LLVM Pass.</p>
<h5 id="phasemanager">4.2 PhaseManager</h5>
<p>和LLVM
Pass一样，Phase都是由Manager类来管理。PhaseManager负责phase的创建、管理和运行。ModulePhase和MeFuncPhase都有对应的Manager类，分别是ModulePhaseManager和MeFuncPhaseManager，他们都是PhaseManager类的子类。Phase使用了宏的机制来实现注册，便于管理需要注册的phase。</p>
<p>ModulePhase有一个对应的<code>module_phases.def</code>文件定义系统内部的module
phase。ModulePhaseManager调用<code>RegisterModulePhases</code>函数注册定义在<code>src/maple_ipa/include/module_phases.def</code>中的phase，<code>module_phases.def</code>的内容如下：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">MODAPHASE</span><span class="params">(MoPhase_CLONE, DoClone)</span></span></span><br><span class="line"><span class="function"><span class="title">MODAPHASE</span><span class="params">(MoPhase_CHA, DoKlassHierarchy)</span></span></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><code>MODAPHASE</code>第一个参数是id，第二个是phase类名，需要添加自定义的<code>DoExample</code>时，只需添加如下一行：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">MODAPHASE</span><span class="params">(MoPhase_Example, DoExample)</span></span></span><br></pre></td></tr></table></figure>
<p>MeFuncPhase有对应的<code>me_phases.def</code>文件。MeFuncPhaseManager调用<code>RegisterFuncPhases</code>函数注册定义在<code>src/maple_me/include/me_phases.def</code>中的phase，<code>me_phases.def</code>的内容如下：</p>
<figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FUNCAPHASE(MeFuncPhase_DOMINANCE, MeDoDominance)</span><br><span class="line">FUNCAPHASE(MeFuncPhase_SSATAB, MeDoSSATab)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p><code>FUNCAPHASE</code>第一个参数是id，第二个是phase类名，需要自定义的<code>MeDoExample</code>时，只需添加如下一行：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">FUNCTPHASE</span><span class="params">(MeFuncPhase_Example, MeDoExample)</span></span></span><br></pre></td></tr></table></figure>
<p>注册Phase后，会调用基类PhaseManager的AddPhase函数添加自定义的phase。</p>
<h5 id="interleavedmanager-driverrunner">4.3 InterleavedManager
&amp;&amp; DriverRunner</h5>
<p>除了使用上面的方式自行添加phase外，还需要借助InterleavedManager和DriverRunner组成的框架对添加自定义Phase。</p>
<p>InterleavedManager负责phase
manager的创建、管理和运行。通过调用AddPhases接口，它将创建一个对应类型的phase
manager并添加进MapleVector中, 同时该phase
manager相应的phase注册、添加也会自动被触发。</p>
<p>DriverRunner包含了从一个mpl文件到优化结果文件的所有过程。</p>
<ul>
<li><p>ParseInput方法负责解析mpl文件，为后续mpl2mpl做准备工作，也为支持phase的运行</p></li>
<li><p>ProcessMpl2mplAndMePhases方法通过InterleavedManager加载<code>phases.def</code>，实现phase的管理和运行，</p></li>
</ul>
<p>DriverRunner也是通过宏的方式来集中管理phase，在<code>phases.def</code>文件里添加phase，然后通过InitPhases接口来遍历所有的phase并创建对应的phase
manager。<code>phases.def</code>文件内容如下：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Phase arguments are: name, condition. By default, all phases are required, so the condition value is &#x27;true&#x27;.</span></span><br><span class="line"><span class="comment">// You can use condition to control these phases and your custom phases. E.g. ADD_PHASE(&quot;custom_phase&quot;, option1 == value1 [more conditions...])</span></span><br><span class="line"><span class="function"><span class="title">ADD_PHASE</span><span class="params">(<span class="string">&quot;clone&quot;</span>, true)</span></span></span><br><span class="line"><span class="function"><span class="title">ADD_PHASE</span><span class="params">(<span class="string">&quot;vtableanalysis&quot;</span>, true)</span></span></span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="title">ADD_PHASE</span><span class="params">(<span class="string">&quot;CodeReLayout&quot;</span>, MeOption::optLevel == <span class="number">2</span>)</span></span></span><br></pre></td></tr></table></figure>
<p>第一个参数是phase名字，第二个参数是条件。现有的phase默认都是enable的，对于自定义的phase可以自行添加控制条件。</p>
<h5 id="phase运行机制">4.4 Phase运行机制</h5>
<p>maple指令中的运行的mpl2mpl2和maple这两个过程是通过执行ModulePhase和MeFuncPhase这两类phase来实现的。mpl2mpl的优化对应着ModulePhase这类的phase，mplme的优化对应着MeFuncPhase这类phase。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">➜  helloworld git:(master) ✗ maple --run=me:mpl2mpl --option=<span class="string">&quot; --O2 --quiet: --O2 --quiet --regnativefunc --no-nativeopt --maplelinker --emitVtableImpl&quot;</span> ./HelloWorld.mpl</span><br><span class="line">Starting mpl2mpl&amp;mplme</span><br><span class="line">Starting:./maple --run=me:mpl2mpl --option=<span class="string">&quot; --O2 --quiet: --O2 --quiet --regnativefunc --no-nativeopt --maplelinker --emitVtableImpl&quot;</span> ./HelloWorld.mpl</span><br><span class="line">Starting parse input</span><br><span class="line">Parse consumed 0s</span><br><span class="line">Processing mpl2mpl&amp;mplme</span><br><span class="line">[mpl2mpl] Module phases cost 117ms</span><br><span class="line">[me] Function phases cost 0ms</span><br><span class="line">[mpl2mpl] Module phases cost 17ms</span><br><span class="line"> Mpl2mpl&amp;mplme consumed 0s</span><br></pre></td></tr></table></figure>
<p>maple包含了多个compiler，包括jbc2mpl、me、mpl2mpl、mplcg，其参数列表之中的--run选项显示如下。</p>
<p><img src="https://i.loli.net/2021/01/20/9JdCpVYWc2GDzS1.png" alt="image-20210120190522535" style="zoom:70%;" /></p>
<p>maple运行过程中会直接调用这几个compiler，但jbc2mpl还是用的bin目录下的。</p>
<figure>
<img src="https://i.loli.net/2021/01/20/P1KRtkcwfdImuZY.png"
alt="image-20210120190802474" />
<figcaption aria-hidden="true">image-20210120190802474</figcaption>
</figure>
<ol type="1">
<li><p>(src/maple_driver/src/maple.cpp) main &lt;= Entry point of
maple</p>
<ul>
<li>CompilerFactory: :GetInstance().Compile(mplOptions)</li>
</ul></li>
<li><p>CompilerFactory构造函数：add the following compiler to supported
compiler</p>
<ul>
<li>ADD_COMPILER("jbc2mpl", Jbc2MplCompiler)</li>
<li>ADD_COMPILER("me", MapleCombCompiler)</li>
<li>ADD_COMPILER("mpl2mpl", MapleCombCompiler)</li>
<li>ADD_COMPILER("mplcg", MplcgCompiler)</li>
</ul></li>
<li><p>CompilerFactory.Compiler</p>
<ul>
<li>compiler = compilerSelector.Select</li>
<li>compiler.Compile</li>
</ul></li>
<li><p>MapleCombCompiler.Compile</p>
<ul>
<li>DriverRunner.Run</li>
</ul></li>
<li><p>DriverRunner.Run</p>
<ul>
<li>DriverRunner.ParseInput：解析mpl文件</li>
<li>DriverRunner.ProcessMpl2mplAndMePhases</li>
</ul></li>
<li><p>DriverRunner.ProcessMpl2mplAndMePhases</p>
<ul>
<li>DriverRunner.InitPhases：添加<code>phases.def</code>中的Phase，并根据其类型添加到各自的Phase
Manager的数据结构中
<ul>
<li>InterleavedManager.AddPhases</li>
</ul></li>
<li>InterleavedManager.run
<ul>
<li>ModulePhaseManager.run</li>
<li>MeFuncPhaseManager.run</li>
</ul></li>
</ul></li>
<li><p>InterleavedManager.AddPhases</p>
<ul>
<li>ModulePhase
<ul>
<li>ModulePhaseManager.RegisterModulePhases
<code>module_phases.def</code></li>
<li>ModulePhaseManager.AddModulePhases</li>
</ul></li>
<li>MeFuncPhase
<ul>
<li>MeFuncPhaseManager.RegisterFuncPhases
<code>me_phases.def</code></li>
<li>MeFuncPhaseManager.AddPhasesNoDefault</li>
</ul></li>
</ul></li>
</ol>
<h4 id="自定义phase">5. 自定义Phase</h4>
<h5 id="自定义module-phase">5.1 自定义Module Phase</h5>
<p>在<code>src/mapleall/mpl2mpl/</code>目录下写入自定义的ModulePhase，创建继承<code>ModulePhase</code>的类<code>DoExample</code>，头文件<code>example.h</code>和cpp文件<code>example.cpp</code>如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mapleall/mpl2mpl/src/example.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;module_phase.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> maple &#123;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DoExample</span> : <span class="keyword">public</span> ModulePhase &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">DoExample</span><span class="params">(ModulePhaseID id)</span> : ModulePhase(id) &#123;</span> &#125;;</span><br><span class="line">	~<span class="built_in">DoExample</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">std::string <span class="title">PhaseName</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;example&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function">AnalysisResult *<span class="title">Run</span><span class="params">(MIRModule *mod, ModuleResultMgr* mrm)</span> <span class="keyword">override</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>该Phase仅输出当前module的entry function名。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mapleall/mpl2mpl/src/example.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;example.h&quot;</span></span></span><br><span class="line"><span class="keyword">namespace</span> maple &#123;</span><br><span class="line"><span class="function">AnalysisResult *<span class="title">DoExample::Run</span><span class="params">(MIRModule *<span class="keyword">module</span>, ModuleResultMgr *mgr)</span> </span>&#123;</span><br><span class="line">	LogInfo::<span class="built_in">MapleLogger</span>() &lt;&lt; <span class="string">&quot;Harper&quot;</span> &lt;&lt; <span class="keyword">module</span>-&gt;<span class="built_in">GetEntryFuncName</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>src/mapleall/mpl2mpl/BUILD.gn</code>中将该类添加至被编译的对象中</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># src/mapleall/mpl2mpl/BUILD.gn</span></span><br><span class="line"><span class="attr">src_libmpl2mpl</span> = [</span><br><span class="line">  <span class="string">&quot;src/class_init.cpp&quot;</span>,</span><br><span class="line">  ...</span><br><span class="line">  <span class="string">&quot;src/example.cpp&quot;</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>在Module
Phase对应的文件中<code>src/mapleall/maple_ipa/include/module_phases.def</code>中加入自定义的Phase</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">MODAPHASE</span><span class="params">(MoPhase_Example, DoExample)</span></span></span><br></pre></td></tr></table></figure>
<p>相应的，在<code>src/mapleall/maple_ipa/src/module_phase_manager.cpp</code>中加入头文件</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;module_phase_manager.h&quot;</span></span></span><br><span class="line">...</span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;call_graph.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;example.h&quot;</span>       <span class="comment">// &lt;== example.h</span></span></span><br></pre></td></tr></table></figure>
<p>在全局Phase文件<code>src/mapleall/maple_driver/defs/phases.def</code>中添加自定义的Phase</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ADD_PHASE(<span class="string">&quot;example&quot;</span>, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>
<p>在OpenArk Compiler主目录执行如下命令，重新编译maple</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make maple</span><br></pre></td></tr></table></figure>
<p>进入<code>samples/helloworld</code>目录下，依次执行如下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HelloWorld.java =&gt; HelloWorld.class =&gt; HelloWorld.jar</span></span><br><span class="line">java2jar HelloWorld.jar /home/harper/Projects/OpenArkCompiler/output/aarch64-clang-release/libjava-core/java-core.jar <span class="string">&quot;HelloWorld.java&quot;</span></span><br><span class="line"><span class="comment"># HelloWorld.jar =&gt; HelloWorld.mpl, HelloWorld.mpltls </span></span><br><span class="line">jbc2mpl -mplt /home/harper/Projects/OpenArkCompiler/output/aarch64-clang-release/libjava-core/java-core.mplt  HelloWorld.jar</span><br><span class="line"><span class="comment"># HelloWorld.mpl =&gt; HelloWorld.VtableImpl.mpl</span></span><br><span class="line">maple --run=me:mpl2mpl --option=<span class="string">&quot; --O2 --quiet: --O2 --quiet --regnativefunc --no-nativeopt --maplelinker --emitVtableImpl&quot;</span> ./HelloWorld.mpl</span><br></pre></td></tr></table></figure>
<p>运行情况如下，我们可以看到在最后一步，输出了我们自己编写Phase的信息<code>HarperLHelloWorld_3B_7Cmain_7C_28ALjava_2Flang_2FString_3B_29V</code>。</p>
<figure>
<img src="https://i.loli.net/2021/01/21/WwgG4Ntye2fzR9X.png"
alt="image-20210121183226924" />
<figcaption aria-hidden="true">image-20210121183226924</figcaption>
</figure>
<h5 id="自定义function-phase">5.2 自定义Function Phase</h5>
<p>在<code>src/mapleall/maple_me/</code>目录下写入自定义的MeFuncPhase，创建继承<code>MeFuncPhase</code>的<code>MeDoMeExample</code>类，头文件<code>me_example.h</code>和cpp文件<code>me_example.cpp</code>如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mapleall/maple_me/include/me_example.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;me_phase.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> maple &#123;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MeDoMeExample</span>: <span class="keyword">public</span> MeFuncPhase &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">MeDoMeExample</span><span class="params">(MePhaseID id)</span> : MeFuncPhase(id) &#123;</span>&#125;;</span><br><span class="line">	<span class="keyword">virtual</span> ~<span class="built_in">MeDoMeExample</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">AnalysisResult *<span class="title">Run</span><span class="params">(MeFunction *func, MeFuncResultMgr *m, ModuleResultMgr *mrm)</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function">std::string <span class="title">PhaseName</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;me_example&quot;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当前只输出每个函数的名称。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mapleall/maple_me/src/me_example.cpp</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;me_example.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;me_function.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> maple &#123;</span><br><span class="line"><span class="function">AnalysisResult *<span class="title">MeDoMeExample::Run</span><span class="params">(MeFunction *func, MeFuncResultMgr *m, ModuleResultMgr *mrm)</span> </span>&#123;</span><br><span class="line">	LogInfo::<span class="built_in">MapleLogger</span>() &lt;&lt; <span class="string">&quot;Harper &quot;</span> &lt;&lt; func-&gt;<span class="built_in">GetName</span>() &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>src/mapleall/maple_me/BUILD.gn</code>文件中添加<code>me_example.cpp</code>到被编译的对象中，</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">src_libmplme = [</span><br><span class="line">  <span class="string">&quot;src/dse.cpp&quot;</span>,</span><br><span class="line">  ...</span><br><span class="line">  <span class="string">&quot;src/me_example.cpp&quot;</span> &lt;== <span class="keyword">new</span> <span class="type">phase</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>在定义Function
Phase的文件<code>src/mapleall/maple_me/include/me_phases.def</code>中加入如下信息</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">FUNCAPHASE</span><span class="params">(MeFuncPhase_DOEXAMPLE, MeDoMeExample)</span></span></span><br></pre></td></tr></table></figure>
<p>并在相应<code>src/mapleall/maple_me/src/me_phase_manager.cpp</code>中加入头文件</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;me_example.h&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>最后在全局Phase文件<code>src/mapleall/maple_driver/defs/phases.def</code>中加入该Phase</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">ADD_PHASE</span><span class="params">(<span class="string">&quot;me_example&quot;</span>, true)</span></span></span><br></pre></td></tr></table></figure>
<p>在OpenArk Compiler主目录执行如下命令，重新编译maple</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make maple</span><br></pre></td></tr></table></figure>
<p>进入<code>samples/helloworld</code>目录下，依次执行如下命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HelloWorld.java =&gt; HelloWorld.class =&gt; HelloWorld.jar</span></span><br><span class="line">java2jar HelloWorld.jar /home/harper/Projects/OpenArkCompiler/output/aarch64-clang-release/libjava-core/java-core.jar <span class="string">&quot;HelloWorld.java&quot;</span></span><br><span class="line"><span class="comment"># HelloWorld.jar =&gt; HelloWorld.mpl, HelloWorld.mpltls </span></span><br><span class="line">jbc2mpl -mplt /home/harper/Projects/OpenArkCompiler/output/aarch64-clang-release/libjava-core/java-core.mplt  HelloWorld.jar</span><br><span class="line"><span class="comment"># HelloWorld.mpl =&gt; HelloWorld.VtableImpl.mpl</span></span><br><span class="line">maple --run=me:mpl2mpl --option=<span class="string">&quot; --O2 --quiet: --O2 --quiet --regnativefunc --no-nativeopt --maplelinker --emitVtableImpl&quot;</span> ./HelloWorld.mpl</span><br></pre></td></tr></table></figure>
<p>运行情况如下，我们可以看到在最后一步，输出了我们自己编写Phase的信息。</p>
<figure>
<img src="https://i.loli.net/2021/01/21/9qe5yaCPNSxb2pV.png"
alt="image-20210121193556088" />
<figcaption aria-hidden="true">image-20210121193556088</figcaption>
</figure>
<h4 id="插桩示例">7. 插桩示例</h4>
<p>接下来，我们做一些插桩的工作，针对如下c文件，我们希望在main函数中添加第12行对函数f1的调用。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">f1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;f1\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">f2</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;f2\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// f1(); &lt;== to be added </span></span><br><span class="line">	<span class="built_in">f2</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们先进入mapleall目录下，执行<code>ast2mpl</code>命令，先获得该文件对应的maple
IR</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/ast2mpl test.c -I /usr/lib/gcc/x86_64-linux-gnu/8/include</span><br></pre></td></tr></table></figure>
<p>该文件IR如下，我们需要在14行添加<code>call &amp;f1()</code></p>
<figure class="highlight llvm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># ast<span class="number">2</span>mpl test.<span class="keyword">c</span> -I /usr/lib/gcc/<span class="keyword">x</span><span class="number">86</span>_<span class="number">64</span>-linux-gnu/<span class="number">8</span>/include</span><br><span class="line">func &amp;main public () <span class="type">i32</span> &#123;</span><br><span class="line">  funcid <span class="number">110</span></span><br><span class="line">  funcinfo &#123;</span><br><span class="line">    <span class="title">@INFO_funcname</span> <span class="string">&quot;main&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="title">@INFO_signature</span> <span class="string">&quot;main|&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="title">@INFO_classname</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="title">@INFO_fullname</span> <span class="string">&quot;main|()I&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line">  var <span class="variable">%retvar_12</span> <span class="type">i32</span></span><br><span class="line">  var <span class="variable">%retvar_13</span> <span class="type">i32</span></span><br><span class="line"></span><br><span class="line">LOC <span class="number">2</span> <span class="number">12</span></span><br><span class="line">  #<span class="keyword">call</span> &amp;f<span class="number">1</span>()  &lt;<span class="operator">=</span><span class="operator">=</span> <span class="keyword">to</span> be added</span><br><span class="line">  #f<span class="number">2</span>()<span class="comment">;</span></span><br><span class="line">  callassigned &amp;f<span class="number">2</span> () &#123; dassign <span class="variable">%retvar_13</span> <span class="number">0</span> &#125;</span><br><span class="line">LOC <span class="number">2</span> <span class="number">13</span></span><br><span class="line">  #return <span class="number">0</span><span class="comment">;</span></span><br><span class="line">  return (constval <span class="type">i32</span> <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们定义如下<code>MeDoMeExample</code>类，继承自<code>MeFuncPhase</code>，该类每次操作一个函数.
We create header file <code>me_example.h</code>and cpp file
<code>me_example.cpp</code> in directory
<code>src/mapleall/maple_me/include</code> and
<code>src/mapleall/maple_me/src</code> respectively. This is the
traditional directory in which Huawei developers put all exsiting
function phases. The header file is shown as below</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mapleall/maple_me/include/me_example.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;me_phase.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> maple &#123;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MeDoMeExample</span>: <span class="keyword">public</span> MeFuncPhase &#123; <span class="comment">// inherit from MeFuncPhase </span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">explicit</span> <span class="title">MeDoMeExample</span><span class="params">(MePhaseID id)</span> : MeFuncPhase(id) &#123;</span>&#125;;</span><br><span class="line">	<span class="keyword">virtual</span> ~<span class="built_in">MeDoMeExample</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="comment">// implement Run method</span></span><br><span class="line">	<span class="function">AnalysisResult *<span class="title">Run</span><span class="params">(MeFunction *func, MeFuncResultMgr *m, ModuleResultMgr *mrm)</span> <span class="keyword">override</span></span>;</span><br><span class="line">	<span class="function">std::string <span class="title">PhaseName</span><span class="params">()</span> <span class="type">const</span> <span class="keyword">override</span> </span>&#123;  <span class="comment">// override PhaseName method</span></span><br><span class="line">		<span class="keyword">return</span> <span class="string">&quot;me_example&quot;</span>; </span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>The cpp file is a little complex. Because this phase is a function
phase, so the <code>Run</code> method will be executed for each
function. The first step is to check if current function is main
function.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;me_example.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;me_function.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> maple &#123;</span><br><span class="line"><span class="function">AnalysisResult *<span class="title">MeDoMeExample::Run</span><span class="params">(MeFunction *func, MeFuncResultMgr *m, ModuleResultMgr *mrm)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (func-&gt;<span class="built_in">GetName</span>() == <span class="string">&quot;main&quot;</span>) &#123;</span><br><span class="line">		LogInfo::<span class="built_in">MapleLogger</span>() &lt;&lt; <span class="string">&quot;Harper &quot;</span> &lt;&lt; func-&gt;<span class="built_in">GetName</span>() &lt;&lt;  <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">        ... <span class="comment">// instrumentation work</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Then, we need to get the statememt
<code>callassigned &amp;f2 () &#123; dassign %retvar_13 0 &#125;</code> that calls
function f2, so that we can insert new call statement before it. We
traverse every statement in every basic block using two loops. By
checking if the opcode of a statement is <code>OP_call</code> or
<code>OP_callassigned</code>, we can easily find the statement
<code>callassigned &amp;f2()</code>. Once the statement to be inserted
before is found, we dump current basic block before and after
instrumentation to check if we succeed.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> &amp;bb : func-&gt;<span class="built_in">GetAllBBs</span>()) &#123; <span class="comment">// for each basic block</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;stmt : bb-&gt;<span class="built_in">GetStmtNodes</span>()) &#123; <span class="comment">// for each statement</span></span><br><span class="line">        <span class="keyword">if</span> (stmt.<span class="built_in">GetOpCode</span>() == OP_call || stmt.<span class="built_in">GetOpCode</span>() == OP_callassigned) &#123;</span><br><span class="line">            bb-&gt;<span class="built_in">Dump</span>(&amp;func-&gt;<span class="built_in">GetMIRModule</span>()); <span class="comment">// dump the basic block before instrumentation</span></span><br><span class="line">            ... <span class="comment">// instumentation work</span></span><br><span class="line">            bb-&gt;<span class="built_in">Dump</span>(&amp;func-&gt;<span class="built_in">GetMIRModule</span>()); <span class="comment">// dump the basic block before instrumentation</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The core instrumentation logic is shown as below. Because
<code>StmtNode</code> is the base class of all types of node, to access
the methods of statement with specific type, we cast <code>stmt</code>
to type <code>CallNode</code>. Then we access the target function called
by statement
<code>callassigned &amp;f2 () &#123; dassign %retvar_13 0 &#125;</code> using
<code>PUIdx</code>.</p>
<p>From line 4, we can see that each function is a program unit and are
given a unique id to index. All functions are declared at global
declaration part, therefore we can get a function by looking for the
global function table using <code>Puidx</code>. Now we have function
<code>f2</code>, the only question left is how to access function
<code>f1</code> so that we can create a call statement to invoke it.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CallNode *callNode = <span class="built_in">static_cast</span>&lt;CallNode*&gt;(&amp;stmt); <span class="comment">// cast stmt to callnode type</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// get the target function called by statement `callassigned &amp;f2 () &#123; dassign %retvar_13 0 &#125;`, which is f2</span></span><br><span class="line">MIRFunction *fn = GlobalTables::<span class="built_in">GetFunctionTable</span>().<span class="built_in">GetFunctionFromPuidx</span>(callNode-&gt;<span class="built_in">GetPUIdx</span>()); </span><br></pre></td></tr></table></figure>
<p>We achieve this by iterate all functions in this module, and check if
current function is neither main function, nor f2. Once we get the
variable <code>mirFunc</code>that corresponds to function
<code>f1</code>, we create a callstmt with type <code>CallNode</code> at
line 4. The opcode of this statement is set to be <code>OP_call</code>.
This statement currently doesn't have any target. Therefore, we set its
target using method <code>SetPUIdx</code> with parameter
<code>mirFunc-&gt;GetPuidx()</code>, which is exacly f1. Finally, we
insert the newly created statement <code>callStmt</code> before the
statement that calls function f2 <code>stmt</code> at line 10. Now, all
programming is done.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> &amp;mirFunc: func-&gt;<span class="built_in">GetMIRModule</span>().<span class="built_in">GetFunctionList</span>()) &#123; <span class="comment">// iterate all functions in current mode</span></span><br><span class="line">    <span class="keyword">if</span> (mirFunc-&gt;<span class="built_in">GetName</span>() != <span class="string">&quot;main&quot;</span> &amp;&amp; mirFunc-&gt;<span class="built_in">GetName</span>() != fn-&gt;<span class="built_in">GetName</span>()) &#123; <span class="comment">// to find function f1</span></span><br><span class="line">        <span class="comment">// create a empty call statement</span></span><br><span class="line">        CallNode *callStmt = func-&gt;<span class="built_in">GetMIRModule</span>().<span class="built_in">CurFuncCodeMemPool</span>()-&gt;<span class="built_in">New</span>&lt;CallNode&gt;(func-&gt;<span class="built_in">GetMIRModule</span>(), OP_call);</span><br><span class="line">        <span class="comment">// set the target of call statement to be f1.</span></span><br><span class="line">        callStmt-&gt;<span class="built_in">SetPUIdx</span>(mirFunc-&gt;<span class="built_in">GetPuidx</span>());							</span><br><span class="line">        <span class="comment">// insert function call f1 before function call f2</span></span><br><span class="line">        <span class="comment">// stmt: callassigned &amp;f2 () &#123; dassign %retvar_13 0 &#125;</span></span><br><span class="line">        <span class="comment">// callStmt: call &amp;f1()</span></span><br><span class="line">        bb-&gt;<span class="built_in">InsertStmtBefore</span>(&amp;stmt, callStmt);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>To include this phase into the target to be compiled, we add the new
phase <code>me_example.cpp</code>to the ninja build file
<code>src/mapleall/maple_me/BUILD.gn</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// src/mapleall/maple_me/BUILD.gn</span></span><br><span class="line">src_libmplme = [</span><br><span class="line">  <span class="string">&quot;src/dse.cpp&quot;</span>,</span><br><span class="line">  ...</span><br><span class="line">  <span class="string">&quot;src/me_example.cpp&quot;</span> &lt;== <span class="keyword">new</span> <span class="title class_">phase</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>As shown above, we need to register this phase by adding the
following lines in corresponding <code>.def</code> files.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// add this line to src/mapleall/maple_me/include/me_phases.def</span></span><br><span class="line">FUNCAPHASE(MeFuncPhase_DOEXAMPLE, MeDoMeExample)</span><br><span class="line"></span><br><span class="line"><span class="comment">// add this line to src/mapleall/maple_driver/defs/phases.def</span></span><br><span class="line">ADD_PHASE(<span class="string">&quot;me_example&quot;</span>, <span class="literal">true</span>)</span><br></pre></td></tr></table></figure>
<p>We further need to include the new header file
<code>me_example.h</code> in function phase manager
<code>src/mapleall/maple_me/src/me_phase_manager.cpp</code> to pass
compilation.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;me_example.h&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>The last step is executing <code>make maple</code> in the root
directory of OpenArk Compiler to integrate this phase into executable
<code>maple</code>.</p>
<p>To verify if the instrumentation succeed, we execute
<code>maple</code> in the following way. The run option is specifed as
<code>--run=me&amp;mpl2mpl</code> to perform optimization in function
level and module level.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">$&gt; maple --run=me:mpl2mpl -option=<span class="string">&quot;-O2 --quiet:-O2 -quiet&quot;</span> test.mpl</span><br><span class="line">Starting mpl2mpl&amp;mplme</span><br><span class="line">Starting:./maple --run=me:mpl2mpl --option=<span class="string">&quot; --O2 --quiet: --O2 --quiet&quot;</span> test.mpl</span><br><span class="line">Starting parse input</span><br><span class="line">Parse consumed 0s</span><br><span class="line">Processing mpl2mpl&amp;mplme</span><br><span class="line">[mpl2mpl] Module phases cost 0ms</span><br><span class="line">Harper main</span><br><span class="line"><span class="comment"># Before instrumentation</span></span><br><span class="line">============BB <span class="built_in">id</span>:2 <span class="built_in">return</span> [ Entry  Exit ]===============</span><br><span class="line">preds:</span><br><span class="line">succs:</span><br><span class="line">LOC 2 12</span><br><span class="line">  <span class="comment">#f2();</span></span><br><span class="line">  callassigned &amp;<span class="function"><span class="title">f2</span></span> () &#123; dassign %retvar_13 0 &#125;</span><br><span class="line">LOC 2 13</span><br><span class="line">  <span class="comment">#return 0;</span></span><br><span class="line">  <span class="built_in">return</span> (constval i32 0)</span><br><span class="line">callassigned</span><br><span class="line">f2</span><br><span class="line">LOC 2 12</span><br><span class="line">  callassigned &amp;<span class="function"><span class="title">f2</span></span> () &#123; dassign %retvar_13 0 &#125;</span><br><span class="line">  </span><br><span class="line"><span class="comment"># After instrumentation</span></span><br><span class="line">============BB <span class="built_in">id</span>:2 <span class="built_in">return</span> [ Entry  Exit ]===============</span><br><span class="line">preds:</span><br><span class="line">succs:</span><br><span class="line">  <span class="comment">#f2();</span></span><br><span class="line">  call &amp;f1 ()    <span class="comment"># &lt;== instrument successfully</span></span><br><span class="line">  callassigned &amp;<span class="function"><span class="title">f2</span></span> () &#123; dassign %retvar_13 0 &#125;</span><br><span class="line">LOC 2 13</span><br><span class="line">  <span class="comment">#return 0;</span></span><br><span class="line">  <span class="built_in">return</span> (constval i32 0)</span><br><span class="line">[me] Function phases cost 0ms</span><br><span class="line">[mpl2mpl] Module phases cost 0ms</span><br><span class="line">[me] Function phases cost 0ms</span><br><span class="line">[mpl2mpl] Module phases cost 0ms</span><br><span class="line"> Mpl2mpl&amp;mplme consumed 0s</span><br></pre></td></tr></table></figure>
<p>From the output log, we know that <code>maple</code> processes module
phase 3 times (line 7, line 35, line 37) and processes function phase
two times (line 34, line 36). Our instrumentation phase is invoked at
the first time of processing funtion phase. Before processing our
customized phase, there is only a function call at line 15, whereas,
there are two function call at line 29, 30 after instrumention.</p>
<p>To double check if we succeed, the maple IR of function main in the
output maple file <code>test.Vtablempl.mpl</code> is shown below. We can
see there is a new statement at line 12 to invoke function f1.</p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">func</span> &amp;<span class="title function_">main</span> <span class="title function_">public</span> <span class="params">()</span> <span class="title function_">i32</span> &#123;</span><br><span class="line">  funcid <span class="number">110</span></span><br><span class="line">  funcinfo &#123;</span><br><span class="line">    <span class="symbol">@INFO_funcname</span> <span class="string">&quot;main&quot;</span>,</span><br><span class="line">    <span class="symbol">@INFO_signature</span> <span class="string">&quot;main|&quot;</span>,</span><br><span class="line">    <span class="symbol">@INFO_classname</span> <span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="symbol">@INFO_fullname</span> <span class="string">&quot;main|()I&quot;</span>&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LOC <span class="number">2</span> <span class="number">12</span></span><br><span class="line">  <span class="meta">#f2()<span class="comment">;</span></span></span><br><span class="line">  <span class="built_in">call</span> &amp;f1 () <span class="meta"># &lt;== succeed!</span></span><br><span class="line">  callassigned &amp;f2 () &#123;&#125;</span><br><span class="line">LOC <span class="number">2</span> <span class="number">13</span></span><br><span class="line">  <span class="meta">#return 0<span class="comment">;</span></span></span><br><span class="line">  intrinsiccall MPL_CLEANUP_LOCALREFVARS ()</span><br><span class="line">  <span class="keyword">return</span> (constval i32 <span class="number">0</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Finally, we compile this maple file to assembly code using
<code>maple</code> with option <code>--run=mplcg</code>, further to
executable using <code>aarch64-linux-gnu-gcc</code>and check if it can
output "f1f2 by running <code>test.out</code> in qemu.</p>
<p><img src="https://i.loli.net/2021/01/23/kbasN7np3Ry4d8Y.png" alt="image-20210123135021782" style="zoom:50%;" /></p>
<p>The result shows that "f1f2" is successfully outputed, and we can do
instrumentation using the framework of OpenArk Compiler.</p>
<h4 id="reference">Reference</h4>
<ol type="1">
<li>知乎专栏 https://zhuanlan.zhihu.com/openarkcompiler</li>
<li>https://zhuanlan.zhihu.com/p/80624361</li>
<li>官方IR Maple的设计文档
https://gitee.com/openarkcompiler/OpenArkCompiler/blob/master/doc/en/MapleIRDesign.md</li>
<li>https://gitee.com/openarkcompiler-incubator/mapleall/blob/dev/doc/maple_ir_spec.md</li>
<li>Fred Chow的论文https://queue.acm.org/detail.cfm?id=2544374</li>
<li>比较完整的知乎文章 https://zhuanlan.zhihu.com/p/137526426</li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/blog/2020/12/30/Tech-Thread-Safety/" rel="prev" title="[Tech] Thread Safety">
                  <i class="fa fa-angle-left"></i> [Tech] Thread Safety
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/blog/2021/01/08/OpenArk-Compiler/" rel="next" title="OpenArk Compiler">
                  OpenArk Compiler <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Wei CHEN</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/blog/js/comments.js"></script><script src="/blog/js/utils.js"></script><script src="/blog/js/motion.js"></script><script src="/blog/js/next-boot.js"></script>

  






  




  

  <script class="next-config" data-name="enableMath" type="application/json">true</script><script class="next-config" data-name="mathjax" type="application/json">{"enable":true,"tags":"none","js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-mml-chtml.js","integrity":"sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI="}}</script>
<script src="/blog/js/third-party/math/mathjax.js"></script>



</body>
</html>
