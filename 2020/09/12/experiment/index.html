<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">
  <link rel="manifest" href="/blog/images/manifest.json">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.14.0/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css">

<script class="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"harperchen.github.io","root":"/blog/","scheme":"Pisces","version":"8.0.0","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}};
  </script>

  <meta name="description" content="CGroups ExperimentsCreated: Mar 28, 2020 12:17 AMCreated By: Wei ChenLast Edited By: Wei ChenLast Edited Time: Mar 28, 2020 12:36 PMStatus: In Progress 🙌Type: Technical SpecURL: https:&#x2F;&#x2F;kernel.google">
<meta property="og:type" content="article">
<meta property="og:title" content="Cgroup Experiments">
<meta property="og:url" content="https://harperchen.github.io/blog/2020/09/12/experiment/index.html">
<meta property="og:site_name" content="Wei&#39;s Blog">
<meta property="og:description" content="CGroups ExperimentsCreated: Mar 28, 2020 12:17 AMCreated By: Wei ChenLast Edited By: Wei ChenLast Edited Time: Mar 28, 2020 12:36 PMStatus: In Progress 🙌Type: Technical SpecURL: https:&#x2F;&#x2F;kernel.google">
<meta property="og:locale">
<meta property="og:image" content="https://harperchen.github.io/blog/2020/09/12/experiment/CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled.png">
<meta property="og:image" content="https://harperchen.github.io/blog/2020/09/12/experiment/CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%201.png">
<meta property="og:image" content="https://harperchen.github.io/blog/2020/09/12/experiment/CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%202.png">
<meta property="og:image" content="https://harperchen.github.io/blog/2020/09/12/experiment/CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%203.png">
<meta property="og:image" content="https://harperchen.github.io/blog/2020/09/12/experiment/CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%204.png">
<meta property="og:image" content="https://harperchen.github.io/blog/2020/09/12/experiment/CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%205.png">
<meta property="og:image" content="https://harperchen.github.io/blog/2020/09/12/experiment/CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%206.png">
<meta property="og:image" content="https://harperchen.github.io/blog/2020/09/12/experiment/CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%207.png">
<meta property="og:image" content="https://harperchen.github.io/blog/2020/09/12/experiment/CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%208.png">
<meta property="og:image" content="https://harperchen.github.io/blog/2020/09/12/experiment/CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%209.png">
<meta property="og:image" content="https://harperchen.github.io/blog/2020/09/12/experiment/CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2010.png">
<meta property="og:image" content="https://harperchen.github.io/blog/2020/09/12/experiment/CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2011.png">
<meta property="og:image" content="https://harperchen.github.io/blog/2020/09/12/experiment/CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2012.png">
<meta property="og:image" content="https://harperchen.github.io/blog/2020/09/12/experiment/CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2013.png">
<meta property="og:image" content="https://harperchen.github.io/blog/2020/09/12/experiment/CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2014.png">
<meta property="og:image" content="https://harperchen.github.io/blog/2020/09/12/experiment/CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2015.png">
<meta property="og:image" content="https://harperchen.github.io/blog/2020/09/12/experiment/CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2016.png">
<meta property="og:image" content="https://harperchen.github.io/blog/2020/09/12/experiment/CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2017.png">
<meta property="og:image" content="https://harperchen.github.io/blog/2020/09/12/experiment/CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2018.png">
<meta property="article:published_time" content="2020-09-12T08:51:41.000Z">
<meta property="article:modified_time" content="2020-09-12T08:52:44.995Z">
<meta property="article:author" content="Wei CHEN">
<meta property="article:tag" content="cgroup">
<meta property="article:tag" content="container">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://harperchen.github.io/blog/2020/09/12/experiment/CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled.png">


<link rel="canonical" href="https://harperchen.github.io/blog/2020/09/12/experiment/">


<script data-pjax class="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-Hans'
  };
</script>

  <title>Cgroup Experiments | Wei's Blog</title>
  






  <noscript>
  <style>
  body { margin-top: 2rem; }

  .use-motion .menu-item,
  .use-motion .sidebar,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header {
    visibility: visible;
  }

  .use-motion .header,
  .use-motion .site-brand-container .toggle,
  .use-motion .footer { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle,
  .use-motion .custom-logo-image {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line {
    transform: scaleX(1);
  }

  .search-pop-overlay, .sidebar-nav { display: none; }
  .sidebar-panel { display: block; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Wei's Blog</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <section class="post-toc-wrap sidebar-panel">
          <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#CGroups-Experiments"><span class="nav-text">CGroups Experiments</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Installation"><span class="nav-text">Installation</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CPUSet"><span class="nav-text">CPUSet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CPU"><span class="nav-text">CPU</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Memory"><span class="nav-text">Memory</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CGCreate"><span class="nav-text">CGCreate</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Data-Synchronization"><span class="nav-text">Data Synchronization</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CGroupv1"><span class="nav-text">CGroupv1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CGroupv2"><span class="nav-text">CGroupv2</span></a></li></ol></li></ol></li></ol></div>
      </section>
      <!--/noindex-->

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Wei CHEN"
      src="/blog/images/avatar.png">
  <p class="site-author-name" itemprop="name">Wei CHEN</p>
  <div class="site-description" itemprop="description">Be brave</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/blog/archives/">
        
          <span class="site-state-item-count">2</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/blog/categories/">
          
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/blog/tags/">
          
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/harperchen" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;harperchen" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:harperchen1110@gmail.com" title="E-Mail → mailto:harperchen1110@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </section>
        <div class="back-to-top animated">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">
      

      

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-Hans">
    <link itemprop="mainEntityOfPage" href="https://harperchen.github.io/blog/2020/09/12/experiment/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/avatar.png">
      <meta itemprop="name" content="Wei CHEN">
      <meta itemprop="description" content="Be brave">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wei's Blog">
    </span>

    
    
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Cgroup Experiments
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2020-09-12 16:51:41 / Modified: 16:52:44" itemprop="dateCreated datePublished" datetime="2020-09-12T16:51:41+08:00">2020-09-12</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/container/" itemprop="url" rel="index"><span itemprop="name">container</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="CGroups-Experiments"><a href="#CGroups-Experiments" class="headerlink" title="CGroups Experiments"></a>CGroups Experiments</h1><p>Created: Mar 28, 2020 12:17 AM<br>Created By: Wei Chen<br>Last Edited By: Wei Chen<br>Last Edited Time: Mar 28, 2020 12:36 PM<br>Status: In Progress 🙌<br>Type: Technical Spec<br>URL: <a target="_blank" rel="noopener" href="https://kernel.googlesource.com/pub/scm/linux/kernel/git/glommer/memcg/+/cpu_stat/Documentation/cgroups">https://kernel.googlesource.com/pub/scm/linux/kernel/git/glommer/memcg/+/cpu_stat/Documentation/cgroups</a></p>
<h2 id="Installation"><a href="#Installation" class="headerlink" title="Installation"></a>Installation</h2><p>The first step, on Ubuntu, is to install the cgroups packages.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install cgroup-tools cgroup-bin cgroup-lite libcgroup1 cgroupfs-mount</span><br><span class="line"><span class="comment"># add the following in /etc/default/grub</span></span><br><span class="line">GRUB_CMDLINE_LINUX_DEFAULT=<span class="string">&quot;quiet cgroup_enable=memory swapaccount=1&quot;</span></span><br><span class="line">sudo update-grub</span><br></pre></td></tr></table></figure>

<p>Several files are created at the same time.</p>
<ul>
<li><code>/sys/fs/cgroup</code> has a bunch of folders in a sort of virtual filesystem that “represents” cgroup.</li>
<li><code>/etc/init/cgroup-lite.conf</code> creates the /sys/fs/cgroup directory</li>
<li><code>/proc/cgroups</code> specifies what groups cgroup-lite should create.</li>
</ul>
<p><img src="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled.png" alt="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled.png"></p>
<ul>
<li>By accessing the cgroup filesystem directly.</li>
<li>Using the cgm client (part of the cgmanager).</li>
<li>Via cgcreate, cgexec and cgclassify (part of cgroup-tools).</li>
<li>Via cgconfig.conf and cgrules.conf (also part of cgroup-tools).</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/init/cgroup-lite.conf</span></span><br><span class="line">description <span class="string">&quot;mount available cgroup filesystems&quot;</span></span><br><span class="line">author <span class="string">&quot;Serge Hallyn &lt;serge.hallyn@canonical.com&gt;&quot;</span></span><br><span class="line"></span><br><span class="line">start on mounted MOUNTPOINT=/sys/fs/cgroup</span><br><span class="line"></span><br><span class="line">pre-start script</span><br><span class="line">        <span class="built_in">test</span> -x /bin/cgroups-mount || &#123; stop; <span class="built_in">exit</span> 0; &#125;</span><br><span class="line">        <span class="built_in">test</span> -d /sys/fs/cgroup || &#123; stop; <span class="built_in">exit</span> 0; &#125;</span><br><span class="line">        /bin/cgroups-mount</span><br><span class="line">        cgconfigparser -l /etc/cgconfig.conf</span><br><span class="line">				cgrulesengd</span><br><span class="line">end script</span><br><span class="line"></span><br><span class="line">post-stop script</span><br><span class="line">        <span class="keyword">if</span> [ -x /bin/cgroups-umount ]</span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">                /bin/cgroups-umount</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">end script</span><br></pre></td></tr></table></figure>

<h2 id="CPUSet"><a href="#CPUSet" class="headerlink" title="CPUSet"></a>CPUSet</h2><p>Now the environment and tools are ready, we will define some roles in <code>/etc/cgconfig.conf</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">group wchenbt &#123;</span><br><span class="line">		cpuset &#123;</span><br><span class="line"><span class="comment">#       cat /proc/cpuinfo | grep &quot;cpu cores&quot; | uniq</span></span><br><span class="line">        cpuset.cpus = <span class="string">&quot;1,2&quot;</span>;</span><br><span class="line">        cpuset.mems = <span class="string">&quot;0&quot;</span>;</span><br><span class="line"><span class="comment">#       we need to specific memory node for cpuset </span></span><br><span class="line">    &#125;</span><br><span class="line">		...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We will associate these “roles” and the applications in <code>/etc/cgrules.conf</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># &lt;user:process&gt;    &lt;subsystems&gt;           &lt;group&gt;</span></span><br><span class="line">harper:java         cpu,memory,cpuset      wchenbt</span><br></pre></td></tr></table></figure>

<p>This will limit the process java of user harper to CPU Core 1, 2 and 1G of memory.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo vim /etc/cgconfig.conf</span><br><span class="line">sudo vim /etc/cgrules.conf</span><br><span class="line"></span><br><span class="line">sudo cgconfigparser -l /etc/cgconfig.conf</span><br><span class="line">sudo cgrulesengd -d --logfile=/var/<span class="built_in">log</span>/cgrulesengd.log</span><br><span class="line"></span><br><span class="line">taskset -pc $(pidof java)</span><br><span class="line">cat /proc/$(pidof java)/cgroup</span><br><span class="line">sudo cgdelete cpuset:/wchenbt</span><br></pre></td></tr></table></figure>

<p>Based on the roles, we can check the debug information of cgrulesengd and also the cgroup information of java. The output of taskset shows that we have successfully setup the roles.</p>
<p><img src="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%201.png" alt="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%201.png"></p>
<p><img src="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%202.png" alt="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%202.png"></p>
<h2 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">group wchenbt &#123;</span><br><span class="line">		cpu &#123;</span><br><span class="line">				<span class="comment"># cpu.shares = 300; # 30 %</span></span><br><span class="line">				cpu.cfs_quota_us=10000; <span class="comment"># 10 %</span></span><br><span class="line">				cpu.cfs_period_us=100000; <span class="comment"># default value</span></span><br><span class="line">    &#125;</span><br><span class="line">		cpucct &#123;</span><br><span class="line">		&#125;</span><br><span class="line">		...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>cpu.shares: The weight of each group living in the same hierarchy, that translates into the amount of CPU it is expected to get. Upon cgroup creation, each group gets assigned a default of 1024. The percentage of CPU assigned to the cgroup is the value of shares divided by the sum of all shares in all cgroups in the same level.</li>
<li>cpu.cfs_period_us: The duration in microseconds of each scheduler period, for bandwidth decisions. This defaults to 100000us or 100ms.</li>
<li>cpu.cfs_quota_us: The maximum time in microseconds during each cfs_period_us in for the current group will be allowed to run. For instance, if it is set to half of cpu_period_us, the cgroup will only be able to peak run for 50 % of the time. One should note that this represents aggregate time over all CPUs in the system. Therefore, in order to allow full usage of two CPUs, for instance, one should set this value to twice the value of cfs_period_us.</li>
</ul>
<p><img src="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%203.png" alt="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%203.png"></p>
<p>We use htop to check the cpu usage which is lower than 10%.</p>
<p><img src="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%204.png" alt="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%204.png"></p>
<h2 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h2><p>When not configure the memory limitation, we use stress process and check the memory usage is around 10%</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Stress https://www.cnblogs.com/sparkdev/p/10354947.html</span></span><br><span class="line">stress --vm-bytes 800m --vm-keep -m 1</span><br></pre></td></tr></table></figure>

<p><img src="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%205.png" alt="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%205.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># user su</span></span><br><span class="line">mkdir /sys/fs/cgroup/memory/testmem -p</span><br><span class="line"><span class="built_in">cd</span> /sys/fs/cgroup/memory/testmem</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> $$ &gt; tasks</span><br><span class="line"><span class="built_in">echo</span> 100m &gt; memory.limit_in_bytes</span><br><span class="line"></span><br><span class="line"><span class="comment"># delete cgroup</span></span><br><span class="line"><span class="built_in">cd</span> /sys/fs/cgroup/memory/</span><br><span class="line"><span class="built_in">echo</span> $$ &gt;&gt; tasks</span><br><span class="line">rmdir ./testm</span><br></pre></td></tr></table></figure>

<h2 id="CGCreate"><a href="#CGCreate" class="headerlink" title="CGCreate"></a>CGCreate</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cgcreate -a root -t harper -g cpu,memory:<span class="built_in">test</span></span><br><span class="line">ls /sys/fs/cgroup/cpu/<span class="built_in">test</span></span><br><span class="line">ls /sys/fs/cgroup/memory/<span class="built_in">test</span></span><br><span class="line">head /sys/fs/cgroup/cpu/<span class="built_in">test</span>/cpu.shares</span><br><span class="line">head /sys/fs/cgroup/memory/<span class="built_in">test</span>/memory.limit_in_bytes</span><br><span class="line"><span class="built_in">echo</span> 300 &gt; /sys/fs/cgroup/cpu/<span class="built_in">test</span>/cpu.shares</span><br><span class="line"><span class="built_in">echo</span> 100m &gt; /sys/fs/cgroup/memory/<span class="built_in">test</span>/memory.limit_in_bytes</span><br><span class="line">cgexec -g cpu,memory:<span class="built_in">test</span> cat /dev/urandom &gt; /dev/null</span><br></pre></td></tr></table></figure>

<p><img src="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%206.png" alt="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%206.png"></p>
<p>You’ll get 1024 for your cpu.shares (the maximum &amp; default) and a huge number for your memory usage limit in bytes.</p>
<p><img src="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%207.png" alt="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%207.png"></p>
<h2 id="Data-Synchronization"><a href="#Data-Synchronization" class="headerlink" title="Data Synchronization"></a>Data Synchronization</h2><p><a target="_blank" rel="noopener" href="https://medium.com/@asishrs/docker-limit-resource-utilization-using-cgroup-parent-72a646651f9d">https://medium.com/@asishrs/docker-limit-resource-utilization-using-cgroup-parent-72a646651f9d</a></p>
<p><a target="_blank" rel="noopener" href="https://andrestc.com/post/cgroups-io/">https://andrestc.com/post/cgroups-io/</a></p>
<h3 id="CGroupv1"><a href="#CGroupv1" class="headerlink" title="CGroupv1"></a>CGroupv1</h3><p>The script <code>/etc/init/cgroup-lite.conf</code> will automatically mount cgroup filesystem when rebooting.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /etc/init/cgroup-lite.conf</span></span><br><span class="line">description <span class="string">&quot;mount available cgroup filesystems&quot;</span></span><br><span class="line">author <span class="string">&quot;Serge Hallyn &lt;serge.hallyn@canonical.com&gt;&quot;</span></span><br><span class="line"></span><br><span class="line">start on mounted MOUNTPOINT=/sys/fs/cgroup</span><br><span class="line"></span><br><span class="line">pre-start script</span><br><span class="line">        <span class="built_in">test</span> -x /bin/cgroups-mount || &#123; stop; <span class="built_in">exit</span> 0; &#125;</span><br><span class="line">        <span class="built_in">test</span> -d /sys/fs/cgroup || &#123; stop; <span class="built_in">exit</span> 0; &#125;</span><br><span class="line">        /bin/cgroups-mount</span><br><span class="line">        cgconfigparser -l /etc/cgconfig.conf</span><br><span class="line">				cgrulesengd</span><br><span class="line">end script</span><br><span class="line"></span><br><span class="line">post-stop script</span><br><span class="line">        <span class="keyword">if</span> [ -x /bin/cgroups-umount ]</span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">                /bin/cgroups-umount</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">end script</span><br></pre></td></tr></table></figure>

<p>Also, we need add the following to <code>/etc/default/grub</code> and update</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GRUB_CMDLINE_LINUX_DEFAULT=<span class="string">&quot;quiet cgroup_enable=memory swapaccount=1&quot;</span></span><br><span class="line">sudo update-grub</span><br></pre></td></tr></table></figure>

<p>So let’s start to limit I/O with cgroups v1. For I/O read, cgroups works, shown as follow.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 消耗io</span></span><br><span class="line">dd <span class="keyword">if</span>=/dev/sda of=/dev/null</span><br></pre></td></tr></table></figure>

<p>Before configuration, we can use iostat to check the I/O read that is close to 200M/s.</p>
<p><img src="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%208.png" alt="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%208.png"></p>
<p>To limit the I/O read, we need to create a cgroup <code>test</code> in the <code>blkio</code> controller. Then we are going to set our read limit using <code>blkio.throttle.read_bps_device</code> file. This requires us to specify limits by device, so we must find out our device major and minor version:</p>
<p><img src="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%209.png" alt="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%209.png"></p>
<p>Let’s limit the read bytes per second to 10485760 (10M/s) on the sda device (8: 0).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ls /sys/fs/cgroup/blkio/</span><br><span class="line">mkdir /sys/fs/cgroup/blkio/<span class="built_in">test</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;8:0 10485760&#x27;</span> &gt; /sys/fs/cgroup/blkio/<span class="built_in">test</span>/blkio.throttle.read_bps_device</span><br><span class="line"><span class="comment"># process id</span></span><br><span class="line"><span class="built_in">echo</span> 2660 &gt; /sys/fs/cgroup/blkio/<span class="built_in">test</span>/tasks</span><br></pre></td></tr></table></figure>

<p>Then we place the shell into cgroup test by writing its pid 2660 into <code>tasks</code> file and re-run the workload. The command we start in this shell will run in this cgroup, so the read bytes per second now become around 10M/s when watching the I/O workload using iostat.</p>
<p><img src="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2010.png" alt="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2010.png"></p>
<p>For I/O write, this is not the case. We use the following command to generate I/O workload and monitor the I/O usage. The write bytes per second on the nvme0n1 device now is close to 150M/s.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dd <span class="keyword">if</span>=/dev/zero of=/tmp/file1</span><br></pre></td></tr></table></figure>

<p><img src="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2011.png" alt="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2011.png"></p>
<p>Then we limit the I/O usage using <code>blkio.throttle.write_bps_device</code> file, now the device major and minor version is 292: 0. </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&#x27;292:0 10485760&#x27;</span> &gt; blkio.throttle.write_bps_device</span><br></pre></td></tr></table></figure>

<p>However, we are still able to write 128 MB/s, so the limitation doesn’t work.</p>
<p><img src="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2012.png" alt="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2012.png"></p>
<p>If we try the same command but opening the file with <code>O_DIRECT</code> flag (passing <code>oflag=direct</code> to <code>dd</code>), the write bytes per second now is around 10M/s.</p>
<p><img src="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2013.png" alt="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2013.png"></p>
<p>Basically, when we write to a file (opened without any special flags), the data travels across a bunch of buffers and caches before it is effectively written to the disk. Opening a file with O_DIRECT (available since Linux 2.4.10), means file I/O is done directly to/from user-space buffers.</p>
<p>On traditional cgroup hierarchies, relationships between different controllers cannot be established making it impossible for writeback to operate accounting for cgroup resource restrictions and all writeback IOs are attributed to the root cgroup. </p>
<p>It’s important to notice that this was added when cgroups v2 were already a reality (but still experimental). So the “traditional cgroup hierarchies” means cgroups v1. Since in cgroups v1, different resources/controllers (memory, blkio) live in different hierarchies on the filesystem, even when those cgroups have the same name, they are completely independent. So, when the memory page is finally being flushed to disk, there is no way that the memory controller can know what blkio cgroup wrote that page. That means it is going to use the root cgroup for the blkio controller.</p>
<h3 id="CGroupv2"><a href="#CGroupv2" class="headerlink" title="CGroupv2"></a>CGroupv2</h3><p><a target="_blank" rel="noopener" href="https://www.kernel.org/doc/Documentation/cgroup-v2.txt">https://www.kernel.org/doc/Documentation/cgroup-v2.txt</a></p>
<p>We need add the following to <code>/etc/default/grub</code> and update.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GRUB_CMDLINE_LINUX_DEFAULT=<span class="string">&quot;cgroup_no_v1=all&quot;</span></span><br><span class="line">sudo update-grub</span><br></pre></td></tr></table></figure>

<p>Also, we need delete <code>/etc/init/cgroup-lite.conf</code> and reboot to unmount and disable cgroup v1.</p>
<p><img src="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2014.png" alt="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2014.png"></p>
<p>First, we mount cgroup v2 filesystem in /mnt/cgroup2</p>
<p><img src="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2015.png" alt="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2015.png"></p>
<p>Now, we create a new cgroup called cg2 by creating a directory under the mounted file system. To be able to edit the I/O limits using the the I/O controller on the newly created cgroup, we need to write “+io” to the <code>cgroup.subtree_control</code> file in the parent (in this case, root) cgroup, and check the <code>cgroup.controllers</code> file for the cg2 cgroup, we see that the io controller is enabled.</p>
<p><img src="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2016.png" alt="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2016.png"></p>
<p>To limit I/O to 10MB/s, as done previously, we write into the io.max file and use <code>dd</code> to generate some IO workload.</p>
<p><img src="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2017.png" alt="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2017.png"></p>
<p>The write bytes per second is around 700M/s. Let’s add our bash session to the cg2 cgroup, by writing its PID to <code>cgroup.procs</code> file. At the same time, we get this output from iostat (redacted).</p>
<p><img src="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2018.png" alt="CGroups%20Experiments%20f453e985063a43d989d6bb941200693e/Untitled%2018.png"></p>
<p>So, even relying on the writeback kernel cache we are able to limit the I/O on the disk with cgroup v2.</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/blog/tags/cgroup/" rel="tag"># cgroup</a>
              <a href="/blog/tags/container/" rel="tag"># container</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/blog/2020/09/12/How-to-config-MTE-using-Qemu/" rel="prev" title="How to config MTE using Qemu">
                  <i class="fa fa-chevron-left"></i> How to config MTE using Qemu
                </a>
            </div>
            <div class="post-nav-item">
            </div>
          </div>
    </footer>
  </article>
  
  
  



      

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      const activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      const commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

    </div>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      

      

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Wei CHEN</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a>
  </div>

    </div>
  </footer>

  
  <script src="//cdn.jsdelivr.net/npm/animejs@3.2.0/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/@next-theme/pjax@0.4.0/pjax.min.js"></script>
<script src="/blog/js/utils.js"></script><script src="/blog/js/motion.js"></script><script src="/blog/js/next-boot.js"></script>
  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '.page-configurations',
    '.main-inner',
    '.post-toc-wrap',
    '.languages',
    '.pjax'
  ],
  analytics: false,
  cacheBust: false,
  scrollRestoration: false,
  scrollTo: !CONFIG.bookmark.enable
});

document.addEventListener('pjax:success', () => {
  pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  const hasTOC = document.querySelector('.post-toc');
  document.querySelector('.sidebar-inner').classList.toggle('sidebar-nav-active', hasTOC);
  document.querySelector(hasTOC ? '.sidebar-nav-toc' : '.sidebar-nav-overview').click();
  NexT.utils.updateSidebarPosition();
});
</script>


  


















  








    <div class="pjax">
  

  

    </div>
</body>
</html>
