<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/blog/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/blog/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/blog/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/blog/images/logo.svg" color="#222">

<link rel="stylesheet" href="/blog/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha256-wiz7ZSCn/btzhjKDQBms9Hx4sSeUYsDrTLg7roPstac=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"harperchen.github.io","root":"/blog/","images":"/blog/images","scheme":"Gemini","darkmode":false,"version":"8.19.2","exturl":false,"sidebar":{"position":"left","display":"always","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/blog/js/config.js"></script>

    <meta name="description" content="AbstractThe ability to execute and analyze code makes many security tasks such as exploit development, reverse engineering, and vulnerability detection much easier. However, on embedded devices such a">
<meta property="og:type" content="article">
<meta property="og:title" content="[S&amp;P&#39;20] Ex-vivo dynamic analysis framework for Android device drivers">
<meta property="og:url" content="https://harperchen.github.io/blog/2020/12/27/S-P-20-Ex-vivo-dynamic-analysis-framework-for-Android-device-drivers/index.html">
<meta property="og:site_name" content="Wei&#39;s Blog">
<meta property="og:description" content="AbstractThe ability to execute and analyze code makes many security tasks such as exploit development, reverse engineering, and vulnerability detection much easier. However, on embedded devices such a">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://i.loli.net/2020/12/28/8HLgaI6wWkPjVmq.png">
<meta property="article:published_time" content="2020-12-27T11:06:47.000Z">
<meta property="article:modified_time" content="2024-03-27T05:21:36.076Z">
<meta property="article:author" content="Wei CHEN">
<meta property="article:tag" content="Kernel">
<meta property="article:tag" content="Hardware Boostup">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2020/12/28/8HLgaI6wWkPjVmq.png">


<link rel="canonical" href="https://harperchen.github.io/blog/2020/12/27/S-P-20-Ex-vivo-dynamic-analysis-framework-for-Android-device-drivers/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"https://harperchen.github.io/blog/2020/12/27/S-P-20-Ex-vivo-dynamic-analysis-framework-for-Android-device-drivers/","path":"2020/12/27/S-P-20-Ex-vivo-dynamic-analysis-framework-for-Android-device-drivers/","title":"[S&P'20] Ex-vivo dynamic analysis framework for Android device drivers"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>[S&P'20] Ex-vivo dynamic analysis framework for Android device drivers | Wei's Blog</title>
  








  <noscript>
    <link rel="stylesheet" href="/blog/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/blog/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Wei's Blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/blog/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/blog/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-categories"><a href="/blog/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li><li class="menu-item menu-item-archives"><a href="/blog/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Abstract"><span class="nav-number">1.</span> <span class="nav-text">Abstract</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Outline"><span class="nav-number">2.</span> <span class="nav-text">Outline</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Wei CHEN"
      src="/blog/images/8.jpg">
  <p class="site-author-name" itemprop="name">Wei CHEN</p>
  <div class="site-description" itemprop="description">Be Brave; Be Confident; <br> Be Happy; Be Optimistic; </div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/blog/archives/">
          <span class="site-state-item-count">59</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/blog/categories/">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/blog/tags/">
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/harperchen" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;harperchen" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:harperchen1110@gmail.com" title="E-Mail → mailto:harperchen1110@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="https://harperchen.github.io/blog/2020/12/27/S-P-20-Ex-vivo-dynamic-analysis-framework-for-Android-device-drivers/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/blog/images/8.jpg">
      <meta itemprop="name" content="Wei CHEN">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Wei's Blog">
      <meta itemprop="description" content="Be Brave; Be Confident; <br> Be Happy; Be Optimistic; ">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="[S&P'20] Ex-vivo dynamic analysis framework for Android device drivers | Wei's Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [S&P'20] Ex-vivo dynamic analysis framework for Android device drivers
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2020-12-27 19:06:47" itemprop="dateCreated datePublished" datetime="2020-12-27T19:06:47+08:00">2020-12-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2024-03-27 13:21:36" itemprop="dateModified" datetime="2024-03-27T13:21:36+08:00">2024-03-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/blog/categories/Papers/" itemprop="url" rel="index"><span itemprop="name">Papers</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h3 id="Abstract"><a href="#Abstract" class="headerlink" title="Abstract"></a>Abstract</h3><p>The ability to execute and analyze code makes many security tasks such as exploit development, reverse engineering, and vulnerability detection much easier. However, on embedded devices such as Android smartphones, executing code in-vivo, on the device, for analysis is limited by the need to acquire such devices, the speed of the device, and in some cases the need to flash custom code onto the devices. The other option is to execute the code ex-vivo, off the device, but this approach either requires porting or complex hardware emulation.</p>
<span id="more"></span>

<p>In this paper, we take advantage of the observation that many execution paths in drivers are only superficially dependent on both the hardware and kernel on which the driver executes, to create an ex-vivo dynamic driver analysis framework for Android devices that requires neither porting nor emulation. We achieve this by developing a generic <em>evasion</em> framework that enables driver initialization by evading hardware and kernel dependen- cies instead of precisely emulating them, and then developing a novel <em>Ex-vivo AnalySIs framEwoRk (EASIER)</em> that enables off-device analysis with the initialized driver state. Compared to on-device analysis, our approach enables the use of userspace tools and scales with the number of available commodity CPU’s, not the number of smartphones.</p>
<p>We demonstrate the usefulness of our framework by targeting privilege escalation vulnerabilities in system call handlers in platform device drivers. We find it can load 48&#x2F;62 (77%) drivers from three different Android kernels: MSM, Xiaomi, and Huawei. We then confirm that it is able to reach and detect 21 known vulnerabilities. Finally, we have discovered 12 new bugs which we have reported and confirmed.</p>
<img src="https://i.loli.net/2020/12/28/8HLgaI6wWkPjVmq.png" alt="image-20201228135046211" style="zoom: 50%;" />

<h3 id="Outline"><a href="#Outline" class="headerlink" title="Outline"></a>Outline</h3><ul>
<li>Target Problem<ul>
<li>对嵌入式系统例如Android设备的分析经常需要flash系统，例如重新编译linux来利用kcov收集coverage进行coverage-guided fuzzing。在设备外运行分析的话，需要模拟化或者移植，观察到很多驱动程序的代码只是表面上依赖硬件和内核，因此提出不需要模拟化和移植的对驱动程序的动态分析框架。</li>
</ul>
</li>
<li>Existing approaches<ul>
<li>[CCS’17] DIFUZE<ul>
<li>真机运行</li>
<li>静态分析无法获取动态分配object和array的大小</li>
<li>无法利用syzkaller的coverage-guided fuzzing</li>
</ul>
</li>
<li>[USENIX’18] Charm：当驱动需要访问外设时，会被转移到物理设备上，否则则在虚拟机里运行。<ul>
<li>需要移植驱动</li>
<li>需要手动分离驱动</li>
<li>需要为每个分析实例提供真实的硬件设备</li>
</ul>
</li>
</ul>
</li>
<li>Difficulties of ex-vivo derive analysis<ul>
<li>In-vivo: 在设备内运行动态分析的扩展性不够好，因为对内核的动态分许需要<ul>
<li>特定硬件的支持：kAFL利用Intel PT特性是在Arm上不支持的</li>
<li>有足够高的特权操作内核：Syzkaller需要对内核进行重新编译来启动kcov和kasan功能</li>
</ul>
</li>
<li>Ex-vivo：一般是需要硬件模拟器，然而对于驱动的分析<ul>
<li>驱动是生来就依赖硬件的，这些相应的硬件在虚拟机中是不支持的<ul>
<li>尽管这些硬件是支持的，驱动在模拟器中也没有合适的环境</li>
</ul>
</li>
<li>驱动也在软件上依赖内核，但其实很多硬件特定的内核也没法在虚拟机里运行</li>
<li>为了在虚拟机里运行相应的驱动，需要将驱动移植到可以被模拟运行的内核中，但费时费力</li>
</ul>
</li>
</ul>
</li>
<li>Why this paper is accepted<ul>
<li>Usefulness<ul>
<li>可以设备外执行驱动程序的动态分析，不需设备移植，也不需真实的物理设备</li>
<li>发现了针对IOCTL的29个特权提升的漏洞，其中12个为零日漏洞</li>
</ul>
</li>
<li>Novelty<ul>
<li>观察驱动程序对硬件和软件的依赖是非常表面的，而且这些路径上是有漏洞的。<ul>
<li>例如具备读取设备寄存器的能力而不关心实际寄存器的值。</li>
<li>例如只需要特定的函数返回success代码，并不依赖这个函数的实际语义</li>
</ul>
</li>
<li>实现一种逃避依赖的方案，不需要真的被依赖的软件和硬件，就可以对驱动进行加载和初始化 </li>
<li>该技术允许AFL和Manticore（符号执行工具）等用户级的漏洞检测技术应用到对驱动程序的分析中</li>
</ul>
</li>
</ul>
</li>
<li>How it works<ul>
<li>Evasion kernel: 利用可以被虚拟化的内核（vexpress和virt）加载和初始化不被支持的内核相关联的驱动<ul>
<li>内核数据结构、全局变量、系统调用中使用的内核API数据结构和例如MIMO内存范围等资源、以及中断等都需要被初始化</li>
<li>为什么不直接重新编译驱动使其在能被虚拟化的内核中运行呢？<ul>
<li>因为驱动依赖主机内核特定的子系统、头文件和配置文件等</li>
</ul>
</li>
</ul>
</li>
<li>EASIER (Ex-vivo Analysis framework)：在用户空间对驱动进行fuzzing或符号执行<ul>
<li>利用Qemu模拟器，初始化驱动和内核，运行应用程序调用ioctl，在进入内核空间时提取内存快照，导出所有内存页和寄存器的值</li>
<li>利用CPU模拟器dUnicorn加载内存和恢复寄存器的值，从文件中读取传递给系统调用的参数，模拟执行系统调用直到返回用户空间</li>
</ul>
</li>
</ul>
</li>
<li>Implementation details for Evasion (需满足的条件)<ul>
<li>满足驱动对内核的软件依赖：三个stub替代依赖的内核函数，利用模块的导出函数表，查找内核代码中相应函数的签名，将签名信息插入到ELF文件的section中，后续被evasion内核子定义模块使用来确定具体需要哪一个stub函数<ul>
<li>stub0：返回0，替代所有返回值是int的函数，因为Linux经常用0表示成功，其他非零值为错误代码</li>
<li>stubP：开辟内存空间，用于替代返回值为指针的函数，这种情况下原函数一般是返回一个指向结构的指针</li>
<li>stub1：返回1，针对少数非零值才表示成功的函数</li>
</ul>
</li>
<li>隐藏驱动对硬件的硬件依赖<ul>
<li>重用device tree条目， 如果主机内核device tree文件<ul>
<li>可用，直接在evasion kernel中进行使用</li>
<li>不可用，或者没有搜索到对应的条目，evasion直接使用最常用的合理值生成一个条目</li>
</ul>
</li>
<li>忽略驱动与设备的通信<ul>
<li>重定向注册MIMO range的函数为kzalloc，读写操作被忽略</li>
<li>监听和替换15个kernel函数</li>
</ul>
</li>
</ul>
</li>
<li>确保内核和驱动之间传输数据结构的一致性<ul>
<li>结构体各字段要对齐，偏移量要一致</li>
<li>若主机内核代码不可访问，则对比二进制中字段的偏移量，插入填充使字段对齐</li>
<li>若主机内核代码可访问，直接尝试不同配置编译evasion，使最终各字段一致</li>
</ul>
</li>
</ul>
</li>
<li>Implementation details for EASIER (Ex-vivo Analysis framework)<ul>
<li>dUnicorn是一个CPU模拟器，仅模拟Arm指令集，不支持任何硬件，需要监听和重定位所有内核的函数<ul>
<li>没有MMU，替换所有kzalloc、krealloc和kfree为定制的内存分配器</li>
<li>监听进程调度函数，例如 _cond_resched，直接返回到用户空间</li>
<li>选择性关闭log函数，例如printk</li>
</ul>
</li>
<li>恢复IOCTL的结构体参数格式<ul>
<li>动态恢复ioctl所需的数据结构布局，监听copy_from_user，动态开辟所需的数据结构</li>
<li>所有用户空间和内核空间的数据交互都是用copy_from_user</li>
</ul>
</li>
<li>如何收集Coverage进行Fuzzing<ul>
<li>AFL-Unicorn，工作原理类似于Fuzz二进制的AFL-Qemu模式</li>
</ul>
</li>
<li>执行Symbolic Execution<ul>
<li>Manticore框架，符号化执行用户态ELF Binary</li>
<li>扩展其Manticore使其能从内存快照中获取执行状态</li>
<li>恢复IOCTL的command参数</li>
</ul>
</li>
</ul>
</li>
<li>Evalution<ul>
<li>表面依赖的假设是否成立？<ul>
<li>对于26个已知的程序漏洞，给定触发程序下，可以触发其中81%，说明该方案是有效的</li>
</ul>
</li>
<li>逃避技术是否能够加载和初始化驱动<ul>
<li>针对3个设备上的62个驱动，实现对其中77%的驱动的加载和初始化</li>
</ul>
</li>
<li>是否能利用Fuzzing找到真的IOCTL的漏洞，针对32个drivers<ul>
<li>fuzz过程发现29个漏洞，其中12个是零日漏洞</li>
</ul>
</li>
<li>Fuzzing的吞吐量<ul>
<li>1167 executions per second for MSM kernel drivers</li>
<li>525 executions per second for Xiaomi derivers</li>
<li>Whereas Charm only achieve 20 executions per second</li>
<li>No need to restart the device after reboot</li>
</ul>
</li>
</ul>
</li>
<li>Reflection <ul>
<li>这篇感觉是DiFUZE的后续工作，DIFUZE就是需要刷机才能支持Syzkaller的kcov功能，采用x86模拟了一些驱动来检测生成ioctl结构体信息的有效性，这里既然可以解决这个问题，说不定可以两者结合。</li>
</ul>
</li>
<li>How to improve this work</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/blog/tags/Kernel/" rel="tag"># Kernel</a>
              <a href="/blog/tags/Hardware-Boostup/" rel="tag"># Hardware Boostup</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/blog/2020/12/24/Difficultise-to-find-race-bugs-and-how-existing-work-solove-them/" rel="prev" title="Difficultise to find race bugs and how existing work solve them">
                  <i class="fa fa-angle-left"></i> Difficultise to find race bugs and how existing work solve them
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/blog/2020/12/27/Overview-of-Linux-kernel/" rel="next" title="Overview of Linux kernel">
                  Overview of Linux kernel <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Wei CHEN</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/blog/js/comments.js"></script><script src="/blog/js/utils.js"></script><script src="/blog/js/motion.js"></script><script src="/blog/js/next-boot.js"></script>

  






  





</body>
</html>
